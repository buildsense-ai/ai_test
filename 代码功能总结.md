# ğŸ¤– AIå¯¹è¯ä»£ç†è¯„ä¼°å¹³å° - ä»£ç åŠŸèƒ½æ€»ç»“ä¸å·¥ä½œæµç¨‹

## ğŸ“Š é¡¹ç›®æ¦‚è§ˆ
**é¡¹ç›®åç§°**: AIå¯¹è¯ä»£ç†è‡ªåŠ¨åŒ–è¯„ä¼°å¹³å°  
**ç‰ˆæœ¬**: v4.2.0  
**æŠ€æœ¯æ ˆ**: FastAPI + DeepSeek API + Coze API + Bootstrap + Jinja2 + MySQL  
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éªŒè¯å¯æ­£å¸¸éƒ¨ç½²è¿è¡Œ  
**æ ¸å¿ƒç‰¹æ€§**: çœŸå®åŠ¨æ€å¯¹è¯ç”Ÿæˆã€ç²¾å‡†ç”¨æˆ·ç”»åƒæå–ã€ç»“æ„åŒ–è¯„ä¼°åˆ†æ

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„ä¸æ ¸å¿ƒå·¥ä½œæµç¨‹

### æ•´ä½“æ¶æ„å›¾
```
å‰ç«¯ç•Œé¢ (templates/index.html)
    â†“ [ç”¨æˆ·äº¤äº’]
FastAPI åç«¯ (main.py)
    â†“ [è¯·æ±‚å¤„ç†]
APIé›†æˆå±‚ (DeepSeek + Coze) + æ•°æ®åº“å­˜å‚¨ (MySQL)
    â†“ [æ•°æ®å¤„ç†]
è¯„ä¼°æŠ¥å‘Šç”Ÿæˆ + æ•°æ®æŒä¹…åŒ–
```

### æ–‡ä»¶ç»“æ„
```
â”œâ”€â”€ main.py                      # æ ¸å¿ƒåç«¯é€»è¾‘ (3900+è¡Œï¼Œå®Œæ•´åŠ¨æ€å¯¹è¯)
â”œâ”€â”€ config.py                    # é…ç½®æ–‡ä»¶ (APIå¯†é’¥ + æ•°æ®åº“é…ç½®)
â”œâ”€â”€ database_schema.sql          # æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
â”œâ”€â”€ requirements.txt             # ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ templates/index.html         # å‰ç«¯ç•Œé¢ (1800+è¡Œï¼Œå¢å¼ºç•Œé¢)
â”œâ”€â”€ static/favicon.ico           # é™æ€èµ„æº
â”œâ”€â”€ AIè¯„ä¼°å¹³å°è°ƒè¯•æ—¥å¿—.md       # è¯¦ç»†è°ƒè¯•è®°å½•
â”œâ”€â”€ ä»£ç åŠŸèƒ½æ€»ç»“.md             # æœ¬æ–‡æ¡£ (å®Œæ•´å·¥ä½œæµç¨‹)
â””â”€â”€ README.md                    # é¡¹ç›®æ–‡æ¡£
```

---

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµç¨‹è¯¦è§£

### 1. ğŸ“‹ åŠ¨æ€å¯¹è¯è¯„ä¼°å®Œæ•´æµç¨‹

è¿™æ˜¯ç³»ç»Ÿæœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œå®ç°çœŸæ­£çš„åŠ¨æ€å¯¹è¯ç”Ÿæˆå’Œè¯„ä¼°ï¼š

#### **æ­¥éª¤ 1: ç”¨æˆ·ç”»åƒæå–**
```
ç”¨æˆ·ä¸Šä¼ éœ€æ±‚æ–‡æ¡£ 
    â†“
process_uploaded_document_improved() - æ–‡æ¡£è§£æ
    â†“
extract_user_persona_with_deepseek() - DeepSeekæ™ºèƒ½æå–
    â†“
æå–ç»“æœ: {
    user_persona: {è§’è‰²ã€ç»éªŒã€æ²Ÿé€šé£æ ¼ã€å·¥ä½œç¯å¢ƒ}
    usage_context: {ä½¿ç”¨åœºæ™¯ã€ä¸šåŠ¡é¢†åŸŸã€äº¤äº’ç›®æ ‡ã€ç—›ç‚¹}
    ai_role_simulation: {å¯¹è¯æ–¹å¼ã€è¯­è¨€ç‰¹å¾ã€å…¸å‹é—®é¢˜}
    extracted_requirements: {æ ¸å¿ƒåŠŸèƒ½ã€è´¨é‡æœŸæœ›ã€äº¤äº’åå¥½}
}
```

#### **æ­¥éª¤ 2: åŠ¨æ€åœºæ™¯ç”Ÿæˆ**
```
generate_dynamic_conversation_scenarios() 
    â†“
åŸºäºç”¨æˆ·ç”»åƒç”Ÿæˆ2ä¸ªçœŸå®åœºæ™¯:
- åœºæ™¯1: ä¸“ä¸šæŠ€æœ¯å’¨è¯¢ç±»
- åœºæ™¯2: æ“ä½œæŒ‡å¯¼é—®é¢˜ç±»
    â†“
æ¯ä¸ªåœºæ™¯åŒ…å«: {title, context, scenario_type}
```

#### **â­ æ­¥éª¤ 3: çœŸå®åŠ¨æ€å¯¹è¯æµç¨‹ (æ ¸å¿ƒä¿®æ­£)**

è¿™æ˜¯ç³»ç»Ÿçš„æœ€å…³é”®éƒ¨åˆ†ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æµç¨‹æ‰§è¡Œï¼š

```
ğŸ”„ TRUE DYNAMIC CONVERSATION FLOW:

ã€è½®æ¬¡ 1ã€‘
1. DeepSeek åŸºäºç”¨æˆ·ç”»åƒç”Ÿæˆåˆå§‹æ¶ˆæ¯
   generate_single_initial_message(scenario_info, user_persona_info)
   â†“ ç”ŸæˆåŸå§‹ç”¨æˆ·æ¶ˆæ¯
   
2. å‘é€RAWæ¶ˆæ¯åˆ°Coze (é‡è¦: ä¸æ·»åŠ ä»»ä½•å¢å¼º)
   message_to_send = current_user_message  # ç›´æ¥ä½¿ç”¨åŸå§‹æ¶ˆæ¯
   call_coze_with_strict_timeout(api_config, message_to_send)
   â†“ Cozeå“åº”
   
3. æå–Cozeå®é™…å›å¤å†…å®¹
   clean_ai_response(ai_response)
   â†“ æ¸…ç†åçš„AIå›å¤

ã€è½®æ¬¡ 2-Nã€‘
4. DeepSeekåˆ†æCozeå›å¤ï¼Œç”Ÿæˆä¸‹è½®ç”¨æˆ·æ¶ˆæ¯
   generate_next_message_based_on_response(
       scenario_info, user_persona_info, 
       conversation_history, coze_response
   )
   â†“ åˆ†æAIå›å¤è´¨é‡ï¼Œç”Ÿæˆè‡ªç„¶åç»­é—®é¢˜
   
5. é‡å¤æ­¥éª¤2-4ï¼Œç›´åˆ°å¯¹è¯è‡ªç„¶ç»“æŸæˆ–è¾¾åˆ°æœ€å¤§è½®æ¬¡

ã€å…³é”®åŸåˆ™ã€‘
âŒ é”™è¯¯åšæ³•: å‘é€å¢å¼ºæ¶ˆæ¯å¦‚ "[ä½œä¸ºå·¥ç¨‹å¸ˆï¼Œä¸“ä¸šæ²Ÿé€š] ç”¨æˆ·é—®é¢˜"
âœ… æ­£ç¡®åšæ³•: ç›´æ¥å‘é€DeepSeekç”Ÿæˆçš„åŸå§‹ç”¨æˆ·æ¶ˆæ¯
```

#### **æ­¥éª¤ 4: æ™ºèƒ½è¯„ä¼°åˆ†æ**
```
evaluate_conversation_with_deepseek()
    â†“
å¯¹æ¯ä¸ªç»´åº¦è¯¦ç»†è¯„ä¼°:
- fuzzy_understanding: æ¨¡ç³Šç†è§£ä¸è¿½é—®èƒ½åŠ› (1-100åˆ†)
- answer_correctness: å›ç­”å‡†ç¡®æ€§ä¸ä¸“ä¸šæ€§ (1-100åˆ†)  
- persona_alignment: ç”¨æˆ·åŒ¹é…åº¦ (1-100åˆ†)
- goal_alignment: ç›®æ ‡å¯¹é½åº¦ (1-100åˆ†)
    â†“
ç»“æ„åŒ–è¯„ä¼°ç»“æœ: {
    score: å…·ä½“åˆ†æ•°,
    detailed_analysis: è¯¦ç»†åˆ†æ,
    improvement_suggestions: æ”¹è¿›å»ºè®®,
    specific_quotes: å¯¹è¯å¼•ç”¨
}
```

#### **æ­¥éª¤ 5: ç»¼åˆæŠ¥å‘Šç”Ÿæˆ**
```
generate_final_comprehensive_report()
    â†“
ç”ŸæˆåŒ…å«:
- æ•´ä½“è¡¨ç°è¯„ä»· (åŸºäºæå–çš„ç”¨æˆ·è§’è‰²)
- ç”¨æˆ·ç”»åƒåŒ¹é…åº¦åˆ†æ
- ä¸šåŠ¡ç›®æ ‡è¾¾æˆåº¦è¯„ä¼°
- è·¨åœºæ™¯å¯¹æ¯”æ´å¯Ÿ
- é’ˆå¯¹æ€§æ”¹è¿›å»ºè®® (5-8æ¡)
```

### 2. ğŸ“Š ç”¨æˆ·ç”»åƒæå–å·¥ä½œæµç¨‹

#### **ä¸¤é˜¶æ®µæ™ºèƒ½æå–æœºåˆ¶**
```
ç¬¬ä¸€é˜¶æ®µ: é¢†åŸŸè¯†åˆ«
extract_business_domain_from_content() 
    â†“
è¯†åˆ«æ–‡æ¡£ç±»å‹: å»ºç­‘å·¥ç¨‹/é‡‘èæœåŠ¡/å®¢æˆ·æœåŠ¡/æŠ€æœ¯æ”¯æŒç­‰

ç¬¬äºŒé˜¶æ®µ: è§’è‰²åŒ¹é…  
extract_role_from_content() + adjust_role_for_domain_consistency()
    â†“
ç¡®ä¿è§’è‰²ä¸é¢†åŸŸä¸€è‡´æ€§:
- å»ºç­‘æ–‡æ¡£ â†’ ç°åœºç›‘ç†å·¥ç¨‹å¸ˆ âœ…
- å»ºç­‘æ–‡æ¡£ â†’ Pythonå·¥ç¨‹å¸ˆ âŒ (é˜²æ­¢é”™è¯¯)

è¾“å‡ºç»“æ„åŒ–ç”»åƒ:
{
    user_persona: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯,
    usage_context: ä½¿ç”¨åœºæ™¯ä¸Šä¸‹æ–‡,  
    ai_role_simulation: AIè§’è‰²æ¨¡æ‹Ÿå‚æ•°,
    extracted_requirements: æ ¸å¿ƒéœ€æ±‚
}
```

### 3. ğŸ”— APIé›†æˆå·¥ä½œæµç¨‹

#### **å¤šAPIæ”¯æŒæ¶æ„**
```
call_ai_agent_api() [ç»Ÿä¸€å…¥å£]
    â†“
è¯†åˆ«APIç±»å‹:
â”œâ”€â”€ Coze Agent API â†’ call_coze_agent_with_timeout()
â”œâ”€â”€ Coze Bot API â†’ call_coze_bot_with_timeout()  
â”œâ”€â”€ Dify API â†’ call_dify_api()
â””â”€â”€ è‡ªå®šä¹‰API â†’ call_generic_api_with_timeout()

æ¯ä¸ªAPIè°ƒç”¨éƒ½åŒ…å«:
- è¶…æ—¶æ§åˆ¶ (2åˆ†é’Ÿ)
- é‡è¯•æœºåˆ¶ (æœ€å¤š2æ¬¡)
- é”™è¯¯å¤„ç†å’Œé™çº§
- ä¼šè¯è¿ç»­æ€§ç®¡ç†
```

### 4. ğŸ’¾ æ•°æ®æŒä¹…åŒ–å·¥ä½œæµç¨‹

#### **å®Œæ•´å­˜å‚¨é“¾è·¯**
```
è¯„ä¼°å®Œæˆ
    â†“
save_evaluation_to_database() 
    â†“ 
äº‹åŠ¡æ€§ä¿å­˜åˆ°6å¼ å…³è”è¡¨:
â”œâ”€â”€ ai_evaluation_sessions (ä¼šè¯ä¸»è¡¨)
â”œâ”€â”€ ai_conversation_scenarios (åœºæ™¯è¡¨)
â”œâ”€â”€ ai_conversation_turns (å¯¹è¯è®°å½•)
â”œâ”€â”€ ai_evaluation_scores (è¯„åˆ†è¯¦æƒ…)  
â”œâ”€â”€ ai_evaluation_configs (é…ç½®è®°å½•)
â””â”€â”€ ai_report_downloads (ä¸‹è½½è®°å½•)
    â†“
è‡ªåŠ¨ç”Ÿæˆsession_idï¼Œæ”¯æŒå†å²æŸ¥è¯¢
```

---

## âš™ï¸ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯¦è§£

### 1. æ–‡æ¡£å¤„ç†æ¨¡å— âœ…
**æ”¯æŒæ ¼å¼ä¸å¤„ç†å‡½æ•°**:
```python
Wordæ–‡æ¡£ (.docx) â†’ read_docx_file()    # æ”¯æŒè¡¨æ ¼å’Œæ®µè½æå–
PDFæ–‡æ¡£ (.pdf) â†’ read_pdf_file()       # å¤šé¡µé¢æ–‡æœ¬æå–  
æ–‡æœ¬æ–‡ä»¶ (.txt) â†’ read_txt_file()      # UTF-8/GBKç¼–ç è‡ªåŠ¨è¯†åˆ«
```

**å¤„ç†ç‰¹ç‚¹**:
- ä¸´æ—¶æ–‡ä»¶å®‰å…¨å¤„ç† (è‡ªåŠ¨æ¸…ç†)
- å¤§æ–‡ä»¶æ”¯æŒ (åˆ†å—è¯»å–)
- é”™è¯¯å®¹é”™ (æ ¼å¼è¯†åˆ«å¤±è´¥æ—¶çš„é™çº§å¤„ç†)

### 2. åŠ¨æ€å¯¹è¯ç”Ÿæˆæ¨¡å— âœ…

#### **å…³é”®å‡½æ•°è¯´æ˜**:
```python
# åˆå§‹æ¶ˆæ¯ç”Ÿæˆ (åŸºäºç”»åƒå’Œåœºæ™¯)
async def generate_single_initial_message(scenario_info, user_persona_info):
    """
    è¾“å…¥: åœºæ™¯ä¿¡æ¯ + ç”¨æˆ·ç”»åƒ
    è¾“å‡º: ç¬¦åˆç”¨æˆ·èº«ä»½çš„è‡ªç„¶å¼€åœºé—®é¢˜
    ç¤ºä¾‹: "ç°åœºé’¢ç­‹éšè”½å·¥ç¨‹éªŒæ”¶æœ‰æŠ€æœ¯é—®é¢˜éœ€è¦ç¡®è®¤"
    """

# åŠ¨æ€åç»­æ¶ˆæ¯ç”Ÿæˆ (åŸºäºAIå®é™…å›å¤)  
async def generate_next_message_based_on_response(scenario_info, user_persona_info, conversation_history, coze_response):
    """
    è¾“å…¥: AIçš„å®é™…å›å¤å†…å®¹
    åˆ†æ: AIå›å¤è´¨é‡ã€å®Œæ•´åº¦ã€ä¸“ä¸šæ€§
    è¾“å‡º: è‡ªç„¶çš„åç»­é—®é¢˜æˆ–ç»“æŸä¿¡å·
    
    ç”Ÿæˆç­–ç•¥:
    - AIå›ç­”å®Œæ•´ â†’ "è°¢è°¢ï¼Œé—®é¢˜è§£å†³äº†" (ç»“æŸ)
    - AIå›ç­”æ¨¡ç³Š â†’ "èƒ½è¯¦ç»†è¯´æ˜ä¸€ä¸‹å…·ä½“æ“ä½œæ­¥éª¤å—ï¼Ÿ"
    - AIæä¾›è§„èŒƒ â†’ "å…·ä½“æ¡æ–‡å·æ˜¯ä»€ä¹ˆï¼Ÿ"
    - AIå›ç­”ç®€çŸ­ â†’ "è¿˜æœ‰å…¶ä»–éœ€è¦æ³¨æ„çš„å—ï¼Ÿ"
    """

# çœŸå®åŠ¨æ€å¯¹è¯æ§åˆ¶å™¨ (æ ¸å¿ƒå‡½æ•°)
async def conduct_true_dynamic_conversation(api_config, scenario_info, user_persona_info):
    """
    â­ æ ¸å¿ƒæµç¨‹æ§åˆ¶å‡½æ•°
    
    å®ç°æµç¨‹:
    1. DeepSeekç”Ÿæˆåˆå§‹æ¶ˆæ¯ (åŸºäºç”»åƒ)
    2. å‘é€åŸå§‹æ¶ˆæ¯åˆ°Coze (æ— å¢å¼º)
    3. æå–Cozeå®é™…å›å¤
    4. DeepSeekåˆ†æå›å¤ç”Ÿæˆä¸‹è½®æ¶ˆæ¯  
    5. é‡å¤2-4ç›´åˆ°è‡ªç„¶ç»“æŸ
    
    å…³é”®ä¿®æ­£: æ°¸è¿œå‘é€åŸå§‹ç”¨æˆ·æ¶ˆæ¯ï¼Œä¸æ·»åŠ ç”»åƒå¢å¼º
    """
```

### 3. æ™ºèƒ½è¯„ä¼°æ¨¡å— âœ…

#### **è¯„ä¼°ç»´åº¦ä¸æ ‡å‡†**:
```python
è¯„ä¼°ç»´åº¦ (1-100åˆ†åˆ¶):

1. fuzzy_understanding (æ¨¡ç³Šç†è§£ä¸è¿½é—®èƒ½åŠ›)
   90-100åˆ†: ä¼˜ç§€ - å®Œå…¨ç†è§£æ¨¡ç³Šè¡¨è¾¾ï¼Œä¸»åŠ¨å¼•å¯¼æ¾„æ¸…
   80-89åˆ†: è‰¯å¥½ - åŸºæœ¬ç†è§£ï¼Œæœ‰ä¸€å®šå¼•å¯¼èƒ½åŠ›
   70-79åˆ†: ä¸­ç­‰ - éƒ¨åˆ†ç†è§£ï¼Œå¼•å¯¼ä¸å¤Ÿæ·±å…¥
   60-69åˆ†: åŠæ ¼ - ç†è§£æœ‰é™ï¼Œå¾ˆå°‘ä¸»åŠ¨è¿½é—®
   50-59åˆ†: ä¸åŠæ ¼ - æ— æ³•å¤„ç†æ¨¡ç³Šé—®é¢˜

2. answer_correctness (å›ç­”å‡†ç¡®æ€§ä¸ä¸“ä¸šæ€§)
   90-100åˆ†: å›ç­”å®Œå…¨å‡†ç¡®ï¼Œä¸“ä¸šæ€§å¼ºï¼Œæœ‰è§„èŒƒä¾æ®
   80-89åˆ†: åŸºæœ¬å‡†ç¡®ï¼Œæœ‰ä¸€å®šä¸“ä¸šæ€§
   70-79åˆ†: éƒ¨åˆ†å‡†ç¡®ï¼Œä¸“ä¸šæ€§ä¸€èˆ¬
   60-69åˆ†: å‡†ç¡®æ€§æœ‰é™ï¼Œä¸“ä¸šæ€§ä¸è¶³
   50-59åˆ†: å›ç­”ä¸å‡†ç¡®

3. persona_alignment (ç”¨æˆ·åŒ¹é…åº¦) 
   90-100åˆ†: å®Œå…¨åŒ¹é…ç”¨æˆ·ç”»åƒï¼Œæ²Ÿé€šé£æ ¼é«˜åº¦å¥‘åˆ
   80-89åˆ†: åŸºæœ¬åŒ¹é…ï¼Œæ²Ÿé€šè¾ƒä¸ºæ°å½“
   70-79åˆ†: éƒ¨åˆ†åŒ¹é…ï¼Œæ²Ÿé€šé£æ ¼ä¸€èˆ¬
   60-69åˆ†: åŒ¹é…åº¦æœ‰é™ï¼Œæ²Ÿé€šä¸å¤Ÿæ°å½“
   50-59åˆ†: ä¸åŒ¹é…ç”¨æˆ·ç”»åƒ

4. goal_alignment (ç›®æ ‡å¯¹é½åº¦)
   90-100åˆ†: å®Œå…¨ç†è§£å¹¶è¶…é¢„æœŸæ»¡è¶³ç”¨æˆ·ç›®æ ‡
   80-89åˆ†: åŸºæœ¬ç†è§£ç›®æ ‡ï¼Œæä¾›æœ‰æ•ˆå¸®åŠ©
   70-79åˆ†: éƒ¨åˆ†ç†è§£ç›®æ ‡ï¼Œå¸®åŠ©æœ‰é™
   60-69åˆ†: å¯¹ç›®æ ‡ç†è§£ä¸è¶³
   50-59åˆ†: ä¸ç†è§£ç”¨æˆ·ç›®æ ‡
```

#### **ç»“æ„åŒ–è¯„ä¼°è¾“å‡º**:
```python
detailed_explanations[dimension] = {
    "score": 85,                    # å…·ä½“åˆ†æ•°
    "score_out_of": 100,           # æ€»åˆ†åŸºå‡†
    "detailed_analysis": "...",     # è¯¦ç»†åˆ†æ
    "specific_quotes": "...",       # å¯¹è¯å¼•ç”¨
    "improvement_suggestions": "...", # æ”¹è¿›å»ºè®®
    "dimension_name": "å›ç­”å‡†ç¡®æ€§",  # ç»´åº¦åç§°
    "score_grade": "è‰¯å¥½"           # ç­‰çº§æ ‡ç­¾
}
```

### 4. ä¼šè¯è¿ç»­æ€§ç®¡ç† âœ…

#### **ConversationManagerç±»**:
```python
class ConversationManager:
    """
    ç®¡ç†å¯¹è¯çš„è¿ç»­æ€§å’Œä¸Šä¸‹æ–‡
    
    æ ¸å¿ƒåŠŸèƒ½:
    - è‡ªåŠ¨è¯†åˆ«APIç±»å‹ (Coze/Dify/Custom)
    - ç”Ÿæˆå’Œç»´æŠ¤conversation_id
    - è·¨è½®æ¬¡ä¸Šä¸‹æ–‡ä¿æŒ
    - ä¼šè¯çŠ¶æ€ç®¡ç†
    """
    
    def start_new_conversation(self) -> str:
        """å¼€å§‹æ–°å¯¹è¯ï¼Œç”Ÿæˆå”¯ä¸€conversation_id"""
        
    def get_conversation_id(self) -> str:
        """è·å–å½“å‰å¯¹è¯ID"""
        
    def update_conversation_id(self, new_id: str):
        """æ›´æ–°å¯¹è¯ID (ç”¨äºAPIè¿”å›çš„æ–°ID)"""
```

---

## ğŸŒ APIæ¥å£è®¾è®¡

### ä¸»è¦ç«¯ç‚¹è¯¦è§£
| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½æè¿° | æ ¸å¿ƒå·¥ä½œæµç¨‹ | çŠ¶æ€ |
|-----|------|----------|-------------|------|
| `/` | GET | ä¸»é¡µç•Œé¢ | è¿”å›index.htmlæ¨¡æ¿ | âœ… |
| `/api/extract-user-persona` | POST | ç”¨æˆ·ç”»åƒæå– | æ–‡æ¡£è§£æâ†’DeepSeekåˆ†æâ†’ç»“æ„åŒ–è¾“å‡º | âœ… |
| `/api/evaluate-agent-dynamic` | POST | åŠ¨æ€å¯¹è¯è¯„ä¼° | ç”»åƒæå–â†’åœºæ™¯ç”Ÿæˆâ†’åŠ¨æ€å¯¹è¯â†’æ™ºèƒ½è¯„ä¼° | âœ… |
| `/api/test-with-raw-coze-conversation` | POST | åŸå§‹å¯¹è¯æµ‹è¯• | Coze JSONè§£æâ†’æ¶ˆæ¯æå–â†’ç›´æ¥æµ‹è¯• | âœ… |
| `/api/validate-config` | POST | APIé…ç½®éªŒè¯ | è¿æ¥æµ‹è¯•â†’æƒé™æ£€æŸ¥â†’çŠ¶æ€åé¦ˆ | âœ… |
| `/api/download-report` | POST | æŠ¥å‘Šä¸‹è½½ | æ ¼å¼è½¬æ¢â†’æ–‡ä»¶ç”Ÿæˆâ†’ä¸‹è½½é“¾æ¥ | âœ… |

### å…³é”®æ•°æ®æ¨¡å‹
```python
# APIé…ç½®æ¨¡å‹ - æ”¯æŒå¤šç§AIæ¥å£
class APIConfig(BaseModel):
    type: str                    # "coze-agent"|"coze-bot"|"dify"|"custom"
    url: str                     # APIç«¯ç‚¹URL
    headers: Dict[str, str]      # è®¤è¯å¤´å’Œå…¶ä»–é…ç½®
    agentId: Optional[str]       # Coze Agent ID
    botId: Optional[str]         # Coze Bot ID
    timeout: int = 30            # è¶…æ—¶è®¾ç½®

# å¯¹è¯åœºæ™¯æ¨¡å‹
class ConversationScenario(BaseModel):
    title: str                   # åœºæ™¯æ ‡é¢˜
    context: str                 # ä¸šåŠ¡ä¸Šä¸‹æ–‡
    scenario_type: str           # åœºæ™¯ç±»å‹
    
# è¯„ä¼°è¯·æ±‚æ¨¡å‹  
class EvaluationRequest(BaseModel):
    agent_api: APIConfig         # è¢«æµ‹AIé…ç½®
    requirement_doc: str         # éœ€æ±‚æ–‡æ¡£å†…å®¹
    use_raw_messages: bool       # æ˜¯å¦ä½¿ç”¨åŸå§‹æ¶ˆæ¯
```

---

## ğŸ”§ é…ç½®ç®¡ç†ä¸éƒ¨ç½²

### ç¯å¢ƒé…ç½® (config.py)
```python
# DeepSeek APIé…ç½®
DEEPSEEK_API_KEY = "sk-xxx"
DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions"
DEEPSEEK_TIMEOUT = 30

# Coze APIé…ç½®  
COZE_API_KEY = "pat_xxx"
COZE_API_BASE_URL = "https://api.coze.com"
DEFAULT_COZE_BOT_ID = "7511993619423985674"

# æ•°æ®åº“é…ç½®
DATABASE_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'ai_evaluation', 
    'password': 'ai_eval_2024!',
    'database': 'ai_evaluation_db',
    'charset': 'utf8mb4'
}

# åŠŸèƒ½å¼€å…³
ENABLE_DATABASE_SAVE = True      # æ•°æ®åº“è‡ªåŠ¨ä¿å­˜
ENABLE_AUTO_SAVE = True          # è‡ªåŠ¨ä¿å­˜è¯„ä¼°ç»“æœ
DOCUMENT_PROCESSING_AVAILABLE = True  # æ–‡æ¡£å¤„ç†åŠŸèƒ½
```

### éƒ¨ç½²æ£€æŸ¥æ¸…å•
```bash
# 1. ä¾èµ–å®‰è£…æ£€æŸ¥
pip install -r requirements.txt    # åŒ…å«PyMySQL, python-docx, PyPDF2ç­‰

# 2. æ•°æ®åº“åˆå§‹åŒ–
mysql -u root -p < database_schema.sql

# 3. æœåŠ¡å¯åŠ¨éªŒè¯
python main.py                     # å¯åŠ¨FastAPIæœåŠ¡
curl http://localhost:8000/health   # å¥åº·æ£€æŸ¥

# 4. åŠŸèƒ½æµ‹è¯•
curl http://localhost:8000/         # ä¸»é¡µè®¿é—®æµ‹è¯•
curl http://localhost:8000/docs     # APIæ–‡æ¡£æµ‹è¯•
```

---

## ğŸ“ˆ v4.2.0 é‡å¤§ä¿®æ­£ä¸æ”¹è¿›

### ğŸ¯ å…³é”®é—®é¢˜ä¿®æ­£

#### 1. åŠ¨æ€å¯¹è¯æµç¨‹é”™è¯¯ä¿®æ­£ âœ…
**é—®é¢˜**: åŠ¨æ€å¯¹è¯ä¸­é”™è¯¯åœ°æ·»åŠ ç”»åƒå¢å¼ºï¼Œç ´åäº†çœŸå®ç”¨æˆ·æ¨¡æ‹Ÿ
**åŸæœ‰é”™è¯¯æµç¨‹**:
```python
# âŒ é”™è¯¯åšæ³•
enhanced_message = f"[ä½œä¸º{role}ï¼Œ{style}] {user_message}"
call_coze_api(enhanced_message)  # å‘é€å¢å¼ºæ¶ˆæ¯
```

**ä¿®æ­£åçš„æ­£ç¡®æµç¨‹**:
```python
# âœ… æ­£ç¡®åšæ³•  
raw_message = generate_single_initial_message(scenario, persona)
call_coze_api(raw_message)  # ç›´æ¥å‘é€åŸå§‹æ¶ˆæ¯
next_message = generate_next_message_based_on_response(coze_response)
```

**ä¿®æ­£å½±å“**:
- çœŸå®æ¨¡æ‹Ÿç”¨æˆ·å¯¹è¯è¡Œä¸º
- AIæ¥æ”¶åˆ°è‡ªç„¶çš„ç”¨æˆ·è¾“å…¥
- è¯„ä¼°ç»“æœæ›´å‡†ç¡®åæ˜ AIå®é™…èƒ½åŠ›

#### 2. æ¶ˆæ¯ç”Ÿæˆé€»è¾‘ä¼˜åŒ– âœ…
**DeepSeekæ¶ˆæ¯ç”Ÿæˆçš„åŒé‡ä½œç”¨**:
1. **åŸºäºç”»åƒç”Ÿæˆåˆå§‹æ¶ˆæ¯**: ä½“ç°ç”¨æˆ·è§’è‰²ç‰¹å¾
2. **åŸºäºAIå›å¤ç”Ÿæˆåç»­æ¶ˆæ¯**: åˆ†æAIè¡¨ç°ï¼Œè‡ªç„¶å»¶ç»­å¯¹è¯

**ç”Ÿæˆç­–ç•¥ä¼˜åŒ–**:
```python
# æ ¹æ®AIå›å¤è´¨é‡è°ƒæ•´ç”¨æˆ·ååº”
if "è§„èŒƒ" in ai_response and "å·¥ç¨‹å¸ˆ" in user_role:
    return "å…·ä½“æ¡æ–‡å·æ˜¯ä»€ä¹ˆï¼Ÿç°åœºæ“ä½œè¦æ³¨æ„å“ªäº›è¦ç‚¹ï¼Ÿ"
elif len(ai_response) < 100:  # å›å¤è¿‡çŸ­
    return "èƒ½è¯¦ç»†è¯´æ˜ä¸€ä¸‹å…·ä½“æ“ä½œæ­¥éª¤å—ï¼Ÿ"
elif "å¯ä»¥" in ai_response or "å»ºè®®" in ai_response:
    return "å¥½çš„ï¼Œè¿˜æœ‰å…¶ä»–éœ€è¦æ³¨æ„çš„å—ï¼Ÿ"
```

#### 3. è°ƒè¯•æ—¥å¿—å®Œå–„ âœ…
**æ–°å¢æµç¨‹è¿½è¸ªæ—¥å¿—**:
```
ğŸ” [TURN 1] DeepSeekç”Ÿæˆçš„åŸå§‹ç”¨æˆ·æ¶ˆæ¯: xxx
ğŸ” [RAW MESSAGE] å‘é€åŸå§‹æ¶ˆæ¯åˆ°Coze: xxx  
ğŸ¤– DeepSeekåˆ†æCozeå›å¤å†…å®¹: xxx
âœ… DeepSeekåŸºäºCozeå›å¤ç”Ÿæˆä¸‹è½®æ¶ˆæ¯: xxx
```

**æµç¨‹éªŒè¯æœºåˆ¶**:
- æ¯è½®å¯¹è¯è®°å½• `flow_type: "deepseek_to_raw_to_coze"`
- æ¶ˆæ¯ç±»å‹æ˜ç¡®æ ‡è¯† (åŸå§‹æ¶ˆæ¯ vs å¢å¼ºæ¶ˆæ¯)
- å¯¹è¯ç”Ÿæˆæ¥æºè¿½è¸ª (DeepSeek vs é¢„å®šä¹‰)

---

## ğŸš€ æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹

### 1. çœŸå®åŠ¨æ€å¯¹è¯ç”Ÿæˆ
- **æ™ºèƒ½åˆå§‹åŒ–**: åŸºäºç”¨æˆ·ç”»åƒç”Ÿæˆç¬¦åˆèº«ä»½çš„å¼€åœºé—®é¢˜
- **å®æ—¶å“åº”åˆ†æ**: DeepSeekå®æ—¶åˆ†æAIå›å¤è´¨é‡å’Œå®Œæ•´åº¦
- **è‡ªç„¶å¯¹è¯å»¶ç»­**: æ ¹æ®AIè¡¨ç°ç”Ÿæˆåˆç†çš„åç»­é—®é¢˜
- **æ™ºèƒ½ç»“æŸåˆ¤æ–­**: è‡ªåŠ¨è¯†åˆ«å¯¹è¯å®Œæˆæ—¶æœº

### 2. ç²¾å‡†ç”¨æˆ·ç”»åƒæå–  
- **ä¸¤é˜¶æ®µåˆ†æ**: å…ˆè¯†åˆ«ä¸šåŠ¡é¢†åŸŸï¼Œå†åŒ¹é…ç”¨æˆ·è§’è‰²
- **é¢†åŸŸä¸€è‡´æ€§æ ¡éªŒ**: é˜²æ­¢è·¨é¢†åŸŸè§’è‰²æ··æ·†
- **ç»“æ„åŒ–è¾“å‡º**: å››å¤§æ¨¡å—å®Œæ•´ç”¨æˆ·ç”»åƒ
- **å®¹é”™é™çº§æœºåˆ¶**: APIå¤±è´¥æ—¶çš„æ™ºèƒ½å›é€€

### 3. å¤šç»´åº¦æ™ºèƒ½è¯„ä¼°
- **æ ‡å‡†åŒ–è¯„åˆ†**: 100åˆ†åˆ¶è¯„åˆ†ä½“ç³»
- **ç»“æ„åŒ–åˆ†æ**: è¯¦ç»†åˆ†æ+å…·ä½“å¼•ç”¨+æ”¹è¿›å»ºè®®
- **ä¸ªæ€§åŒ–è¯„ä¼°**: åŸºäºç”¨æˆ·ç”»åƒçš„é’ˆå¯¹æ€§è¯„ä¼°
- **è·¨åœºæ™¯å¯¹æ¯”**: å¤šåœºæ™¯è¡¨ç°å·®å¼‚åˆ†æ

### 4. å®Œæ•´æ•°æ®ç®¡ç†
- **äº‹åŠ¡æ€§å­˜å‚¨**: 6å¼ å…³è”è¡¨å®Œæ•´è®°å½•è¯„ä¼°è¿‡ç¨‹
- **å†å²æŸ¥è¯¢**: æ”¯æŒæŒ‰session_idæŸ¥è¯¢å†å²è®°å½•
- **è‡ªåŠ¨æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- **æ€§èƒ½ä¼˜åŒ–**: å¤šç»´åº¦ç´¢å¼•æ”¯æŒ

---

## ğŸ”® ç³»ç»Ÿå¯æ‰©å±•æ€§è®¾è®¡

### APIé›†æˆæ‰©å±•
```python
# æ–°å¢AIæœåŠ¡æ”¯æŒåªéœ€å®ç°å¯¹åº”å‡½æ•°
async def call_new_ai_api(api_config, message):
    """æ–°AIæœåŠ¡é›†æˆæ¨¡æ¿"""
    # å®ç°å…·ä½“è°ƒç”¨é€»è¾‘
    pass

# åœ¨call_ai_agent_api()ä¸­æ·»åŠ åˆ†æ”¯
elif api_config.type == "new-ai-service":
    return await call_new_ai_api(api_config, message)
```

### è¯„ä¼°ç»´åº¦æ‰©å±•
```python
# æ–°å¢è¯„ä¼°ç»´åº¦åªéœ€åœ¨evaluation_promptsä¸­æ·»åŠ 
evaluation_prompts["new_dimension"] = f"""
è¯„ä¼°æç¤ºè¯æ¨¡æ¿...
è¯„åˆ†æ ‡å‡† (1-100åˆ†åˆ¶):
...
"""
```

### æ•°æ®åº“æ‰©å±•
```sql
-- æ–°å¢ä¸šåŠ¡è¡¨åªéœ€éµå¾ªå‘½åçº¦å®š
CREATE TABLE ai_new_feature (
    id INT PRIMARY KEY AUTO_INCREMENT,
    session_id VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES ai_evaluation_sessions(session_id)
);
```

---

## ğŸ“ å¼€å‘ç»´æŠ¤æŒ‡å—

### å…³é”®å‡½æ•°ä¿®æ”¹æ³¨æ„äº‹é¡¹

#### ğŸš¨ é«˜é£é™©å‡½æ•° (ä¿®æ”¹éœ€è°¨æ…)
```python
# åŠ¨æ€å¯¹è¯æ ¸å¿ƒæ§åˆ¶å™¨ - ä»»ä½•ä¿®æ”¹éƒ½å¯èƒ½ç ´åå¯¹è¯æµç¨‹
conduct_true_dynamic_conversation()

# æ¶ˆæ¯ç”Ÿæˆå‡½æ•° - å½±å“å¯¹è¯è‡ªç„¶åº¦å’Œè¿ç»­æ€§  
generate_single_initial_message()
generate_next_message_based_on_response()

# ç”¨æˆ·ç”»åƒæå– - å½±å“æ•´ä¸ªè¯„ä¼°çš„åŸºç¡€
extract_user_persona_with_deepseek()

# è¯„ä¼°åˆ†æ - å½±å“æœ€ç»ˆè¯„ä¼°è´¨é‡
evaluate_conversation_with_deepseek()
```

#### âœ… å®‰å…¨ä¿®æ”¹æŒ‡å—
1. **ä¿®æ”¹å‰**: å¿…é¡»ç†è§£å®Œæ•´å·¥ä½œæµç¨‹
2. **ä¿®æ”¹æ—¶**: ä¿æŒæ¥å£å…¼å®¹æ€§ï¼Œå¢åŠ å‘åå…¼å®¹
3. **ä¿®æ”¹å**: å®Œæ•´æµ‹è¯•æ•´ä¸ªè¯„ä¼°æµç¨‹
4. **æ—¥å¿—è®°å½•**: åœ¨å…³é”®èŠ‚ç‚¹æ·»åŠ è°ƒè¯•æ—¥å¿—

### å¸¸è§é—®é¢˜è¯Šæ–­

#### åŠ¨æ€å¯¹è¯é—®é¢˜
```python
# é—®é¢˜: å¯¹è¯ä¸è‡ªç„¶æˆ–é‡å¤
# æ£€æŸ¥: generate_next_message_based_on_response()ä¸­çš„åˆ†æé€»è¾‘
# è§£å†³: ä¼˜åŒ–AIå›å¤åˆ†æç­–ç•¥ï¼Œå¢åŠ å›å¤ç±»å‹åˆ¤æ–­

# é—®é¢˜: å¯¹è¯è¿‡æ—©ç»“æŸ
# æ£€æŸ¥: DeepSeekç”Ÿæˆçš„æ¶ˆæ¯æ˜¯å¦åŒ…å«ç»“æŸä¿¡å·
# è§£å†³: è°ƒæ•´temperatureå‚æ•°æˆ–ä¼˜åŒ–ç”Ÿæˆæç¤ºè¯
```

#### è¯„ä¼°åˆ†æé—®é¢˜  
```python
# é—®é¢˜: è¯„åˆ†è¿‡é«˜æˆ–è¿‡ä½
# æ£€æŸ¥: è¯„ä¼°æç¤ºè¯çš„è¯„åˆ†æ ‡å‡†æ˜¯å¦åˆç†
# è§£å†³: è°ƒæ•´è¯„åˆ†æ ‡å‡†ï¼Œå¢åŠ å…·ä½“è¯„ä¼°æ¡ˆä¾‹

# é—®é¢˜: è¯¦ç»†åˆ†æç¼ºå¤±
# æ£€æŸ¥: parse_evaluation_response_enhanced()è§£æé€»è¾‘
# è§£å†³: ä¼˜åŒ–å“åº”è§£æï¼Œå¢åŠ å®¹é”™å¤„ç†
```

---

## ğŸ æ€»ç»“

### âœ… ç³»ç»Ÿæ ¸å¿ƒä¼˜åŠ¿
1. **çœŸå®å¯¹è¯æ¨¡æ‹Ÿ**: å®ç°äº†å®Œæ•´çš„åŠ¨æ€å¯¹è¯ç”Ÿæˆå’Œå“åº”åˆ†æ
2. **ç²¾å‡†ç”»åƒæå–**: ä¸¤é˜¶æ®µåˆ†æç¡®ä¿ç”¨æˆ·ç”»åƒå‡†ç¡®æ€§
3. **æ™ºèƒ½è¯„ä¼°åˆ†æ**: 100åˆ†åˆ¶æ ‡å‡†åŒ–è¯„ä¼°ä½“ç³»
4. **å®Œæ•´æ•°æ®ç®¡ç†**: å…¨é“¾è·¯æ•°æ®æŒä¹…åŒ–å­˜å‚¨
5. **å¯æ‰©å±•æ¶æ„**: æ”¯æŒå¤šAIæœåŠ¡å’Œè¯„ä¼°ç»´åº¦æ‰©å±•

### ğŸš€ æŠ€æœ¯åˆ›æ–°ç‚¹
- **DeepSeekåŒé‡é©±åŠ¨**: ç”»åƒæå–+å¯¹è¯ç”Ÿæˆ+è¯„ä¼°åˆ†æ
- **åŸå§‹æ¶ˆæ¯ä¼ é€’**: ä¿è¯ç”¨æˆ·æ¨¡æ‹Ÿçš„çœŸå®æ€§
- **å®æ—¶å“åº”åˆ†æ**: åŸºäºAIå®é™…å›å¤çš„æ™ºèƒ½å¯¹è¯å»¶ç»­
- **ç»“æ„åŒ–è¯„ä¼°**: æ ‡å‡†åŒ–çš„è¯„ä¼°è¾“å‡ºæ ¼å¼

### ğŸ“Š å½“å‰çŠ¶æ€
**ç‰ˆæœ¬**: v4.2.0 - ç”Ÿäº§å°±ç»ª âœ…  
**æ ¸å¿ƒåŠŸèƒ½**: åŠ¨æ€å¯¹è¯æµç¨‹å·²å®Œå…¨ä¿®æ­£ âœ…  
**æ•°æ®ç®¡ç†**: å®Œæ•´çš„MySQLå­˜å‚¨ä½“ç³» âœ…  
**ç”¨æˆ·ç•Œé¢**: ç°ä»£åŒ–å“åº”å¼è®¾è®¡ âœ…  

### ğŸ”§ ç»´æŠ¤è¦ç‚¹
1. **æµç¨‹å®Œæ•´æ€§**: ä¸¥æ ¼æŒ‰ç…§åŠ¨æ€å¯¹è¯å·¥ä½œæµç¨‹æ‰§è¡Œ
2. **æ¶ˆæ¯çº¯å‡€æ€§**: ç¡®ä¿å‘é€ç»™AIçš„æ˜¯çº¯å‡€çš„ç”¨æˆ·æ¶ˆæ¯
3. **è¯„ä¼°æ ‡å‡†åŒ–**: ä¿æŒ100åˆ†åˆ¶è¯„ä¼°ä½“ç³»çš„ä¸€è‡´æ€§
4. **æ—¥å¿—è¿½è¸ª**: ç»´æŠ¤å®Œæ•´çš„è°ƒè¯•æ—¥å¿—è®°å½•

**ä¸‹ä¸€æ­¥**: æ ¹æ®å®é™…ä½¿ç”¨åé¦ˆè¿›è¡Œæ€§èƒ½ä¼˜åŒ–å’ŒåŠŸèƒ½å¢å¼º 