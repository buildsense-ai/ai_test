<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Agent Ëá™Âä®ÂåñËØÑ‰º∞Âπ≥Âè∞ v4.0</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --surface-color: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --compact-padding: 20px;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            line-height: 1.5;
        }

        .main-container {
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin: 20px auto;
            max-width: 1200px;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .header h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 2rem;
        }

        .header .lead {
            color: #6b7280;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        /* Collapsible Card System */
        .collapsible-card {
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 1.1rem;
        }

        .collapsible-toggle {
            color: #6b7280;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .collapsible-toggle.rotated {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: var(--compact-padding);
            transition: all 0.3s ease;
        }

        .collapsible-content.collapsed {
            display: none;
        }

        .collapsible-toggle.rotated {
            transform: rotate(180deg);
        }

        /* Compact Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .info-card:hover {
            border-color: var(--info-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .info-card.active {
            border-color: var(--info-color);
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .info-card i {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--info-color);
        }

        .info-card h6 {
            font-weight: 600;
            margin-bottom: 5px;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .info-card small {
            color: #6b7280;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* Compact Form Sections */
        .config-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .config-section h6 {
            color: #374151;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Compact Forms */
        .compact-form .row {
            margin-bottom: 12px;
        }

        /* Tricky Test Mode Styling */
        .tricky-test-active {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            border-color: #f59e0b !important;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3) !important;
        }

        .tricky-test-active .form-check-label strong {
            color: #d97706 !important;
        }

        .tricky-test-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .compact-form .form-control,
        .compact-form .form-select {
            padding: 8px 12px;
            font-size: 0.9rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .compact-form .form-control:focus,
        .compact-form .form-select:focus {
            border-color: var(--info-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .compact-form .form-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        /* Compact Alerts */
        .alert-compact {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            border: none;
        }

        .alert-info-compact {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: #1e40af;
            border-left: 3px solid var(--info-color);
        }

        .alert-success-compact {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #065f46;
            border-left: 3px solid var(--success-color);
        }

        .alert-warning-compact {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #92400e;
            border-left: 3px solid var(--warning-color);
        }

        /* Mode Selection - Inline */
        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .mode-option {
            flex: 1;
            min-width: 200px;
        }

        .mode-option .form-check {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-option .form-check:hover {
            border-color: var(--info-color);
            background: #eff6ff;
        }

        .mode-option .form-check-input:checked~.form-check-label {
            color: var(--info-color);
        }

        /* Compact File Upload */
        .file-upload-compact {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .file-upload-compact:hover {
            border-color: var(--info-color);
            background: #eff6ff;
        }

        .file-upload-compact i {
            font-size: 1.5rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .file-upload-compact h6 {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .file-upload-compact p {
            font-size: 0.8rem;
            margin-bottom: 0;
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #334155;
        }

        /* Results Section - Compact */
        .results-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }

        .dimension-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
        }

        .dimension-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .overall-score {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .star-rating {
            color: #fbbf24;
            font-size: 1.1rem;
            margin: 10px 0;
            letter-spacing: 1px;
        }

        /* Conversation Display - Collapsible */
        .conversation-section {
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        .conversation-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .conversation-header:hover {
            background: #f1f5f9;
        }

        .conversation-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .conversation-turn {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--info-color);
            font-size: 0.85rem;
        }

        .user-message {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left-color: var(--info-color);
        }

        .ai-response {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left-color: var(--success-color);
        }

        /* Enhanced Analysis Styles */
        .detailed-analysis-panel {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 8px;
        }

        .analysis-content,
        .quotes-content,
        .suggestions-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .quotes-content {
            font-style: italic;
            border-left: 3px solid #17a2b8;
            padding-left: 10px;
        }

        .stat-card {
            transition: transform 0.2s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .summary-overview .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .conversation-turn {
            transition: all 0.2s;
            border-radius: 8px;
        }

        .conversation-turn:hover {
            background-color: #f8f9fa;
            padding: 15px;
        }

        .message-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Enhanced explanation chain styles */
        .explanation-chain {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }

        .explanation-section {
            margin-bottom: 15px;
        }

        .explanation-content {
            padding: 10px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 6px;
        }

        .quotes-content {
            font-style: italic;
            background: rgba(34, 197, 94, 0.05);
        }

        .suggestions-content {
            padding: 10px;
            background: rgba(245, 158, 11, 0.05);
            border-radius: 6px;
        }

        /* JSON section styles */
        .collapsible-card pre {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .collapsible-card code {
            color: #374151;
        }

        /* Enhanced JSON display styles */
        .json-organized {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }

        .json-scenario {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .json-subsection {
            background: #f1f5f9;
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .conversation-json-turn {
            font-size: 0.9rem;
            border-left: 3px solid #3b82f6;
            padding-left: 8px;
            margin-bottom: 8px;
        }

        /* Fine-grained scoring visual indicators */
        .badge.bg-success {
            background-color: #10b981 !important;
        }

        .badge.bg-warning {
            background-color: #f59e0b !important;
        }

        .badge.bg-danger {
            background-color: #ef4444 !important;
        }

        .badge.bg-secondary {
            background-color: #6b7280 !important;
        }

        /* Star rating improvements for fine-grained scoring */
        .star-rating {
            font-size: 1.1rem;
            color: #fbbf24;
            letter-spacing: 1px;
        }

        /* Complete Report Specific Styles */
        .complete-report-container {
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .conversation-record-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .conversation-turn-complete {
            transition: all 0.3s ease;
        }

        .conversation-turn-complete:hover {
            background-color: #f8f9fa !important;
            border-color: #007bff !important;
        }

        .dimension-analysis-card {
            transition: all 0.3s ease;
        }

        .dimension-analysis-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .full-response-content pre {
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .scenario-score-overview .progress {
            height: 6px;
        }

        .turn-header .badge {
            font-size: 0.75rem;
        }

        /* Enhanced collapsible styles */
        .collapsible-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .stat-number {
                font-size: 1.5rem;
            }

            .collapsible-title {
                font-size: 1rem;
            }

            .dimension-analysis-card .row {
                margin: 0;
            }

            .dimension-analysis-card .col-md-6 {
                padding-left: 5px;
                padding-right: 5px;
            }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 300px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .spinner-custom {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--info-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 20px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .mode-selector {
                flex-direction: column;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-brain"></i> AI Agent Ëá™Âä®ÂåñËØÑ‰º∞Âπ≥Âè∞</h1>
                <p class="lead">Âü∫‰∫éDeepSeekÊô∫ËÉΩÂºïÊìéÁöÑ‰∏ì‰∏öAI‰ª£ÁêÜËØÑ‰º∞Á≥ªÁªü</p>
                <p class="subtitle">ÊîØÊåÅÂ§öÂπ≥Âè∞API ‚Ä¢ ÊñáÊ°£Êô∫ËÉΩËß£Êûê ‚Ä¢ Âä®ÊÄÅÂú∫ÊôØÁîüÊàê ‚Ä¢ 6Áª¥Â∫¶ËØÑ‰º∞Ê°ÜÊû∂ ‚Ä¢ 4ËΩÆÊ∑±Â∫¶ÂØπËØù</p>
            </div>

            <!-- Project Scenario Selection - New Feature -->
            <div class="collapsible-card">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <i class="fas fa-project-diagram"></i>
                        È°πÁõÆÂú∫ÊôØÈÄâÊã©
                    </div>
                    <i class="fas fa-chevron-down collapsible-toggle"></i>
                </div>
                <div class="collapsible-content">
                    <div class="alert-success-compact">
                        <i class="fas fa-star"></i> <strong>Êé®ËçêÔºö</strong>ÈÄâÊã©"ËßÑËåÉÊü•ËØ¢"Ëé∑ÂæóÈíàÂØπÂ∑•Á®ãÁõëÁêÜÁöÑ‰∏ì‰∏öËØÑ‰º∞‰ΩìÈ™å
                    </div>
                    <div class="info-grid">
                        <div class="info-card active" data-scenario="specification-query"
                            onclick="selectProjectScenario(event)">
                            <i class="fas fa-book"></i>
                            <h6>ËßÑËåÉÊü•ËØ¢</h6>
                            <small>Â∑•Á®ãËßÑËåÉ‰∏éÂõæÁ∫∏Êü•ËØ¢</small>
                        </div>
                        <div class="info-card" data-scenario="custom" onclick="selectProjectScenario(event)">
                            <i class="fas fa-upload"></i>
                            <h6>Ëá™ÂÆö‰πâÈ°πÁõÆ</h6>
                            <small>‰∏ä‰º†ÈúÄÊ±ÇÊñáÊ°£ËØÑ‰º∞</small>
                        </div>
                    </div>

                    <!-- Specification Query Info Panel -->
                    <div id="specificationQueryInfo" class="alert-info-compact mt-3">
                        <h6><i class="fas fa-user-tie"></i> ËßÑËåÉÊü•ËØ¢È°πÁõÆÈÖçÁΩÆ</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Áî®Êà∑ÁîªÂÉèÔºö</strong><br>
                                <span class="badge bg-primary">Â∑•Á®ãÈ°πÁõÆÁé∞Âú∫ÁõëÁêÜÂ∑•Á®ãÂ∏à</span>
                            </div>
                            <div class="col-md-4">
                                <strong>‰ΩøÁî®‰∏ä‰∏ãÊñáÔºö</strong><br>
                                <span class="badge bg-info">Â∑°Ê£ÄÈ™åÊî∂Êó∂ËßÑËåÉÊü•ËØ¢</span>
                            </div>
                            <div class="col-md-4">
                                <strong>ÁõÆÊ†áÔºö</strong><br>
                                <span class="badge bg-success">Âø´ÈÄüÂáÜÁ°ÆËé∑ÂèñËßÑËåÉ‰ø°ÊÅØ</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>ËØÑ‰º∞Áª¥Â∫¶ (6È°π)Ôºö</strong>
                            <span class="badge bg-secondary" title="ËØÑ‰º∞AIÂõûÁ≠îÁöÑ‰∏ì‰∏öÊÄßÂíåÂáÜÁ°ÆÂ∫¶ÔºåÂåÖÊã¨ÂÅáËßÑËåÉÊ£ÄÊµã">ÂõûÁ≠îÂáÜÁ°ÆÊÄß</span>
                            <span class="badge bg-secondary" title="ËØÑ‰º∞AIÊòØÂê¶ÂåπÈÖçÁî®Êà∑ËßíËâ≤ÂíåÊ≤üÈÄöÈ£éÊ†º">Áî®Êà∑ÂåπÈÖçÂ∫¶</span>
                            <span class="badge bg-secondary" title="ËØÑ‰º∞AIÊòØÂê¶ËææÊàêÁî®Êà∑ÁöÑÈ¢ÑÊúüÁõÆÊ†á">ÁõÆÊ†áÂØπÈΩêÂ∫¶</span>
                            <span class="badge bg-warning" title="ËØÑ‰º∞AIÂºïÁî®Âª∫Á≠ëËßÑËåÉÁöÑÂáÜÁ°ÆÊÄßÂíåÂêàËßÑÊÄß">ËßÑËåÉÂºïÁî®ÂáÜÁ°ÆÊÄß</span>
                            <span class="badge bg-warning" title="ËØÑ‰º∞AIÂ§ÑÁêÜÊ®°Á≥äÈóÆÈ¢òÂíåÂºïÂØºÁî®Êà∑ÊæÑÊ∏ÖÁöÑËÉΩÂäõ">Ê®°Á≥äÁêÜËß£ËÉΩÂäõ</span>
                            <span class="badge bg-warning" title="ËØÑ‰º∞AIÂú®Â§öËΩÆÂØπËØù‰∏≠ÁöÑËøûË¥ØÊÄßÂíå‰∏ä‰∏ãÊñáËÆ∞ÂøÜ">Â§öËΩÆÊîØÊåÅÂ∫¶</span>
                        </div>
                    </div>

                    <!-- Custom Project Info Panel -->
                    <div id="customProjectInfo" class="alert-info-compact mt-3" style="display: none;">
                        <h6><i class="fas fa-upload"></i> Ëá™ÂÆö‰πâÈ°πÁõÆÈÖçÁΩÆ</h6>
                        <p>‰∏ä‰º†ÊÇ®ÁöÑÈúÄÊ±ÇÊñáÊ°£ÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®ÊèêÂèñÁî®Êà∑ÁîªÂÉè„ÄÅ‰ΩøÁî®‰∏ä‰∏ãÊñáÂíåËØÑ‰º∞ÁõÆÊ†áÔºåÁîüÊàê‰∏ìÂ±ûÁöÑÊµãËØïÂú∫ÊôØ„ÄÇ</p>
                    </div>
                </div>
            </div>

            <!-- AI Type Selection - Collapsible -->
            <div class="collapsible-card">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <i class="fas fa-lightbulb"></i>
                        AIÁ≥ªÁªü‰ø°ÊÅØÊåáÂçó
                    </div>
                    <i class="fas fa-chevron-down collapsible-toggle"></i>
                </div>
                <div class="collapsible-content">
                    <div class="info-grid">
                        <div class="info-card" data-type="coze-agent" onclick="selectAIType(event)">
                            <i class="fas fa-robot"></i>
                            <h6>Coze AI Agent</h6>
                            <small>Êô∫ËÉΩ‰ª£ÁêÜÔºåÊîØÊåÅÂ∑•ÂÖ∑Ë∞ÉÁî®</small>
                        </div>
                        <div class="info-card" data-type="coze-bot" onclick="selectAIType(event)">
                            <i class="fas fa-comments"></i>
                            <h6>Coze Bot</h6>
                            <small>‰º†ÁªüËÅäÂ§©Êú∫Âô®‰∫∫</small>
                        </div>
                        <div class="info-card" data-type="custom-api" onclick="selectAIType(event)">
                            <i class="fas fa-code"></i>
                            <h6>Ëá™ÂÆö‰πâ API</h6>
                            <small>ÂÖ∂‰ªñAIÊúçÂä°</small>
                        </div>
                    </div>
                    <div class="alert-info-compact">
                        <strong><i class="fas fa-comment-dots"></i> Ê≤üÈÄöËØùÊúØÔºö</strong>
                        "ÊàëÈúÄË¶ÅÊµãËØï‰Ω†‰ª¨ÁöÑAIÁ≥ªÁªüÊÄßËÉΩÔºåËÉΩÊèê‰æõ‰∏Ä‰∏ãÁõ∏ÂÖ≥ÁöÑÈÖçÁΩÆ‰ø°ÊÅØÂêóÔºü"
                    </div>
                </div>
            </div>

            <!-- Main Form -->
            <form id="evaluationForm" enctype="multipart/form-data" class="compact-form">

                <!-- AI Configuration - Collapsible -->
                <div class="collapsible-card">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title">
                            <i class="fas fa-cog"></i>
                            AIÁ≥ªÁªüÈÖçÁΩÆ
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <!-- Coze Agent Config -->
                        <div id="cozeAgentConfig" class="config-section">
                            <h6><i class="fas fa-robot"></i> Coze Agent ÈÖçÁΩÆ</h6>
                            <div class="alert-info-compact">
                                <i class="fas fa-info-circle"></i> Á°Æ‰øùAgentÂ∑≤ÂèëÂ∏É‰∏îÂ§Ñ‰∫éÊ¥ªË∑ÉÁä∂ÊÄÅ
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="cozeAgentId" class="form-label">Agent ID *</label>
                                    <input type="text" class="form-control" id="cozeAgentId" name="cozeAgentId"
                                        value="7498244859505999924" placeholder="AgentÂîØ‰∏ÄÊ†áËØÜ">
                                </div>
                                <div class="col-md-6">
                                    <label for="cozeAgentToken" class="form-label">Access Token *</label>
                                    <input type="password" class="form-control" id="cozeAgentToken"
                                        name="cozeAgentToken"
                                        value="pat_DiraOZEjagK8c6NNPJKionQsCj99zZduVyGkYO8YojolSQ8WAjBdF2CgbXNLMaFi"
                                        placeholder="APIËÆøÈóÆ‰ª§Áâå">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="cozeRegion" class="form-label">Âπ≥Âè∞ÁâàÊú¨</label>
                                    <select class="form-select" id="cozeRegion" name="cozeRegion">
                                        <option value="global">Global (coze.com)</option>
                                        <option value="china" selected>China (coze.cn)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Coze Bot Config -->
                        <div id="cozeBotConfig" class="config-section" style="display: none;">
                            <h6><i class="fas fa-comments"></i> Coze Bot ÈÖçÁΩÆ</h6>
                            <div class="alert-success-compact">
                                <i class="fas fa-check-circle"></i> Â∑≤È¢ÑÈÖçÁΩÆÂ∑•Á®ãËßÑËåÉAIÂä©Êâã
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="cozeBotIdNew" class="form-label">Bot ID *</label>
                                    <input type="text" class="form-control" id="cozeBotIdNew" name="cozeBotIdNew"
                                        value="7511993619423985674" placeholder="BotÂîØ‰∏ÄÊ†áËØÜ">
                                </div>
                                <div class="col-md-4">
                                    <label for="cozeBotVersion" class="form-label">BotÁâàÊú¨ (ÂèØÈÄâ)</label>
                                    <input type="text" class="form-control" id="cozeBotVersion" name="cozeBotVersion"
                                        placeholder="latest">
                                </div>
                            </div>
                        </div>

                        <!-- Custom API Config -->
                        <div id="customApiConfig" class="config-section" style="display: none;">
                            <h6><i class="fas fa-code"></i> Ëá™ÂÆö‰πâ API ÈÖçÁΩÆ</h6>
                            <div class="alert-warning-compact">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>ÈáçË¶ÅÔºö</strong>ËØ∑ÂàÜÂà´Â°´ÂÜôÂêÑ‰∏™Â≠óÊÆµÔºå‰∏çË¶ÅÂú®"ËØ∑Ê±ÇÂ§¥"‰∏≠Á≤òË¥¥ÂÆåÊï¥ÈÖçÁΩÆÔºÅ
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="apiUrl" class="form-label">API URL *</label>
                                    <input type="url" class="form-control" id="apiUrl" name="apiUrl"
                                        placeholder="https://api.example.com/chat">
                                    <small class="text-muted">Á§∫‰æã: https://api.openai.com/v1/chat/completions</small>
                                </div>
                                <div class="col-md-4">
                                    <label for="apiMethod" class="form-label">HTTPÊñπÊ≥ï</label>
                                    <select class="form-select" id="apiMethod" name="apiMethod">
                                        <option value="POST" selected>POST</option>
                                        <option value="GET">GET</option>
                                        <option value="PUT">PUT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <label for="apiHeaders" class="form-label">ËØ∑Ê±ÇÂ§¥ (JSONÊ†ºÂºè)</label>
                                    <textarea class="form-control" id="apiHeaders" name="apiHeaders" rows="2"
                                        placeholder='{"Authorization": "Bearer your-token"}'></textarea>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Ê≥®ÊÑèÔºö</strong>‰ªÖÂ°´ÂÜôËØ∑Ê±ÇÂ§¥‰ø°ÊÅØÔºåÂ¶ÇËÆ§ËØÅtokenÁ≠â„ÄÇ‰∏çË¶ÅÁ≤òË¥¥ÂÆåÊï¥ÁöÑAPIÈÖçÁΩÆÔºÅ
                                        <br>Ê≠£Á°ÆÁ§∫‰æã: {"Authorization": "Bearer sk-...", "X-API-Key": "your-key"}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Requirement Document -->
                <div class="section-card">
                    <h5 class="section-title">
                        <i class="fas fa-user-tie"></i>
                        Áî®Êà∑ÁîªÂÉè‰∏éÈúÄÊ±ÇÊñáÊ°£ÈÖçÁΩÆ
                    </h5>

                    <!-- Specification Query Mode (Default) -->
                    <div id="specificationQueryMode">
                        <div class="alert-success-compact mb-4">
                            <i class="fas fa-check-circle"></i> <strong>ËßÑËåÉÊü•ËØ¢È°πÁõÆÔºö</strong>‰ΩøÁî®È¢ÑËÆæÁöÑÂ∑•Á®ãÁõëÁêÜÁîªÂÉèÂíåÂú∫ÊôØÔºå‰∏ìÊ≥®‰∫éËßÑËåÉÊü•ËØ¢Âú∫ÊôØÁöÑ6Áª¥Â∫¶‰∏ì‰∏öËØÑ‰º∞
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="config-section">
                                    <h6><i class="fas fa-cogs"></i> ËØÑ‰º∞ÈÖçÁΩÆ</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="enableTurnControl" checked>
                                        <label class="form-check-label" for="enableTurnControl">
                                            <strong>ÂêØÁî®ÂØπËØùËΩÆÊéßÂà∂</strong><br>
                                            <small>ÊúÄÂ§ö4ËΩÆÂØπËØùÔºåËá™Âä®Ê£ÄÊµãÊª°ÊÑèÂ∫¶Âπ∂ÁªìÊùü</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableTrickyTest"
                                            onchange="handleTrickyTestToggle('enableTrickyTest')">
                                        <label class="form-check-label" for="enableTrickyTest">
                                            <strong>üéØ ÂêØÁî®ÂàÅÈíªÊµãËØïÊ®°Âºè</strong><br>
                                            <small>ÁîüÊàêÊûÅÁ´ØÂú∫ÊôØÁöÑËæπÁºòÊ°à‰æãÈóÆÈ¢òÔºåÊµãËØïAIÁü•ËØÜËæπÁïå</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="config-section">
                                    <h6><i class="fas fa-chart-bar"></i> ËØÑ‰º∞Áª¥Â∫¶</h6>
                                    <small>
                                        ‚úÖ Âü∫Á°Ä3Áª¥Â∫¶ÔºöÂõûÁ≠îÂáÜÁ°ÆÊÄß„ÄÅÁî®Êà∑ÂåπÈÖçÂ∫¶„ÄÅÁõÆÊ†áÂØπÈΩêÂ∫¶<br>
                                        ‚úÖ ‰∏ìÈ°π3Áª¥Â∫¶ÔºöËßÑËåÉÂºïÁî®ÂáÜÁ°ÆÊÄß„ÄÅÊ®°Á≥äÁêÜËß£ËÉΩÂäõ„ÄÅÂ§öËΩÆÊîØÊåÅÂ∫¶<br>
                                        <span class="text-info">üí° Ê®°Á≥äÁêÜËß£ËÉΩÂäõÔºöËØÑ‰º∞AIÂ§ÑÁêÜ‰∏çÊ∏ÖÊô∞ÈóÆÈ¢òÂíåÂºïÂØºÁî®Êà∑ÊæÑÊ∏ÖÁöÑËÉΩÂäõ</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Project Mode -->
                    <div id="customProjectMode" style="display: none;">
                        <!-- Mode Selection -->
                        <div class="mb-4">
                            <h6 class="mb-3">
                                <i class="fas fa-cogs"></i>
                                ÈÄâÊã©ÈÖçÁΩÆÊñπÂºè
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="evaluationMode"
                                            id="dynamicMode" value="dynamic" checked>
                                        <label class="form-check-label" for="dynamicMode">
                                            <strong>üó£Ô∏è Âä®ÊÄÅÂØπËØù</strong><br>
                                            <small>ÁúüÂÆûÂØπËØùÊµÅÁ®ã (Êé®Ëçê)</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="evaluationMode"
                                            id="manualMode" value="manual">
                                        <label class="form-check-label" for="manualMode">
                                            <strong>‚úã ÊâãÂä®ÈÖçÁΩÆ</strong><br>
                                            <small>Ëá™ÂÆö‰πâÂú∫ÊôØ</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Mode Section -->
                        <div id="dynamicModeSection">
                            <div class="alert-success-compact">
                                <i class="fas fa-comments"></i> ‰∏ä‰º†ÈúÄÊ±ÇÊñáÊ°£ÔºåËá™Âä®ÊèêÂèñÁî®Êà∑ÁîªÂÉèÔºåÈÄöËøáDeepSeek APIÁîüÊàê‰∏ìÂ±ûÊµãËØïÂú∫ÊôØÔºåËøõË°å4ËΩÆÊ∑±Â∫¶ÂØπËØùËØÑ‰º∞
                            </div>

                            <!-- Dynamic Evaluation Configuration -->
                            <div class="config-section">
                                <h6><i class="fas fa-cogs"></i> Âä®ÊÄÅËØÑ‰º∞ÈÖçÁΩÆ</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableTrickyTestDynamic"
                                        onchange="handleTrickyTestToggle('enableTrickyTestDynamic')">
                                    <label class="form-check-label" for="enableTrickyTestDynamic">
                                        <strong>üéØ ÂêØÁî®ÂàÅÈíªÊµãËØïÊ®°Âºè</strong><br>
                                        <small>ÁîüÊàêÂçóÊûÅÂª∫ËÆæ„ÄÅÂéÜÂè≤Âª∫Á≠ëÁ≠âÊûÅÁ´ØÂú∫ÊôØÈóÆÈ¢òÔºåÊåëÊàòAIÁü•ËØÜËæπÁïå</small>
                                    </label>
                                </div>
                            </div>

                            <!-- File Upload -->
                            <div class="file-upload-compact"
                                onclick="document.getElementById('dynamicRequirementFile').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h6>ÁÇπÂáª‰∏ä‰º†ÈúÄÊ±ÇÊñáÊ°£</h6>
                                <p class="text-muted">ÊîØÊåÅ Word (.docx) ‚Ä¢ PDF (.pdf) ‚Ä¢ ÊñáÊú¨ (.txt)</p>
                                <input type="file" class="d-none" id="dynamicRequirementFile"
                                    name="dynamicRequirementFile" accept=".doc,.docx,.pdf,.txt"
                                    onchange="handleDynamicFileUpload(this)">
                            </div>

                            <div id="dynamicFileUploadStatus" style="display: none;" class="alert-success-compact">
                                <i class="fas fa-file-check"></i> <span id="dynamicUploadedFileName"></span> Â∑≤ÊàêÂäü‰∏ä‰º†
                            </div>

                            <!-- Text Input Alternative -->
                            <div>
                                <label for="dynamicRequirementDoc" class="form-label">ÊàñÁõ¥Êé•ËæìÂÖ•ÈúÄÊ±ÇÊñáÊ°£ÂÜÖÂÆπ</label>
                                <textarea class="form-control" id="dynamicRequirementDoc" name="dynamicRequirementDoc"
                                    rows="3" placeholder="‰æãÔºöÁõëÁêÜÂ∑•Á®ãÂ∏àÈúÄË¶ÅAIËØÜÂà´Áî®Êà∑Ê®°Á≥äÊèèËø∞Âπ∂‰∏ªÂä®ÂºïÂØºË°•ÂÖÖÈù¢ÁßØ„ÄÅ‰ΩçÁΩÆÁ≠âÂ≠óÊÆµ..."></textarea>
                            </div>
                        </div>



                        <!-- Manual Mode Section -->
                        <div id="manualModeSection" style="display: none;">
                            <div class="alert-info-compact">
                                <i class="fas fa-edit"></i> ÊâãÂä®ÈÖçÁΩÆÁî®Êà∑ÁîªÂÉèÂíåÂØπËØùÂú∫ÊôØ
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label for="userRole" class="form-label">Áî®Êà∑ËßíËâ≤</label>
                                    <input type="text" class="form-control" id="userRole" name="userRole"
                                        placeholder="Â¶ÇÔºöÁé∞Âú∫ÁõëÁêÜÂ∑•Á®ãÂ∏à">
                                </div>
                                <div class="col-md-6">
                                    <label for="experienceLevel" class="form-label">ÁªèÈ™åÊ∞¥Âπ≥</label>
                                    <input type="text" class="form-control" id="experienceLevel" name="experienceLevel"
                                        placeholder="Â¶ÇÔºö5Âπ¥Â∑•Á®ãÁªèÈ™å">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <label for="communicationStyle" class="form-label">Ê≤üÈÄöÈ£éÊ†º</label>
                                    <input type="text" class="form-control" id="communicationStyle"
                                        name="communicationStyle" placeholder="Â¶ÇÔºöÂÅèÂ•ΩÁÆÄÊ¥ÅÊòé‰∫Ü">
                                </div>
                            </div>
                        </div>
                    </div> <!-- Close customProjectMode -->
                </div>

                <!-- Manual Scenarios Section -->
                <div id="scenariosSection" style="display: none;">
                    <div class="collapsible-card">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="collapsible-title">
                                <i class="fas fa-comments"></i>
                                ÂØπËØùÂú∫ÊôØÈÖçÁΩÆ
                            </div>
                            <i class="fas fa-chevron-down collapsible-toggle"></i>
                        </div>
                        <div class="collapsible-content">
                            <div id="scenariosContainer">
                                <!-- Default scenario will be added by JavaScript -->
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addScenario()">
                                <i class="fas fa-plus"></i> Ê∑ªÂä†Âú∫ÊôØ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-play"></i> ÂºÄÂßãËØÑ‰º∞
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line"></i> ËØÑ‰º∞ÁªìÊûú
                    </h4>
                    <div class="btn-group" role="group" aria-label="Download options">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="inspectDataStructure()">
                            <i class="fas fa-search"></i> Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑ
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadReport('json')">
                            <i class="fas fa-download"></i> JSON
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadReport('txt')">
                            <i class="fas fa-file-alt"></i> TXT
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadReport('docx')">
                            <i class="fas fa-file-word"></i> DOCX
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-cog"></i> ÈÄâÈ°π
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <div class="form-check dropdown-item">
                                        <input class="form-check-input" type="checkbox" id="includeTranscript">
                                        <label class="form-check-label" for="includeTranscript">
                                            ÂåÖÂê´ÂØπËØùËÆ∞ÂΩï
                                        </label>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-custom"></div>
            <h6 id="loadingText">Ê≠£Âú®ËØÑ‰º∞‰∏≠...</h6>
            <p class="text-muted mb-0" id="loadingSubtext">ËØ∑Á®çÂÄôÔºåËøôÂèØËÉΩÈúÄË¶ÅÂá†ÂàÜÈíü</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // THIS ENTIRE SCRIPT BLOCK IS A REPLACEMENT FOR THE EXISTING ONE.
        let scenarioCounter = 1;
        let currentEvaluationData = null;
        let selectedProjectScenario = 'specification-query';

        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ AI AgentËØÑ‰º∞Âπ≥Âè∞Â∑≤Âä†ËΩΩ');
            const form = document.getElementById('evaluationForm');
            form.addEventListener('submit', handleFormSubmit);

            form.querySelectorAll('input[type="text"], input[type="url"], input[type="password"]').forEach(input => {
                input.addEventListener('keypress', e => e.key === 'Enter' && e.preventDefault());
            });

            const firstAICard = document.querySelector('.info-card[data-type="coze-agent"]');
            if (firstAICard) selectAIType({ target: firstAICard });

            const firstScenarioCard = document.querySelector('.info-card[data-scenario="specification-query"]');
            if (firstScenarioCard) selectProjectScenario({ target: firstScenarioCard });

            const dynamicModeRadio = document.getElementById('dynamicMode');
            if (dynamicModeRadio) dynamicModeRadio.addEventListener('change', toggleEvaluationMode);

            const manualModeRadio = document.getElementById('manualMode');
            if (manualModeRadio) manualModeRadio.addEventListener('change', toggleEvaluationMode);

            const apiHeadersField = document.getElementById('apiHeaders');
            if (apiHeadersField) {
                apiHeadersField.addEventListener('input', validateApiHeaders);
                apiHeadersField.addEventListener('paste', handleHeadersPaste);
            }

            toggleEvaluationMode();

            document.querySelectorAll('.collapsible-header').forEach((header, index) => {
                if (index > 0) toggleCollapsible(header);
            });
        });

        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.collapsible-toggle');
            if (!content || !toggle) return;
            content.classList.toggle('collapsed');
            toggle.classList.toggle('rotated');
        }

        function selectProjectScenario(event) {
            const targetElement = event.target.closest('.info-card');
            if (!targetElement) return;
            selectedProjectScenario = targetElement.getAttribute('data-scenario');
            document.querySelectorAll('.info-card[data-scenario]').forEach(card => card.classList.remove('active'));
            targetElement.classList.add('active');
            document.getElementById('specificationQueryMode').style.display = selectedProjectScenario === 'specification-query' ? 'block' : 'none';
            document.getElementById('customProjectMode').style.display = selectedProjectScenario === 'custom' ? 'block' : 'none';
            document.getElementById('specificationQueryInfo').style.display = selectedProjectScenario === 'specification-query' ? 'block' : 'none';
            document.getElementById('customProjectInfo').style.display = selectedProjectScenario === 'custom' ? 'block' : 'none';
        }

        function selectAIType(event) {
            const targetElement = event.target.closest('.info-card');
            if (!targetElement) return;
            const aiType = targetElement.getAttribute('data-type');
            document.querySelectorAll('#cozeAgentId, #cozeAgentToken, #cozeBotIdNew, #apiUrl').forEach(input => input.removeAttribute('required'));
            document.getElementById('cozeAgentConfig').style.display = 'none';
            document.getElementById('cozeBotConfig').style.display = 'none';
            document.getElementById('customApiConfig').style.display = 'none';
            document.querySelectorAll('.info-card[data-type]').forEach(card => card.classList.remove('active'));
            if (aiType === 'coze-agent') {
                document.getElementById('cozeAgentConfig').style.display = 'block';
                document.getElementById('cozeAgentId').setAttribute('required', 'required');
                document.getElementById('cozeAgentToken').setAttribute('required', 'required');
            } else if (aiType === 'coze-bot') {
                document.getElementById('cozeBotConfig').style.display = 'block';
                document.getElementById('cozeBotIdNew').setAttribute('required', 'required');
            } else if (aiType === 'custom-api') {
                document.getElementById('customApiConfig').style.display = 'block';
                document.getElementById('apiUrl').setAttribute('required', 'required');
            }
            targetElement.classList.add('active');
        }

        function handleDynamicFileUpload(input) {
            if (input.files.length > 0) {
                document.getElementById('dynamicUploadedFileName').textContent = input.files[0].name;
                document.getElementById('dynamicFileUploadStatus').style.display = 'block';
            }
        }

        function toggleEvaluationMode() {
            const dynamicModeRadio = document.getElementById('dynamicMode');
            if (!dynamicModeRadio) return;
            const isDynamic = dynamicModeRadio.checked;
            document.getElementById('dynamicModeSection').style.display = isDynamic ? 'block' : 'none';
            document.getElementById('manualModeSection').style.display = isDynamic ? 'none' : 'block';
            document.getElementById('scenariosSection').style.display = isDynamic ? 'none' : 'block';
        }

        async function handleFormSubmit(event) {
            event.preventDefault();

            // Check if tricky test mode is enabled
            const isTrickyTestEnabled = (selectedProjectScenario === 'specification-query' && document.getElementById('enableTrickyTest').checked) ||
                (selectedProjectScenario !== 'specification-query' && document.getElementById('enableTrickyTestDynamic')?.checked);

            const loadingMessage = isTrickyTestEnabled ?
                'üéØ Ê≠£Âú®ÂáÜÂ§áÂàÅÈíªÊµãËØïËØÑ‰º∞Êï∞ÊçÆ...' :
                'Ê≠£Âú®ÂáÜÂ§áËØÑ‰º∞Êï∞ÊçÆ...';

            showLoading(loadingMessage);
            const formData = new FormData();
            try {
                formData.append('agent_api_config', JSON.stringify(getAIConfiguration()));
                let endpoint = '';
                if (selectedProjectScenario === 'specification-query') {
                    formData.append('enable_turn_control', document.getElementById('enableTurnControl').checked);
                    formData.append('is_tricky_test', document.getElementById('enableTrickyTest').checked);
                    endpoint = '/api/evaluate-agent-specification-query';
                } else {
                    const isDynamic = document.getElementById('dynamicMode').checked;
                    formData.append('evaluation_mode', isDynamic ? 'dynamic' : 'manual');
                    if (isDynamic) {
                        const fileInput = document.getElementById('dynamicRequirementFile');
                        const textInput = document.getElementById('dynamicRequirementDoc');
                        if (fileInput.files.length > 0) formData.append('requirement_file', fileInput.files[0]);
                        else if (textInput.value.trim()) formData.append('requirement_text', textInput.value.trim());
                        else throw new Error('Âä®ÊÄÅÂØπËØùÊ®°ÂºèÈúÄ‰∏ä‰º†ÊñáÊ°£ÊàñËæìÂÖ•ÂÜÖÂÆπ');
                        formData.append('is_tricky_test', document.getElementById('enableTrickyTestDynamic').checked);
                        endpoint = '/api/evaluate-agent-dynamic';
                    } else {
                        formData.append('scenarios', JSON.stringify(collectScenariosData()));
                        formData.append('user_persona', JSON.stringify({ role: document.getElementById('userRole').value, experience_level: document.getElementById('experienceLevel').value, communication_style: document.getElementById('communicationStyle').value }));
                        endpoint = '/api/evaluate-agent';
                    }
                }
                const response = await fetch(endpoint, { method: 'POST', body: formData, signal: createTimeoutSignal(720000) });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                displayResults(await response.json());
            } catch (error) {
                console.error('‚ùå Evaluation failed:', error);
                alert('ËØÑ‰º∞Â§±Ë¥•: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function createTimeoutSignal(timeoutMs) {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), timeoutMs);
            return controller.signal;
        }

        function collectScenariosData() { /* Placeholder for existing function */ return []; }

        function getAIConfiguration() {
            // Find which AI type is selected
            const selectedAICard = document.querySelector('.info-card[data-type].active');
            if (!selectedAICard) {
                throw new Error('ËØ∑ÈÄâÊã©AIÁ±ªÂûã');
            }

            const aiType = selectedAICard.getAttribute('data-type');
            let config = {};

            if (aiType === 'coze-agent') {
                const agentId = document.getElementById('cozeAgentId').value.trim();
                const token = document.getElementById('cozeAgentToken').value.trim();
                const region = document.getElementById('cozeRegion').value;

                if (!agentId || !token) {
                    throw new Error('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑCoze AgentÈÖçÁΩÆ‰ø°ÊÅØ');
                }

                config = {
                    type: 'coze-agent',
                    agentId: agentId,
                    region: region,
                    url: region === 'global' ? 'https://api.coze.com' : 'https://api.coze.cn',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    timeout: 120
                };
            } else if (aiType === 'coze-bot') {
                const botId = document.getElementById('cozeBotIdNew').value.trim();
                const botVersion = document.getElementById('cozeBotVersion').value.trim();

                if (!botId) {
                    throw new Error('ËØ∑Â°´ÂÜôCoze Bot ID');
                }

                config = {
                    type: 'coze-bot',
                    botId: botId,
                    botVersion: botVersion || undefined,
                    url: 'https://api.coze.cn/v1/bot/chat',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    timeout: 120
                };
            } else if (aiType === 'custom-api') {
                const apiUrl = document.getElementById('apiUrl').value.trim();
                const method = document.getElementById('apiMethod').value;
                const headersText = document.getElementById('apiHeaders').value.trim();

                if (!apiUrl) {
                    throw new Error('ËØ∑Â°´ÂÜôAPI URL');
                }

                let headers = {};
                if (headersText) {
                    try {
                        headers = JSON.parse(headersText);
                    } catch (e) {
                        throw new Error('ËØ∑Ê±ÇÂ§¥Ê†ºÂºèÈîôËØØÔºåËØ∑‰ΩøÁî®ÊúâÊïàÁöÑJSONÊ†ºÂºè');
                    }
                }

                config = {
                    type: 'custom-api',
                    url: apiUrl,
                    method: method,
                    headers: headers,
                    timeout: 120
                };
            }

            return config;
        }
        function showLoading(message) { document.getElementById('loadingText').textContent = message; document.getElementById('loadingOverlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
        function getScoreGrade(score) { if (score >= 90) return '‰ºòÁßÄ'; if (score >= 80) return 'ËâØÂ•Ω'; if (score >= 60) return 'ÂèäÊ†º'; return 'ÈúÄÊîπËøõ'; }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = String(text); return div.innerHTML; }
        function cleanAiResponse(response) { if (!response) return 'ÊöÇÊó†ÂõûÂ§ç'; return String(response).replace(/\\n/g, ' ').replace(/\\/g, '').trim(); }

        // Tricky Test Mode Functions
        function handleTrickyTestToggle(checkboxId) {
            const checkbox = document.getElementById(checkboxId);
            const configSection = checkbox.closest('.config-section');

            if (checkbox.checked) {
                configSection.classList.add('tricky-test-active');
                if (!configSection.querySelector('.tricky-test-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'tricky-test-indicator';
                    indicator.innerHTML = '‚ö°';
                    indicator.title = 'ÂàÅÈíªÊµãËØïÊ®°ÂºèÊøÄÊ¥ª';
                    configSection.style.position = 'relative';
                    configSection.appendChild(indicator);
                }
                showTrickyTestWarning();
            } else {
                configSection.classList.remove('tricky-test-active');
                const indicator = configSection.querySelector('.tricky-test-indicator');
                if (indicator) indicator.remove();
            }
        }

        function showTrickyTestWarning() {
            if (document.querySelector('.tricky-test-warning')) return; // Don't show multiple warnings

            const warning = document.createElement('div');
            warning.className = 'alert alert-warning tricky-test-warning mt-2';
            warning.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>ÂàÅÈíªÊµãËØïÊ®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºö</strong>
                Â∞ÜÁîüÊàêÊûÅÁ´ØÂú∫ÊôØÈóÆÈ¢òÔºàÂ¶ÇÂçóÊûÅÂª∫ËÆæ„ÄÅÂéÜÂè≤Âª∫Á≠ëÊîπÈÄ†Á≠âÔºâÊù•ÊµãËØïAIÁü•ËØÜËæπÁïå„ÄÇ
                Ëøô‰∫õÈóÆÈ¢òÂèØËÉΩÊó†Ê≥ïÂú®Ê†áÂáÜËßÑËåÉÊï∞ÊçÆÂ∫ì‰∏≠ÊâæÂà∞Á≠îÊ°à„ÄÇ
            `;

            const firstConfigSection = document.querySelector('.config-section');
            firstConfigSection.parentNode.insertBefore(warning, firstConfigSection.nextSibling);

            setTimeout(() => {
                if (warning.parentNode) warning.remove();
            }, 8000);
        }

        function displayResults(data) {
            currentEvaluationData = data;
            console.log('üîç FULL JSON DATA:', data);
            const resultsContainer = document.getElementById('resultsContent');
            resultsContainer.innerHTML = generateFinalReport(data);
            document.getElementById('resultsSection').style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function generateFinalReport(data) {
            const summary = data.evaluation_summary || {};
            const persona = summary.persona || {};
            const usageContext = summary.usage_context || {};
            const goal = summary.goal || {};
            const recommendations = summary.recommendations || data.recommendations || [];
            return `
                <div class="final-report-container">
                    ${generateOverallScoreCard(summary)}
                    ${generateRecommendationsCard(recommendations)}
                    ${generateUserPersonaCard(persona, usageContext, goal)}
                    ${generateDimensionsCard(summary.dimension_scores_100)}
                    ${generateConversationsCard(data.conversation_records || [])}
                    ${generateTechDataCard(data)}
                </div>
            `;
        }

        function generateOverallScoreCard(summary) {
            const score = parseFloat(summary.overall_score_100 || 0);
            const grade = getScoreGrade(score);
            const color = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';

            // Check if tricky test mode was used
            const isTrickyMode = summary.is_tricky_test || false;
            const trickyBadge = isTrickyMode ? `<span class="badge bg-warning ms-2" title="‰ΩøÁî®‰∫ÜÂàÅÈíªÊµãËØïÊ®°Âºè"><i class="fas fa-bolt"></i> ÂàÅÈíªÊ®°Âºè</span>` : '';

            return `<div class="card border-${color} mb-4 shadow-lg"><div class="card-header bg-${color} text-white"><div class="row align-items-center"><div class="col-md-7"><h3 class="mb-1 fw-bold"><i class="fas fa-trophy"></i> ÁªºÂêàÂæóÂàÜÊä•Âëä${trickyBadge}</h3><p class="mb-0 small opacity-75">ÊúÄÁªàÂæóÂàÜÔºà100ÂàÜÂà∂Ôºâ${isTrickyMode ? ' - ÊûÅÁ´ØÂú∫ÊôØÊµãËØï' : ''}</p></div><div class="col-md-5 text-md-end text-center mt-2 mt-md-0"><span class="display-4 fw-bold">${score.toFixed(1)}</span><span class="h4">/ 100</span></div></div></div><div class="card-body p-4"><div class="row text-center"><div class="col-6 col-md-3"><div class="stat-number text-primary">${summary.total_scenarios || 0}</div><div class="stat-label">ËØÑ‰º∞Âú∫ÊôØ</div></div><div class="col-6 col-md-3"><div class="stat-number text-info">${summary.total_conversations || 0}</div><div class="stat-label">ÊÄªÂØπËØùËΩÆÊ¨°</div></div><div class="col-md-3 d-none d-md-block"><div class="stat-number text-${color}">${grade}</div><div class="stat-label">ÁªºÂêàËØÑÁ∫ß</div></div><div class="col-md-3 d-none d-md-block"><div class="stat-number text-warning">${isTrickyMode ? 'ÂàÅÈíª' : 'Â∏∏ËßÑ'}</div><div class="stat-label">ÊµãËØïÊ®°Âºè</div></div></div>${isTrickyMode ? '<div class="alert alert-warning mt-3 mb-0"><i class="fas fa-info-circle"></i> <strong>ÂàÅÈíªÊµãËØïÊ®°ÂºèÔºö</strong> Êú¨Ê¨°ËØÑ‰º∞‰ΩøÁî®‰∫ÜÊûÅÁ´ØÂú∫ÊôØÈóÆÈ¢òÔºåÊµãËØïÁªìÊûúÂèØËÉΩÂèçÊò†AIÂú®ËæπÁïåÊÉÖÂÜµ‰∏ãÁöÑË°®Áé∞„ÄÇ</div>' : ''}</div></div>`;
        }

        function generateRecommendationsCard(recommendations) {
            if (!recommendations || recommendations.length === 0) {
                return `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">‰ºòÂåñÂª∫ËÆÆ</h5>
                            <p class="text-muted">ÊöÇÊó†ÂÖ∑‰ΩìÊîπËøõÂª∫ËÆÆÔºåÂΩìÂâçË°®Áé∞ËâØÂ•Ω„ÄÇ</p>
                        </div>
                    </div>`;
            }

            // Check if these are AI-generated recommendations
            const isAISuggestion = recommendations === window.aiImprovementSuggestions;

            return `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            ${isAISuggestion ? 'AIÊô∫ËÉΩÊîπËøõÂª∫ËÆÆ' : '‰ºòÂåñÂª∫ËÆÆ'}
                            ${isAISuggestion ? '<span class="badge bg-primary ms-2">AI</span>' : ''}
                        </h5>
                        <div class="recommendations-container" style="max-height: 500px; overflow-y: auto;">
                            ${recommendations.map(rec => {
                // Split the recommendation into lines and preserve formatting
                const lines = rec.split('\n');
                const formattedLines = lines.map(line => {
                    if (line.startsWith('ÈóÆÈ¢òÔºö')) {
                        return `<h6 class="mb-2 text-primary">${line}</h6>`;
                    } else if (line.startsWith('ÊñπÊ°àÔºö')) {
                        return `<p class="mb-2">${line}</p>`;
                    } else if (line.startsWith('È¢ÑÊúüÔºö')) {
                        return `<p class="mb-3 text-info"><small>${line}</small></p>`;
                    } else {
                        return `<p class="mb-2">${line}</p>`;
                    }
                }).join('');

                return `
                                    <div class="recommendation-item mb-4 p-3 border rounded">
                                        ${formattedLines}
                                    </div>`;
            }).join('')}
                        </div>
                    </div>
                </div>`;
        }

        function generateUserPersonaCard(persona, usageContext, goal) {
            // Fix persona data structure - extract from user_persona_info if nested
            let actualPersona = persona;
            let actualContext = usageContext;
            let actualGoal = goal;

            // Check if data is nested in user_persona_info structure
            if (currentEvaluationData?.user_persona_info?.extracted_persona_summary) {
                const extractedData = currentEvaluationData.user_persona_info.extracted_persona_summary;
                actualPersona = extractedData.user_persona || persona;
                actualContext = extractedData.usage_context || usageContext;
                actualGoal = actualContext?.goal || goal;
            }

            return `<div class="collapsible-card mb-4"><div class="collapsible-header" onclick="toggleCollapsible(this)"><div class="collapsible-title"><i class="fas fa-user-tie"></i> üë§ Áî®Êà∑ÁîªÂÉè‰∏é‰ΩøÁî®Âú∫ÊôØ</div><i class="fas fa-chevron-down collapsible-toggle"></i></div><div class="collapsible-content collapsed"><div class="row"><div class="col-md-4 mb-3"><h6><i class="fas fa-user-tag text-primary"></i> Áî®Êà∑ÁîªÂÉè</h6><p class="small text-muted mb-1"><strong>ËßíËâ≤:</strong> ${escapeHtml(actualPersona?.role || 'Â∑•Á®ãÈ°πÁõÆÁé∞Âú∫ÁõëÁêÜÂ∑•Á®ãÂ∏à')}</p><p class="small text-muted mb-0"><strong>ÁªèÈ™å:</strong> ${escapeHtml(actualPersona?.experience_level || 'ÊúâÁªèÈ™å')}</p><p class="small text-muted mb-0"><strong>È£éÊ†º:</strong> ${escapeHtml(actualPersona?.communication_style || '‰∏ì‰∏öÁõ¥Êé•')}</p></div><div class="col-md-4 mb-3"><h6><i class="fas fa-building text-info"></i> ‰ΩøÁî®Âú∫ÊôØ</h6><p class="small text-muted mb-0"><strong>È¢ÜÂüü:</strong> ${escapeHtml(actualContext?.business_domain || 'Â∑•Á®ãÈ°πÁõÆÁé∞Âú∫ÁõëÁêÜ')}</p><p class="small text-muted mb-0"><strong>Âú∫ÊôØ:</strong> ${escapeHtml(actualContext?.usage_scenario || 'Â∑°Ê£ÄÈ™åÊî∂Êó∂ËßÑËåÉÊü•ËØ¢')}</p></div><div class="col-md-4"><h6><i class="fas fa-bullseye text-success"></i> ‰ΩøÁî®ÁõÆÊ†á</h6><ul class="list-unstyled mb-0"><li class="small text-muted"><i class="fas fa-dot-circle me-2"></i>${escapeHtml(actualGoal?.goal || 'Âø´ÈÄüÂáÜÁ°ÆËé∑ÂèñËßÑËåÉ‰ø°ÊÅØ')}</li></ul></div></div></div></div>`;
        }

        function generateDimensionsCard(scores) {
            if (!scores || !Object.keys(scores).length) return '';
            const cards = Object.entries(scores).map(([label, value]) => {
                const score = parseFloat(value), grade = getScoreGrade(score), color = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
                return `<div class="col-md-6 col-lg-4 mb-3"><div class="card border-${color} h-100 shadow-sm"><div class="card-body text-center p-3"><h6 class="card-title text-${color} mb-2">${label}</h6><div class="h2 fw-bold text-${color}">${score.toFixed(1)}</div><div class="small text-muted mb-2">/ 100</div><span class="badge bg-${color}">${grade}</span></div></div></div>`;
            }).join('');
            return `<div class="collapsible-card mb-4"><div class="collapsible-header" onclick="toggleCollapsible(this)"><div class="collapsible-title"><i class="fas fa-chart-bar"></i> üìä ÂêÑÁª¥Â∫¶ËØ¶ÁªÜËØÑÂàÜ</div><i class="fas fa-chevron-down collapsible-toggle"></i></div><div class="collapsible-content collapsed"><div class="row">${cards}</div></div></div>`;
        }

        function generateConversationsCard(records) {
            if (!records || !records.length) return '';
            return `<div class="collapsible-card mb-4"><div class="collapsible-header" onclick="toggleCollapsible(this)"><div class="collapsible-title"><i class="fas fa-comments"></i> üí¨ ËØ¶ÁªÜÂØπËØùËÆ∞ÂΩï‰∏éËØÑ‰º∞ÂàÜÊûê</div><i class="fas fa-chevron-down collapsible-toggle"></i></div><div class="collapsible-content collapsed p-2" style="background-color:#f8f9fa;">${records.map((r, i) => generateSingleConversationRecord(r, i)).join('')}</div></div>`;
        }

        function generateSingleConversationRecord(record, index) {
            const scenario = record.scenario || {};
            const history = record.conversation_history || [];
            const explanations = record.evaluation_scores_with_explanations || {};
            const score = record.scenario_score_100 || 0;
            return `<div class="card mb-3"><div class="card-header bg-light p-2"><h6 class="mb-0 small">Âú∫ÊôØ ${index + 1}: ${escapeHtml(scenario.title)}<span class="badge bg-primary float-end">${score.toFixed(1)}</span></h6></div><div class="card-body p-2"><div class="mb-2"><strong class="small text-muted">ÂØπËØùÂéÜÂè≤:</strong>${history.map((t, i) => `<div class="ps-2 border-start small"><strong>${i + 1}. U:</strong> ${escapeHtml(t.user_message)}<br><strong>A:</strong> ${escapeHtml(cleanAiResponse(t.ai_response))}</div>`).join('')}</div><div><strong class="small text-muted">ËØ¶ÁªÜÂàÜÊûê:</strong>${Object.entries(explanations).map(([dim, data]) => generateDimensionAnalysis(dim, data, index)).join('')}</div></div></div>`;
        }

        function generateDimensionAnalysis(dimension, scoreData, recordIndex) {
            const score = parseFloat(scoreData.score);
            const color = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
            return `<div class="small ms-2"><span class="badge bg-${color}">${dimension}: ${score.toFixed(0)}</span> ${escapeHtml(scoreData.detailed_analysis || '')}</div>`;
        }

        function generateTechDataCard(data) {
            // Properly format JSON with indentation for better readability
            const formattedJson = JSON.stringify(data, null, 2);
            return `<div class="collapsible-card mb-4"><div class="collapsible-header" onclick="toggleCollapsible(this)"><div class="collapsible-title"><i class="fas fa-database"></i> üîß ÊäÄÊúØÊï∞ÊçÆ‰∏é‰∏ãËΩΩ</div><i class="fas fa-chevron-down collapsible-toggle"></i></div><div class="collapsible-content collapsed"><p class="text-muted small">Áî®‰∫éÂºÄÂèëÈõÜÊàê„ÄÅÊï∞ÊçÆÂàÜÊûêÊàñÂ§á‰ªΩÁöÑÂÆåÊï¥ÂéüÂßãJSONÊï∞ÊçÆ„ÄÇ</p><pre class="bg-dark text-light p-3 rounded small" style="max-height:300px;overflow:auto;"><code>${escapeHtml(formattedJson)}</code></pre></div></div>`;
        }

        async function downloadReport(format) {
            if (!currentEvaluationData) return alert('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑËØÑ‰º∞ÁªìÊûú');
            try {
                if (format === 'json') {
                    // Handle JSON download with proper formatting
                    const formattedJson = JSON.stringify(currentEvaluationData, null, 2);
                    const blob = new Blob([formattedJson], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = window.URL.createObjectURL(blob);
                    a.download = `evaluation-report-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(a.href);
                } else {
                    // Handle other formats through API
                    const formData = new FormData();
                    formData.append('evaluation_data', JSON.stringify(currentEvaluationData));
                    formData.append('format', format);
                    formData.append('include_transcript', document.getElementById('includeTranscript')?.checked || false);
                    const response = await fetch('/api/download-report', { method: 'POST', body: formData, signal: createTimeoutSignal(120000) });
                    if (!response.ok) throw new Error(`‰∏ãËΩΩÂ§±Ë¥•: ${response.statusText}`);
                    const blob = await response.blob();
                    const a = document.createElement('a');
                    a.href = window.URL.createObjectURL(blob);
                    a.download = `evaluation-report-${Date.now()}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(a.href);
                }
            } catch (error) {
                console.error('‚ùå Download failed:', error);
                alert('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
            }
        }

        function validateApiHeaders() { /* Placeholder */ }
        function handleHeadersPaste() { /* Placeholder */ }
        function showHeadersWarning(message) { /* Placeholder */ }
        function clearHeadersWarning() { /* Placeholder */ }
        function inspectDataStructure() { console.log(currentEvaluationData); alert('Data structure logged to console.'); }
    </script>
</body>

</html>