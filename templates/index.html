<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ï¿½ï¿½ AI Agent è‡ªåŠ¨åŒ–è¯„ä¼°å¹³å° v4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --surface-color: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --compact-padding: 20px;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            line-height: 1.5;
        }

        .main-container {
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin: 20px auto;
            max-width: 1200px;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .header h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 2rem;
        }

        .header .lead {
            color: #6b7280;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        /* Collapsible Card System */
        .collapsible-card {
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 1.1rem;
        }

        .collapsible-toggle {
            color: #6b7280;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .collapsible-toggle.rotated {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: var(--compact-padding);
            transition: all 0.3s ease;
        }

        .collapsible-content.collapsed {
            display: none;
        }

        /* Compact Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .info-card:hover {
            border-color: var(--info-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .info-card.active {
            border-color: var(--info-color);
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .info-card i {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--info-color);
        }

        .info-card h6 {
            font-weight: 600;
            margin-bottom: 5px;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .info-card small {
            color: #6b7280;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* Compact Form Sections */
        .config-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .config-section h6 {
            color: #374151;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Compact Forms */
        .compact-form .row {
            margin-bottom: 12px;
        }

        .compact-form .form-control,
        .compact-form .form-select {
            padding: 8px 12px;
            font-size: 0.9rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .compact-form .form-control:focus,
        .compact-form .form-select:focus {
            border-color: var(--info-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .compact-form .form-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        /* Compact Alerts */
        .alert-compact {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            border: none;
        }

        .alert-info-compact {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: #1e40af;
            border-left: 3px solid var(--info-color);
        }

        .alert-success-compact {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #065f46;
            border-left: 3px solid var(--success-color);
        }

        .alert-warning-compact {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #92400e;
            border-left: 3px solid var(--warning-color);
        }

        /* Mode Selection - Inline */
        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .mode-option {
            flex: 1;
            min-width: 200px;
        }

        .mode-option .form-check {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-option .form-check:hover {
            border-color: var(--info-color);
            background: #eff6ff;
        }

        .mode-option .form-check-input:checked~.form-check-label {
            color: var(--info-color);
        }

        /* Compact File Upload */
        .file-upload-compact {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .file-upload-compact:hover {
            border-color: var(--info-color);
            background: #eff6ff;
        }

        .file-upload-compact i {
            font-size: 1.5rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .file-upload-compact h6 {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .file-upload-compact p {
            font-size: 0.8rem;
            margin-bottom: 0;
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #334155;
        }

        /* Results Section - Compact */
        .results-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }

        .dimension-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
        }

        .dimension-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .overall-score {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .star-rating {
            color: #fbbf24;
            font-size: 1.1rem;
            margin: 10px 0;
            letter-spacing: 1px;
        }

        /* Conversation Display - Collapsible */
        .conversation-section {
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        .conversation-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .conversation-header:hover {
            background: #f1f5f9;
        }

        .conversation-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .conversation-turn {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--info-color);
            font-size: 0.85rem;
        }

        .user-message {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left-color: var(--info-color);
        }

        .ai-response {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left-color: var(--success-color);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 300px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .spinner-custom {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--info-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 20px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .mode-selector {
                flex-direction: column;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-brain"></i> AI Agent è‡ªåŠ¨åŒ–è¯„ä¼°å¹³å°</h1>
                <p class="lead">åŸºäºDeepSeekæ™ºèƒ½å¼•æ“çš„ä¸“ä¸šAIä»£ç†è¯„ä¼°ç³»ç»Ÿ</p>
                <p class="subtitle">æ”¯æŒå¤šå¹³å°API â€¢ æ–‡æ¡£æ™ºèƒ½è§£æ â€¢ 4ç»´åº¦è¯„ä¼°æ¡†æ¶ â€¢ å·¥ä½œæµå…¼å®¹</p>
            </div>

            <!-- AI Type Selection - Collapsible -->
            <div class="collapsible-card">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <i class="fas fa-lightbulb"></i>
                        AIç³»ç»Ÿä¿¡æ¯æŒ‡å—
                    </div>
                    <i class="fas fa-chevron-down collapsible-toggle"></i>
                </div>
                <div class="collapsible-content">
                    <div class="info-grid">
                        <div class="info-card" data-type="coze-agent" onclick="selectAIType(event)">
                            <i class="fas fa-robot"></i>
                            <h6>Coze AI Agent</h6>
                            <small>æ™ºèƒ½ä»£ç†ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨</small>
                        </div>
                        <div class="info-card" data-type="coze-bot" onclick="selectAIType(event)">
                            <i class="fas fa-comments"></i>
                            <h6>Coze Bot</h6>
                            <small>ä¼ ç»ŸèŠå¤©æœºå™¨äºº</small>
                        </div>
                        <div class="info-card" data-type="custom-api" onclick="selectAIType(event)">
                            <i class="fas fa-code"></i>
                            <h6>è‡ªå®šä¹‰ API</h6>
                            <small>å…¶ä»–AIæœåŠ¡</small>
                        </div>
                    </div>
                    <div class="alert-info-compact">
                        <strong><i class="fas fa-comment-dots"></i> æ²Ÿé€šè¯æœ¯ï¼š</strong>
                        "æˆ‘éœ€è¦æµ‹è¯•ä½ ä»¬çš„AIç³»ç»Ÿæ€§èƒ½ï¼Œèƒ½æä¾›ä¸€ä¸‹ç›¸å…³çš„é…ç½®ä¿¡æ¯å—ï¼Ÿ"
                    </div>
                </div>
            </div>

            <!-- Main Form -->
            <form id="evaluationForm" enctype="multipart/form-data" class="compact-form">

                <!-- AI Configuration - Collapsible -->
                <div class="collapsible-card">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title">
                            <i class="fas fa-cog"></i>
                            AIç³»ç»Ÿé…ç½®
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <!-- Coze Agent Config -->
                        <div id="cozeAgentConfig" class="config-section">
                            <h6><i class="fas fa-robot"></i> Coze Agent é…ç½®</h6>
                            <div class="alert-info-compact">
                                <i class="fas fa-info-circle"></i> ç¡®ä¿Agentå·²å‘å¸ƒä¸”å¤„äºæ´»è·ƒçŠ¶æ€
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="cozeAgentId" class="form-label">Agent ID *</label>
                                    <input type="text" class="form-control" id="cozeAgentId" name="cozeAgentId"
                                        value="7498244859505999924" placeholder="Agentå”¯ä¸€æ ‡è¯†">
                                </div>
                                <div class="col-md-6">
                                    <label for="cozeAgentToken" class="form-label">Access Token *</label>
                                    <input type="password" class="form-control" id="cozeAgentToken"
                                        name="cozeAgentToken"
                                        value="pat_DiraOZEjagK8c6NNPJKionQsCj99zZduVyGkYO8YojolSQ8WAjBdF2CgbXNLMaFi"
                                        placeholder="APIè®¿é—®ä»¤ç‰Œ">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="cozeRegion" class="form-label">å¹³å°ç‰ˆæœ¬</label>
                                    <select class="form-select" id="cozeRegion" name="cozeRegion">
                                        <option value="global">Global (coze.com)</option>
                                        <option value="china" selected>China (coze.cn)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Coze Bot Config -->
                        <div id="cozeBotConfig" class="config-section" style="display: none;">
                            <h6><i class="fas fa-comments"></i> Coze Bot é…ç½®</h6>
                            <div class="alert-success-compact">
                                <i class="fas fa-check-circle"></i> å·²é¢„é…ç½®å·¥ç¨‹è§„èŒƒAIåŠ©æ‰‹
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="cozeBotIdNew" class="form-label">Bot ID *</label>
                                    <input type="text" class="form-control" id="cozeBotIdNew" name="cozeBotIdNew"
                                        value="7511993619423985674" placeholder="Botå”¯ä¸€æ ‡è¯†">
                                </div>
                                <div class="col-md-4">
                                    <label for="cozeBotVersion" class="form-label">Botç‰ˆæœ¬ (å¯é€‰)</label>
                                    <input type="text" class="form-control" id="cozeBotVersion" name="cozeBotVersion"
                                        placeholder="latest">
                                </div>
                            </div>
                        </div>

                        <!-- Custom API Config -->
                        <div id="customApiConfig" class="config-section" style="display: none;">
                            <h6><i class="fas fa-code"></i> è‡ªå®šä¹‰ API é…ç½®</h6>
                            <div class="alert-warning-compact">
                                <i class="fas fa-code"></i> URL: https://api.openai.com/v1/chat/completions
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="apiUrl" class="form-label">API URL *</label>
                                    <input type="url" class="form-control" id="apiUrl" name="apiUrl"
                                        placeholder="https://api.example.com/chat">
                                </div>
                                <div class="col-md-4">
                                    <label for="apiMethod" class="form-label">HTTPæ–¹æ³•</label>
                                    <select class="form-select" id="apiMethod" name="apiMethod">
                                        <option value="POST" selected>POST</option>
                                        <option value="GET">GET</option>
                                        <option value="PUT">PUT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <label for="apiHeaders" class="form-label">è¯·æ±‚å¤´ (JSONæ ¼å¼)</label>
                                    <textarea class="form-control" id="apiHeaders" name="apiHeaders" rows="2"
                                        placeholder='{"Authorization": "Bearer your-token"}'></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Requirement Document -->
                <div class="section-card">
                    <h5 class="section-title">
                        <i class="fas fa-user-tie"></i>
                        ç”¨æˆ·ç”»åƒä¸éœ€æ±‚æ–‡æ¡£é…ç½®
                    </h5>

                    <!-- Mode Selection -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-cogs"></i>
                            é€‰æ‹©é…ç½®æ–¹å¼
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="evaluationMode" id="autoMode"
                                        value="auto">
                                    <label class="form-check-label" for="autoMode">
                                        <strong>ğŸ¤– æ™ºèƒ½æå–</strong><br>
                                        <small>è‡ªåŠ¨æå–ç”¨æˆ·ç”»åƒ</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="evaluationMode" id="dynamicMode"
                                        value="dynamic" checked>
                                    <label class="form-check-label" for="dynamicMode">
                                        <strong>ğŸ—£ï¸ åŠ¨æ€å¯¹è¯</strong><br>
                                        <small>çœŸå®å¯¹è¯æµç¨‹</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="evaluationMode" id="manualMode"
                                        value="manual">
                                    <label class="form-check-label" for="manualMode">
                                        <strong>âœ‹ æ‰‹åŠ¨é…ç½®</strong><br>
                                        <small>è‡ªå®šä¹‰åœºæ™¯</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Mode Section -->
                    <div id="dynamicModeSection">
                        <div class="alert-success-compact">
                            <i class="fas fa-comments"></i> ä¸Šä¼ éœ€æ±‚æ–‡æ¡£ï¼Œè‡ªåŠ¨æå–ç”¨æˆ·ç”»åƒï¼Œç”Ÿæˆ2ä¸ªæµ‹è¯•åœºæ™¯
                        </div>

                        <!-- File Upload -->
                        <div class="file-upload-compact"
                            onclick="document.getElementById('dynamicRequirementFile').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h6>ç‚¹å‡»ä¸Šä¼ éœ€æ±‚æ–‡æ¡£</h6>
                            <p class="text-muted">æ”¯æŒ Word (.docx) â€¢ PDF (.pdf) â€¢ æ–‡æœ¬ (.txt)</p>
                            <input type="file" class="d-none" id="dynamicRequirementFile" name="dynamicRequirementFile"
                                accept=".doc,.docx,.pdf,.txt" onchange="handleDynamicFileUpload(this)">
                        </div>

                        <div id="dynamicFileUploadStatus" style="display: none;" class="alert-success-compact">
                            <i class="fas fa-file-check"></i> <span id="dynamicUploadedFileName"></span> å·²æˆåŠŸä¸Šä¼ 
                        </div>

                        <!-- Text Input Alternative -->
                        <div>
                            <label for="dynamicRequirementDoc" class="form-label">æˆ–ç›´æ¥è¾“å…¥éœ€æ±‚æ–‡æ¡£å†…å®¹</label>
                            <textarea class="form-control" id="dynamicRequirementDoc" name="dynamicRequirementDoc"
                                rows="3" placeholder="ä¾‹ï¼šç›‘ç†å·¥ç¨‹å¸ˆéœ€è¦AIè¯†åˆ«ç”¨æˆ·æ¨¡ç³Šæè¿°å¹¶ä¸»åŠ¨å¼•å¯¼è¡¥å……é¢ç§¯ã€ä½ç½®ç­‰å­—æ®µ..."></textarea>
                        </div>
                    </div>

                    <!-- Auto Mode Section -->
                    <div id="autoModeSection" style="display: none;">
                        <div class="alert-info-compact">
                            <i class="fas fa-magic"></i> DeepSeekå°†è‡ªåŠ¨åˆ†æå¹¶æå–ç”¨æˆ·è§’è‰²ã€ä½¿ç”¨åœºæ™¯ã€æ²Ÿé€šé£æ ¼ç­‰ä¿¡æ¯
                        </div>

                        <div class="file-upload-compact" onclick="document.getElementById('requirementFile').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h6>ä¸Šä¼ éœ€æ±‚æ–‡æ¡£</h6>
                            <p class="text-muted">æ”¯æŒ Word (.docx) â€¢ PDF (.pdf) â€¢ æ–‡æœ¬ (.txt)</p>
                            <input type="file" class="d-none" id="requirementFile" name="requirementFile"
                                accept=".doc,.docx,.pdf,.txt" onchange="handleFileUpload(this)">
                        </div>

                        <div id="fileUploadStatus" style="display: none;" class="alert-success-compact">
                            <i class="fas fa-file-check"></i> <span id="uploadedFileName"></span> å·²æˆåŠŸä¸Šä¼ 
                        </div>

                        <div>
                            <label for="requirementDoc" class="form-label">æˆ–ç›´æ¥è¾“å…¥éœ€æ±‚æ–‡æ¡£å†…å®¹</label>
                            <textarea class="form-control" id="requirementDoc" name="requirementDoc" rows="3"
                                placeholder="è¾“å…¥è¯¦ç»†çš„éœ€æ±‚æ–‡æ¡£å†…å®¹..."></textarea>
                        </div>

                        <button type="button" class="btn btn-secondary mt-2" onclick="extractPersona()">
                            <i class="fas fa-user-cog"></i> æå–ç”¨æˆ·ç”»åƒ
                        </button>
                    </div>

                    <!-- Manual Mode Section -->
                    <div id="manualModeSection" style="display: none;">
                        <div class="alert-info-compact">
                            <i class="fas fa-edit"></i> æ‰‹åŠ¨é…ç½®ç”¨æˆ·ç”»åƒå’Œå¯¹è¯åœºæ™¯
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="userRole" class="form-label">ç”¨æˆ·è§’è‰²</label>
                                <input type="text" class="form-control" id="userRole" name="userRole"
                                    placeholder="å¦‚ï¼šç°åœºç›‘ç†å·¥ç¨‹å¸ˆ">
                            </div>
                            <div class="col-md-6">
                                <label for="experienceLevel" class="form-label">ç»éªŒæ°´å¹³</label>
                                <input type="text" class="form-control" id="experienceLevel" name="experienceLevel"
                                    placeholder="å¦‚ï¼š5å¹´å·¥ç¨‹ç»éªŒ">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label for="communicationStyle" class="form-label">æ²Ÿé€šé£æ ¼</label>
                                <input type="text" class="form-control" id="communicationStyle"
                                    name="communicationStyle" placeholder="å¦‚ï¼šåå¥½ç®€æ´æ˜äº†">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Scenarios Section -->
                <div id="scenariosSection" style="display: none;">
                    <div class="collapsible-card">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="collapsible-title">
                                <i class="fas fa-comments"></i>
                                å¯¹è¯åœºæ™¯é…ç½®
                            </div>
                            <i class="fas fa-chevron-down collapsible-toggle"></i>
                        </div>
                        <div class="collapsible-content">
                            <div id="scenariosContainer">
                                <!-- Default scenario will be added by JavaScript -->
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addScenario()">
                                <i class="fas fa-plus"></i> æ·»åŠ åœºæ™¯
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-play"></i> å¼€å§‹è¯„ä¼°
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <h4 class="text-center mb-4">
                    <i class="fas fa-chart-line"></i> è¯„ä¼°ç»“æœ
                </h4>
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-custom"></div>
            <h6 id="loadingText">æ­£åœ¨è¯„ä¼°ä¸­...</h6>
            <p class="text-muted mb-0" id="loadingSubtext">è¯·ç¨å€™ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let scenarioCounter = 1;
        let extractedPersonaData = null;

        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš€ AI Agentè¯„ä¼°å¹³å°å·²åŠ è½½');

            // Initialize form
            const form = document.getElementById('evaluationForm');
            form.addEventListener('submit', handleFormSubmit);

            // Prevent form submission on Enter
            const inputs = form.querySelectorAll('input[type="text"], input[type="url"], input[type="password"]');
            inputs.forEach(input => {
                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                });
            });

            // Set default AI type and collapse all sections
            const firstAICard = document.querySelector('.info-card[data-type="coze-agent"]');
            if (firstAICard) {
                selectAIType({ target: firstAICard });
            }

            // Add mode switching listeners
            document.getElementById('autoMode').addEventListener('change', toggleEvaluationMode);
            document.getElementById('manualMode').addEventListener('change', toggleEvaluationMode);
            document.getElementById('dynamicMode').addEventListener('change', toggleEvaluationMode);

            // Initialize evaluation mode (don't create scenarios yet)
            toggleEvaluationMode();

            // Collapse all sections by default except the first one
            const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
            collapsibleHeaders.forEach((header, index) => {
                if (index > 0) { // Keep first section open
                    toggleCollapsible(header, true);
                }
            });
        });

        // Collapsible functionality
        function toggleCollapsible(header, forceClose = false) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.collapsible-toggle');

            if (forceClose || !content.classList.contains('collapsed')) {
                content.classList.add('collapsed');
                toggle.classList.remove('rotated');
            } else {
                content.classList.remove('collapsed');
                toggle.classList.add('rotated');
            }
        }

        function selectAIType(eventOrElement) {
            let targetElement;
            if (eventOrElement && eventOrElement.target) {
                targetElement = eventOrElement.target.closest('.info-card');
            } else if (eventOrElement && eventOrElement.classList) {
                targetElement = eventOrElement.closest('.info-card');
            } else {
                console.error('âŒ Invalid argument passed to selectAIType');
                return;
            }

            if (!targetElement) {
                console.error('âŒ Could not find info-card element');
                return;
            }

            const aiType = targetElement.getAttribute('data-type');
            console.log('ğŸ”§ Selecting AI type:', aiType);

            // Remove all required attributes first
            document.querySelectorAll('#cozeAgentId, #cozeAgentToken, #cozeBotIdNew, #apiUrl').forEach(input => {
                input.removeAttribute('required');
            });

            // Hide all configuration sections
            document.getElementById('cozeAgentConfig').style.display = 'none';
            document.getElementById('cozeBotConfig').style.display = 'none';
            document.getElementById('customApiConfig').style.display = 'none';

            // Remove active states from all cards
            document.querySelectorAll('.info-card').forEach(card => {
                card.classList.remove('active');
            });

            // Show the selected configuration and add required attributes
            if (aiType === 'coze-agent') {
                document.getElementById('cozeAgentConfig').style.display = 'block';
                document.getElementById('cozeAgentId').setAttribute('required', 'required');
                document.getElementById('cozeAgentToken').setAttribute('required', 'required');
                console.log('âœ… Coze Agent config shown');
            } else if (aiType === 'coze-bot') {
                document.getElementById('cozeBotConfig').style.display = 'block';
                document.getElementById('cozeBotIdNew').setAttribute('required', 'required');
                console.log('âœ… Coze Bot config shown');
            } else if (aiType === 'custom-api') {
                document.getElementById('customApiConfig').style.display = 'block';
                document.getElementById('apiUrl').setAttribute('required', 'required');
                console.log('âœ… Custom API config shown');
            }

            // Mark the selected card as active
            targetElement.classList.add('active');
        }

        function handleFileUpload(input) {
            if (input.files.length > 0) {
                const fileName = input.files[0].name;
                document.getElementById('uploadedFileName').textContent = fileName;
                document.getElementById('fileUploadStatus').style.display = 'block';
                console.log('ğŸ“„ File uploaded:', fileName);
            }
        }

        function handleDynamicFileUpload(input) {
            if (input.files.length > 0) {
                const fileName = input.files[0].name;
                document.getElementById('dynamicUploadedFileName').textContent = fileName;
                document.getElementById('dynamicFileUploadStatus').style.display = 'block';
                console.log('ğŸ“„ Dynamic file uploaded:', fileName);
            }
        }

        function addDefaultScenario() {
            const container = document.getElementById('scenariosContainer');
            const scenarioHtml = `
                <div class="scenario-card config-section" data-scenario="1">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-comments"></i>
                            åœºæ™¯ 1: é»˜è®¤åœºæ™¯
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeScenario(1)">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">åœºæ™¯æ ‡é¢˜</label>
                            <input type="text" class="form-control" name="scenarioTitle1" 
                                   value="é»˜è®¤æµ‹è¯•åœºæ™¯" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ä¸šåŠ¡ä¸Šä¸‹æ–‡</label>
                            <input type="text" class="form-control" name="scenarioContext1" 
                                   placeholder="å¦‚ï¼šå»ºç­‘å·¥åœ°ã€æ¡¥æ¢ç°åœºç­‰">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">ç”¨æˆ·ç”»åƒ</label>
                            <input type="text" class="form-control" name="scenarioProfile1" 
                                   placeholder="å¦‚ï¼šæ–°æ‰‹æ–½å·¥å‘˜ã€ç»éªŒç›‘ç†ç­‰">
                        </div>
                    </div>
                    
                    <label class="form-label">å¯¹è¯è½®æ¬¡ (ç”¨æˆ·å‘è¨€)</label>
                    <div class="conversation-turns">
                        <input type="text" class="form-control mb-2" name="scenarioTurn1_1" 
                               placeholder="ç¬¬1è½®ç”¨æˆ·å‘è¨€" required>
                        <input type="text" class="form-control mb-2" name="scenarioTurn1_2" 
                               placeholder="ç¬¬2è½®ç”¨æˆ·å‘è¨€">
                        <input type="text" class="form-control" name="scenarioTurn1_3" 
                               placeholder="ç¬¬3è½®ç”¨æˆ·å‘è¨€">
                    </div>
                </div>
            `;
            container.innerHTML = scenarioHtml;
        }

        function addScenario() {
            scenarioCounter++;
            const container = document.getElementById('scenariosContainer');

            const scenarioHtml = `
                <div class="scenario-card config-section" data-scenario="${scenarioCounter}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-comments"></i>
                            åœºæ™¯ ${scenarioCounter}: è‡ªå®šä¹‰åœºæ™¯
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeScenario(${scenarioCounter})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">åœºæ™¯æ ‡é¢˜</label>
                            <input type="text" class="form-control" name="scenarioTitle${scenarioCounter}" 
                                   value="è‡ªå®šä¹‰åœºæ™¯ ${scenarioCounter}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ä¸šåŠ¡ä¸Šä¸‹æ–‡</label>
                            <input type="text" class="form-control" name="scenarioContext${scenarioCounter}" 
                                   placeholder="å¦‚ï¼šå»ºç­‘å·¥åœ°ã€æ¡¥æ¢ç°åœºç­‰">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">ç”¨æˆ·ç”»åƒ</label>
                            <input type="text" class="form-control" name="scenarioProfile${scenarioCounter}" 
                                   placeholder="å¦‚ï¼šæ–°æ‰‹æ–½å·¥å‘˜ã€ç»éªŒç›‘ç†ç­‰">
                        </div>
                    </div>
                    
                    <label class="form-label">å¯¹è¯è½®æ¬¡ (ç”¨æˆ·å‘è¨€)</label>
                    <div class="conversation-turns">
                        <input type="text" class="form-control mb-2" name="scenarioTurn${scenarioCounter}_1" 
                               placeholder="ç¬¬1è½®ç”¨æˆ·å‘è¨€" required>
                        <input type="text" class="form-control mb-2" name="scenarioTurn${scenarioCounter}_2" 
                               placeholder="ç¬¬2è½®ç”¨æˆ·å‘è¨€">
                        <input type="text" class="form-control" name="scenarioTurn${scenarioCounter}_3" 
                               placeholder="ç¬¬3è½®ç”¨æˆ·å‘è¨€">
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', scenarioHtml);

            // Scroll to the new scenario
            const newScenario = container.lastElementChild;
            newScenario.scrollIntoView({ behavior: 'smooth', block: 'start' });

            console.log(`âœ… Added scenario ${scenarioCounter}`);
        }

        function removeScenario(scenarioNumber) {
            const scenarioElement = document.querySelector(`[data-scenario="${scenarioNumber}"]`);
            if (scenarioElement) {
                scenarioElement.remove();
                console.log('ğŸ—‘ï¸ Removed scenario:', scenarioNumber);
            }
        }

        function toggleEvaluationMode() {
            const autoMode = document.getElementById('autoMode').checked;
            const dynamicMode = document.getElementById('dynamicMode').checked;
            const manualMode = document.getElementById('manualMode').checked;

            const autoSection = document.getElementById('autoModeSection');
            const dynamicSection = document.getElementById('dynamicModeSection');
            const manualSection = document.getElementById('manualModeSection');
            const scenariosSection = document.getElementById('scenariosSection');

            // Hide all sections first
            autoSection.style.display = 'none';
            dynamicSection.style.display = 'none';
            manualSection.style.display = 'none';
            scenariosSection.style.display = 'none';

            // Clear any existing required attributes from scenario fields
            const scenarioInputs = document.querySelectorAll('input[name^="scenarioTitle"], input[name^="scenarioTurn"]');
            scenarioInputs.forEach(input => {
                input.removeAttribute('required');
            });

            if (autoMode) {
                autoSection.style.display = 'block';
                console.log('ğŸ¤– Switched to auto extraction mode');
            } else if (dynamicMode) {
                dynamicSection.style.display = 'block';
                console.log('ğŸ—£ï¸ Switched to dynamic conversation mode');
            } else if (manualMode) {
                manualSection.style.display = 'block';
                scenariosSection.style.display = 'block';

                // Create default scenario if container is empty
                const container = document.getElementById('scenariosContainer');
                if (container.children.length === 0) {
                    addDefaultScenario();
                }

                // Add required attributes to visible scenario fields
                const visibleScenarioInputs = document.querySelectorAll('#scenariosSection input[name^="scenarioTitle"], #scenariosSection input[name*="Turn"][name*="_1"]');
                visibleScenarioInputs.forEach(input => {
                    if (input.name.includes('Title') || input.name.includes('Turn') && input.name.endsWith('_1')) {
                        input.setAttribute('required', 'required');
                    }
                });

                console.log('âœ‹ Switched to manual configuration mode');
            }
        }

        async function extractPersona() {
            const fileInput = document.getElementById('requirementFile');
            const textInput = document.getElementById('requirementDoc');

            if (!fileInput.files.length && !textInput.value.trim()) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡æ¡£æˆ–è¾“å…¥æ–‡æ¡£å†…å®¹');
                return;
            }

            try {
                showLoading('DeepSeekæ­£åœ¨æ™ºèƒ½åˆ†æéœ€æ±‚æ–‡æ¡£...');

                const formData = new FormData();
                if (fileInput.files.length > 0) {
                    formData.append('requirement_file', fileInput.files[0]);
                }
                if (textInput.value.trim()) {
                    formData.append('requirement_text', textInput.value.trim());
                }

                const response = await fetch('/api/extract-user-persona', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();
                extractedPersonaData = result.extraction_result;

                hideLoading();
                displayExtractedPersona(result);

            } catch (error) {
                hideLoading();
                console.error('âŒ Persona extraction failed:', error);
                alert('ç”¨æˆ·ç”»åƒæå–å¤±è´¥: ' + error.message);
            }
        }

        function displayExtractedPersona(result) {
            // Create a new section to display the extracted persona
            const personaHtml = `
                <div class="alert-success-compact mt-3">
                    <h6><i class="fas fa-user-check"></i> ç”¨æˆ·ç”»åƒæå–æˆåŠŸ</h6>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>è§’è‰²ï¼š</strong>${result.extraction_result.user_persona.role}<br>
                            <strong>ç»éªŒï¼š</strong>${result.extraction_result.user_persona.experience_level}
                        </div>
                        <div class="col-md-6">
                            <strong>æ²Ÿé€šé£æ ¼ï¼š</strong>${result.extraction_result.user_persona.communication_style}<br>
                            <strong>å·¥ä½œç¯å¢ƒï¼š</strong>${result.extraction_result.user_persona.work_environment}
                        </div>
                    </div>
                </div>
            `;

            // Insert after the extract button
            const extractButton = document.querySelector('button[onclick="extractPersona()"]');
            extractButton.insertAdjacentHTML('afterend', personaHtml);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            console.log('ğŸš€ Starting evaluation submission...');

            try {
                showLoading('æ­£åœ¨å‡†å¤‡è¯„ä¼°æ•°æ®...');

                const formData = new FormData();

                // Get AI configuration
                const aiConfig = getAIConfiguration();
                console.log('ğŸ”§ AI Config:', aiConfig);
                formData.append('agent_api_config', JSON.stringify(aiConfig));

                // Determine evaluation mode
                const evaluationMode = document.getElementById('autoMode').checked ? 'auto' :
                    document.getElementById('dynamicMode').checked ? 'dynamic' : 'manual';
                formData.append('evaluation_mode', evaluationMode);

                console.log('ğŸ“Š Evaluation mode:', evaluationMode);

                // Handle different evaluation modes
                if (evaluationMode === 'dynamic') {
                    const fileInput = document.getElementById('dynamicRequirementFile');
                    const textInput = document.getElementById('dynamicRequirementDoc');

                    if (fileInput.files.length > 0) {
                        formData.append('requirement_file', fileInput.files[0]);
                        console.log('ğŸ“„ Adding dynamic file:', fileInput.files[0].name);
                    } else if (textInput.value.trim()) {
                        formData.append('requirement_text', textInput.value.trim());
                        console.log('ğŸ“ Adding dynamic text requirement');
                    } else {
                        throw new Error('åŠ¨æ€å¯¹è¯æ¨¡å¼éœ€è¦ä¸Šä¼ æ–‡æ¡£æˆ–è¾“å…¥æ–‡æ¡£å†…å®¹');
                    }

                    updateLoadingProgress('æ­£åœ¨æå–ç”¨æˆ·ç”»åƒå¹¶ç”ŸæˆåŠ¨æ€å¯¹è¯åœºæ™¯...');

                    const response = await fetch('/api/evaluate-agent-dynamic', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }

                    const result = await response.json();
                    console.log('âœ… Dynamic evaluation completed:', result);

                    hideLoading();
                    displayResults(result);

                } else if (evaluationMode === 'auto') {
                    // Auto mode logic
                    const fileInput = document.getElementById('requirementFile');
                    const textInput = document.getElementById('requirementDoc');

                    if (fileInput.files.length > 0) {
                        formData.append('requirement_file', fileInput.files[0]);
                    } else if (textInput.value.trim()) {
                        formData.append('requirement_text', textInput.value.trim());
                    } else {
                        throw new Error('æ™ºèƒ½æå–æ¨¡å¼éœ€è¦ä¸Šä¼ æ–‡æ¡£æˆ–è¾“å…¥æ–‡æ¡£å†…å®¹');
                    }

                    if (extractedPersonaData) {
                        formData.append('extracted_persona', JSON.stringify(extractedPersonaData));
                    }

                    updateLoadingProgress('æ­£åœ¨è¿›è¡Œæ™ºèƒ½è¯„ä¼°...');

                    const response = await fetch('/api/evaluate-agent-auto', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }

                    const result = await response.json();
                    console.log('âœ… Auto evaluation completed:', result);

                    hideLoading();
                    displayResults(result);

                } else {
                    // Manual mode logic
                    const scenarios = collectScenariosData();
                    formData.append('scenarios', JSON.stringify(scenarios));

                    const userRole = document.getElementById('userRole').value;
                    const experienceLevel = document.getElementById('experienceLevel').value;
                    const communicationStyle = document.getElementById('communicationStyle').value;

                    const userPersona = {
                        role: userRole,
                        experience_level: experienceLevel,
                        communication_style: communicationStyle
                    };

                    formData.append('user_persona', JSON.stringify(userPersona));

                    updateLoadingProgress('æ­£åœ¨è¿›è¡Œæ‰‹åŠ¨é…ç½®è¯„ä¼°...');

                    const response = await fetch('/api/evaluate-agent', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }

                    const result = await response.json();
                    console.log('âœ… Manual evaluation completed:', result);

                    hideLoading();
                    displayResults(result);
                }

            } catch (error) {
                hideLoading();
                console.error('âŒ Evaluation failed:', error);
                alert('è¯„ä¼°å¤±è´¥: ' + error.message);
            }
        }

        function collectScenariosData() {
            const scenarios = [];
            const scenarioElements = document.querySelectorAll('[data-scenario]');

            scenarioElements.forEach(element => {
                const scenarioNumber = element.getAttribute('data-scenario');
                const title = document.querySelector(`input[name="scenarioTitle${scenarioNumber}"]`)?.value || '';
                const context = document.querySelector(`input[name="scenarioContext${scenarioNumber}"]`)?.value || '';
                const profile = document.querySelector(`input[name="scenarioProfile${scenarioNumber}"]`)?.value || '';

                const turns = [];
                for (let i = 1; i <= 3; i++) {
                    const turn = document.querySelector(`input[name="scenarioTurn${scenarioNumber}_${i}"]`)?.value;
                    if (turn && turn.trim()) {
                        turns.push(turn.trim());
                    }
                }

                if (title && turns.length > 0) {
                    scenarios.push({
                        title,
                        context,
                        user_profile: profile,
                        conversation_turns: turns
                    });
                }
            });

            return scenarios;
        }

        function getAIConfiguration() {
            if (document.getElementById('cozeAgentConfig').style.display !== 'none') {
                const agentId = document.getElementById('cozeAgentId').value;
                const token = document.getElementById('cozeAgentToken').value;
                const region = document.getElementById('cozeRegion').value;

                if (!agentId || !token) {
                    throw new Error('è¯·å¡«å†™å®Œæ•´çš„ Coze Agent é…ç½®ä¿¡æ¯');
                }

                return {
                    type: 'coze-agent',
                    url: region === 'global' ? 'https://api.coze.com/open_api/v2/chat' : 'https://api.coze.cn/open_api/v2/chat',
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    agentId: agentId,
                    region: region,
                    timeout: 30
                };
            } else if (document.getElementById('cozeBotConfig').style.display !== 'none') {
                const botId = document.getElementById('cozeBotIdNew').value;
                const botVersion = document.getElementById('cozeBotVersion').value;

                if (!botId) {
                    throw new Error('è¯·å¡«å†™ Coze Bot ID');
                }

                return {
                    type: 'coze-bot',
                    url: 'https://api.coze.cn/open_api/v2/chat',
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer pat_aWWxLQe20D8km5FsKt5W99pWL72L5LNxjkontH91q3lqqTU0ExBKUBl1cUy4tm8c',
                        'Content-Type': 'application/json'
                    },
                    botId: botId,
                    botVersion: botVersion || 'latest',
                    timeout: 30
                };
            } else if (document.getElementById('customApiConfig').style.display !== 'none') {
                const apiUrl = document.getElementById('apiUrl').value;
                const apiMethod = document.getElementById('apiMethod').value;
                const headersText = document.getElementById('apiHeaders').value;

                if (!apiUrl) {
                    throw new Error('è¯·å¡«å†™ API URL');
                }

                let headers = { 'Content-Type': 'application/json' };
                if (headersText.trim()) {
                    try {
                        headers = { ...headers, ...JSON.parse(headersText) };
                    } catch (e) {
                        throw new Error('è¯·æ±‚å¤´æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨æœ‰æ•ˆçš„ JSON æ ¼å¼');
                    }
                }

                return {
                    type: 'custom-api',
                    url: apiUrl,
                    method: apiMethod,
                    headers: headers,
                    timeout: 30
                };
            }

            throw new Error('è¯·é€‰æ‹©å¹¶é…ç½®ä¸€ç§AIç³»ç»Ÿç±»å‹');
        }

        function showLoading(message) {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function updateLoadingProgress(message) {
            document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function generateStarRating(score) {
            const fullStars = Math.floor(score);
            const hasHalfStar = score % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            return 'â˜…'.repeat(fullStars) +
                (hasHalfStar ? 'â˜†' : '') +
                'â˜†'.repeat(emptyStars);
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContent');
            const summary = data.evaluation_summary;
            const records = data.conversation_records || [];
            const evaluationMode = data.evaluation_mode || 'manual';
            const userPersonaInfo = data.user_persona_info;

            // Generate overall score visualization
            const overallScore = summary.overall_score || 0;
            const starsHtml = generateStarRating(overallScore);

            // Generate dimensions cards
            const dimensions = summary.dimensions || {};
            const dimensionCards = Object.entries(dimensions).map(([key, value]) => {
                const labels = {
                    'fuzzy_understanding': 'ğŸ” æ¨¡ç³Šç†è§£',
                    'answer_correctness': 'âœ… å›ç­”å‡†ç¡®æ€§',
                    'persona_alignment': 'ğŸ‘¥ ç”¨æˆ·åŒ¹é…',
                    'goal_alignment': 'ğŸ¯ ç›®æ ‡å¯¹é½'
                };

                const label = labels[key] || key;
                const stars = generateStarRating(value);

                return `
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="dimension-card">
                            <h6>${label}</h6>
                            <div class="h4 text-primary">${value.toFixed(1)}</div>
                            <div class="star-rating">${stars}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Generate conversation records with collapsible UI
            const conversationHtml = records.map((record, index) => {
                const scenario = record.scenario || {};
                const history = record.conversation_history || [];
                const evaluationScores = record.evaluation_scores_with_explanations || record.evaluation_scores || {};

                // Generate conversation content
                const conversationContent = history.map((turn, turnIndex) => {
                    const userMessage = turn.user_message || turn.content;
                    const aiMessage = turn.ai_response || turn.ai_message;

                    return `
                        <div class="conversation-turn">
                            <div class="user-message">
                                <strong>ğŸ‘¤ ç”¨æˆ· (ç¬¬${turnIndex + 1}è½®):</strong> ${userMessage}
                            </div>
                            <div class="ai-response">
                                <strong>ğŸ¤– AIå›å¤:</strong> ${aiMessage}
                            </div>
                        </div>
                    `;
                }).join('');

                // Generate scores with explanations
                const scoresHtml = Object.entries(evaluationScores).map(([key, scoreData]) => {
                    const isNewFormat = typeof scoreData === 'object' && scoreData.score !== undefined;
                    const score = isNewFormat ? scoreData.score : scoreData;
                    const explanation = isNewFormat ? scoreData.explanation : 'æš‚æ— è¯¦ç»†åˆ†æ';

                    const labels = {
                        'fuzzy_understanding': 'æ¨¡ç³Šç†è§£',
                        'answer_correctness': 'å›ç­”å‡†ç¡®æ€§',
                        'persona_alignment': 'ç”¨æˆ·åŒ¹é…',
                        'goal_alignment': 'ç›®æ ‡å¯¹é½'
                    };

                    const label = labels[key] || key;
                    const scoreColor = score >= 4 ? 'success' : score >= 3 ? 'warning' : 'danger';

                    return `
                        <div class="mb-2">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-${scoreColor} me-2">${label}: ${score}/5</span>
                                <button class="btn btn-sm btn-outline-info" type="button" onclick="toggleExplanation('explanation-${index}-${key}')">
                                    <i class="fas fa-info-circle"></i> è¯¦ç»†åˆ†æ
                                </button>
                            </div>
                            <div id="explanation-${index}-${key}" class="alert-info-compact" style="display: none;">
                                <small>${explanation}</small>
                            </div>
                        </div>
                    `;
                }).join('');

                const scenarioScore = record.scenario_score || 0;

                return `
                    <div class="conversation-section">
                        <div class="conversation-header" onclick="toggleConversation('conversation-${index}')">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-comment-dots"></i> ${scenario.title || `åœºæ™¯ ${index + 1}`}</h6>
                                <small class="text-muted">${history.length} è½®å¯¹è¯ â€¢ å¾—åˆ†: ${scenarioScore.toFixed(1)}/5.0</small>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="conversation-${index}" class="conversation-content" style="display: none;">
                            <div class="mb-3">
                                <h6><i class="fas fa-chart-line"></i> è¯„ä¼°ç»´åº¦</h6>
                                ${scoresHtml}
                            </div>
                            <div>
                                <h6><i class="fas fa-comments"></i> å¯¹è¯è®°å½•</h6>
                                ${conversationContent}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsContainer.innerHTML = `
                <!-- Overall Score Section -->
                <div class="text-center mb-4">
                    <div class="overall-score">${overallScore.toFixed(1)}</div>
                    <div class="star-rating">${starsHtml}</div>
                    <p class="lead">ç»¼åˆè¯„ä¼°å¾—åˆ†</p>
                </div>

                <!-- Dimensions Grid -->
                <div class="row mb-4">
                    ${dimensionCards}
                </div>

                <!-- Conversation Records -->
                <div class="mb-4">
                    <h5><i class="fas fa-history"></i> è¯¦ç»†è¯„ä¼°è®°å½•</h5>
                    ${conversationHtml}
                </div>
            `;

            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function toggleConversation(conversationId) {
            const content = document.getElementById(conversationId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.fas');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function toggleExplanation(explanationId) {
            const element = document.getElementById(explanationId);
            if (element.style.display === 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }
    </script>
</body>

</html>