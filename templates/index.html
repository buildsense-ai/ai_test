<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Agent Ëá™Âä®ÂåñËØÑ‰º∞Âπ≥Âè∞ v4.0</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --surface-color: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --compact-padding: 20px;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            line-height: 1.5;
        }

        .main-container {
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin: 20px auto;
            max-width: 1200px;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .header h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 2rem;
        }

        .header .lead {
            color: #6b7280;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        /* Collapsible Card System */
        .collapsible-card {
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 1.1rem;
        }

        .collapsible-toggle {
            color: #6b7280;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .collapsible-toggle.rotated {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: var(--compact-padding);
            transition: all 0.3s ease;
        }

        .collapsible-content.collapsed {
            display: none;
        }

        /* Compact Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .info-card:hover {
            border-color: var(--info-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .info-card.active {
            border-color: var(--info-color);
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .info-card i {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--info-color);
        }

        .info-card h6 {
            font-weight: 600;
            margin-bottom: 5px;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .info-card small {
            color: #6b7280;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* Compact Form Sections */
        .config-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .config-section h6 {
            color: #374151;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Compact Forms */
        .compact-form .row {
            margin-bottom: 12px;
        }

        .compact-form .form-control,
        .compact-form .form-select {
            padding: 8px 12px;
            font-size: 0.9rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .compact-form .form-control:focus,
        .compact-form .form-select:focus {
            border-color: var(--info-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .compact-form .form-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        /* Compact Alerts */
        .alert-compact {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            border: none;
        }

        .alert-info-compact {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: #1e40af;
            border-left: 3px solid var(--info-color);
        }

        .alert-success-compact {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #065f46;
            border-left: 3px solid var(--success-color);
        }

        .alert-warning-compact {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #92400e;
            border-left: 3px solid var(--warning-color);
        }

        /* Mode Selection - Inline */
        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .mode-option {
            flex: 1;
            min-width: 200px;
        }

        .mode-option .form-check {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-option .form-check:hover {
            border-color: var(--info-color);
            background: #eff6ff;
        }

        .mode-option .form-check-input:checked~.form-check-label {
            color: var(--info-color);
        }

        /* Compact File Upload */
        .file-upload-compact {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .file-upload-compact:hover {
            border-color: var(--info-color);
            background: #eff6ff;
        }

        .file-upload-compact i {
            font-size: 1.5rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .file-upload-compact h6 {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .file-upload-compact p {
            font-size: 0.8rem;
            margin-bottom: 0;
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #334155;
        }

        /* Results Section - Compact */
        .results-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--card-shadow);
        }

        .dimension-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
        }

        .dimension-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .overall-score {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .star-rating {
            color: #fbbf24;
            font-size: 1.1rem;
            margin: 10px 0;
            letter-spacing: 1px;
        }

        /* Conversation Display - Collapsible */
        .conversation-section {
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        .conversation-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .conversation-header:hover {
            background: #f1f5f9;
        }

        .conversation-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .conversation-turn {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--info-color);
            font-size: 0.85rem;
        }

        .user-message {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left-color: var(--info-color);
        }

        .ai-response {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left-color: var(--success-color);
        }

        /* Enhanced Analysis Styles */
        .detailed-analysis-panel {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 8px;
        }

        .analysis-content,
        .quotes-content,
        .suggestions-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .quotes-content {
            font-style: italic;
            border-left: 3px solid #17a2b8;
            padding-left: 10px;
        }

        .stat-card {
            transition: transform 0.2s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .summary-overview .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .conversation-turn {
            transition: all 0.2s;
            border-radius: 8px;
        }

        .conversation-turn:hover {
            background-color: #f8f9fa;
            padding: 15px;
        }

        .message-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Enhanced explanation chain styles */
        .explanation-chain {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }

        .explanation-section {
            margin-bottom: 15px;
        }

        .explanation-content {
            padding: 10px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 6px;
        }

        .quotes-content {
            font-style: italic;
            background: rgba(34, 197, 94, 0.05);
        }

        .suggestions-content {
            padding: 10px;
            background: rgba(245, 158, 11, 0.05);
            border-radius: 6px;
        }

        /* JSON section styles */
        .collapsible-card pre {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .collapsible-card code {
            color: #374151;
        }

        /* Enhanced JSON display styles */
        .json-organized {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }

        .json-scenario {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .json-subsection {
            background: #f1f5f9;
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .conversation-json-turn {
            font-size: 0.9rem;
            border-left: 3px solid #3b82f6;
            padding-left: 8px;
            margin-bottom: 8px;
        }

        /* Fine-grained scoring visual indicators */
        .badge.bg-success {
            background-color: #10b981 !important;
        }

        .badge.bg-warning {
            background-color: #f59e0b !important;
        }

        .badge.bg-danger {
            background-color: #ef4444 !important;
        }

        .badge.bg-secondary {
            background-color: #6b7280 !important;
        }

        /* Star rating improvements for fine-grained scoring */
        .star-rating {
            font-size: 1.1rem;
            color: #fbbf24;
            letter-spacing: 1px;
        }

        /* Complete Report Specific Styles */
        .complete-report-container {
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .conversation-record-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .conversation-turn-complete {
            transition: all 0.3s ease;
        }

        .conversation-turn-complete:hover {
            background-color: #f8f9fa !important;
            border-color: #007bff !important;
        }

        .dimension-analysis-card {
            transition: all 0.3s ease;
        }

        .dimension-analysis-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .full-response-content pre {
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .scenario-score-overview .progress {
            height: 6px;
        }

        .turn-header .badge {
            font-size: 0.75rem;
        }

        /* Enhanced collapsible styles */
        .collapsible-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .stat-number {
                font-size: 1.5rem;
            }

            .collapsible-title {
                font-size: 1rem;
            }

            .dimension-analysis-card .row {
                margin: 0;
            }

            .dimension-analysis-card .col-md-6 {
                padding-left: 5px;
                padding-right: 5px;
            }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 300px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .spinner-custom {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--info-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 20px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .mode-selector {
                flex-direction: column;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-brain"></i> AI Agent Ëá™Âä®ÂåñËØÑ‰º∞Âπ≥Âè∞</h1>
                <p class="lead">Âü∫‰∫éDeepSeekÊô∫ËÉΩÂºïÊìéÁöÑ‰∏ì‰∏öAI‰ª£ÁêÜËØÑ‰º∞Á≥ªÁªü</p>
                <p class="subtitle">ÊîØÊåÅÂ§öÂπ≥Âè∞API ‚Ä¢ ÊñáÊ°£Êô∫ËÉΩËß£Êûê ‚Ä¢ 4Áª¥Â∫¶ËØÑ‰º∞Ê°ÜÊû∂ ‚Ä¢ Â∑•‰ΩúÊµÅÂÖºÂÆπ</p>
            </div>

            <!-- AI Type Selection - Collapsible -->
            <div class="collapsible-card">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-title">
                        <i class="fas fa-lightbulb"></i>
                        AIÁ≥ªÁªü‰ø°ÊÅØÊåáÂçó
                    </div>
                    <i class="fas fa-chevron-down collapsible-toggle"></i>
                </div>
                <div class="collapsible-content">
                    <div class="info-grid">
                        <div class="info-card" data-type="coze-agent" onclick="selectAIType(event)">
                            <i class="fas fa-robot"></i>
                            <h6>Coze AI Agent</h6>
                            <small>Êô∫ËÉΩ‰ª£ÁêÜÔºåÊîØÊåÅÂ∑•ÂÖ∑Ë∞ÉÁî®</small>
                        </div>
                        <div class="info-card" data-type="coze-bot" onclick="selectAIType(event)">
                            <i class="fas fa-comments"></i>
                            <h6>Coze Bot</h6>
                            <small>‰º†ÁªüËÅäÂ§©Êú∫Âô®‰∫∫</small>
                        </div>
                        <div class="info-card" data-type="custom-api" onclick="selectAIType(event)">
                            <i class="fas fa-code"></i>
                            <h6>Ëá™ÂÆö‰πâ API</h6>
                            <small>ÂÖ∂‰ªñAIÊúçÂä°</small>
                        </div>
                    </div>
                    <div class="alert-info-compact">
                        <strong><i class="fas fa-comment-dots"></i> Ê≤üÈÄöËØùÊúØÔºö</strong>
                        "ÊàëÈúÄË¶ÅÊµãËØï‰Ω†‰ª¨ÁöÑAIÁ≥ªÁªüÊÄßËÉΩÔºåËÉΩÊèê‰æõ‰∏Ä‰∏ãÁõ∏ÂÖ≥ÁöÑÈÖçÁΩÆ‰ø°ÊÅØÂêóÔºü"
                    </div>
                </div>
            </div>

            <!-- Main Form -->
            <form id="evaluationForm" enctype="multipart/form-data" class="compact-form">

                <!-- AI Configuration - Collapsible -->
                <div class="collapsible-card">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title">
                            <i class="fas fa-cog"></i>
                            AIÁ≥ªÁªüÈÖçÁΩÆ
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle"></i>
                    </div>
                    <div class="collapsible-content">
                        <!-- Coze Agent Config -->
                        <div id="cozeAgentConfig" class="config-section">
                            <h6><i class="fas fa-robot"></i> Coze Agent ÈÖçÁΩÆ</h6>
                            <div class="alert-info-compact">
                                <i class="fas fa-info-circle"></i> Á°Æ‰øùAgentÂ∑≤ÂèëÂ∏É‰∏îÂ§Ñ‰∫éÊ¥ªË∑ÉÁä∂ÊÄÅ
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="cozeAgentId" class="form-label">Agent ID *</label>
                                    <input type="text" class="form-control" id="cozeAgentId" name="cozeAgentId"
                                        value="7498244859505999924" placeholder="AgentÂîØ‰∏ÄÊ†áËØÜ">
                                </div>
                                <div class="col-md-6">
                                    <label for="cozeAgentToken" class="form-label">Access Token *</label>
                                    <input type="password" class="form-control" id="cozeAgentToken"
                                        name="cozeAgentToken"
                                        value="pat_DiraOZEjagK8c6NNPJKionQsCj99zZduVyGkYO8YojolSQ8WAjBdF2CgbXNLMaFi"
                                        placeholder="APIËÆøÈóÆ‰ª§Áâå">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="cozeRegion" class="form-label">Âπ≥Âè∞ÁâàÊú¨</label>
                                    <select class="form-select" id="cozeRegion" name="cozeRegion">
                                        <option value="global">Global (coze.com)</option>
                                        <option value="china" selected>China (coze.cn)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Coze Bot Config -->
                        <div id="cozeBotConfig" class="config-section" style="display: none;">
                            <h6><i class="fas fa-comments"></i> Coze Bot ÈÖçÁΩÆ</h6>
                            <div class="alert-success-compact">
                                <i class="fas fa-check-circle"></i> Â∑≤È¢ÑÈÖçÁΩÆÂ∑•Á®ãËßÑËåÉAIÂä©Êâã
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="cozeBotIdNew" class="form-label">Bot ID *</label>
                                    <input type="text" class="form-control" id="cozeBotIdNew" name="cozeBotIdNew"
                                        value="7511993619423985674" placeholder="BotÂîØ‰∏ÄÊ†áËØÜ">
                                </div>
                                <div class="col-md-4">
                                    <label for="cozeBotVersion" class="form-label">BotÁâàÊú¨ (ÂèØÈÄâ)</label>
                                    <input type="text" class="form-control" id="cozeBotVersion" name="cozeBotVersion"
                                        placeholder="latest">
                                </div>
                            </div>
                        </div>

                        <!-- Custom API Config -->
                        <div id="customApiConfig" class="config-section" style="display: none;">
                            <h6><i class="fas fa-code"></i> Ëá™ÂÆö‰πâ API ÈÖçÁΩÆ</h6>
                            <div class="alert-warning-compact">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>ÈáçË¶ÅÔºö</strong>ËØ∑ÂàÜÂà´Â°´ÂÜôÂêÑ‰∏™Â≠óÊÆµÔºå‰∏çË¶ÅÂú®"ËØ∑Ê±ÇÂ§¥"‰∏≠Á≤òË¥¥ÂÆåÊï¥ÈÖçÁΩÆÔºÅ
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="apiUrl" class="form-label">API URL *</label>
                                    <input type="url" class="form-control" id="apiUrl" name="apiUrl"
                                        placeholder="https://api.example.com/chat">
                                    <small class="text-muted">Á§∫‰æã: https://api.openai.com/v1/chat/completions</small>
                                </div>
                                <div class="col-md-4">
                                    <label for="apiMethod" class="form-label">HTTPÊñπÊ≥ï</label>
                                    <select class="form-select" id="apiMethod" name="apiMethod">
                                        <option value="POST" selected>POST</option>
                                        <option value="GET">GET</option>
                                        <option value="PUT">PUT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <label for="apiHeaders" class="form-label">ËØ∑Ê±ÇÂ§¥ (JSONÊ†ºÂºè)</label>
                                    <textarea class="form-control" id="apiHeaders" name="apiHeaders" rows="2"
                                        placeholder='{"Authorization": "Bearer your-token"}'></textarea>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Ê≥®ÊÑèÔºö</strong>‰ªÖÂ°´ÂÜôËØ∑Ê±ÇÂ§¥‰ø°ÊÅØÔºåÂ¶ÇËÆ§ËØÅtokenÁ≠â„ÄÇ‰∏çË¶ÅÁ≤òË¥¥ÂÆåÊï¥ÁöÑAPIÈÖçÁΩÆÔºÅ
                                        <br>Ê≠£Á°ÆÁ§∫‰æã: {"Authorization": "Bearer sk-...", "X-API-Key": "your-key"}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Requirement Document -->
                <div class="section-card">
                    <h5 class="section-title">
                        <i class="fas fa-user-tie"></i>
                        Áî®Êà∑ÁîªÂÉè‰∏éÈúÄÊ±ÇÊñáÊ°£ÈÖçÁΩÆ
                    </h5>

                    <!-- Mode Selection -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-cogs"></i>
                            ÈÄâÊã©ÈÖçÁΩÆÊñπÂºè
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="evaluationMode" id="autoMode"
                                        value="auto">
                                    <label class="form-check-label" for="autoMode">
                                        <strong>ü§ñ Êô∫ËÉΩÊèêÂèñ</strong><br>
                                        <small>Ëá™Âä®ÊèêÂèñÁî®Êà∑ÁîªÂÉè</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="evaluationMode" id="dynamicMode"
                                        value="dynamic" checked>
                                    <label class="form-check-label" for="dynamicMode">
                                        <strong>üó£Ô∏è Âä®ÊÄÅÂØπËØù</strong><br>
                                        <small>ÁúüÂÆûÂØπËØùÊµÅÁ®ã</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="evaluationMode" id="manualMode"
                                        value="manual">
                                    <label class="form-check-label" for="manualMode">
                                        <strong>‚úã ÊâãÂä®ÈÖçÁΩÆ</strong><br>
                                        <small>Ëá™ÂÆö‰πâÂú∫ÊôØ</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Mode Section -->
                    <div id="dynamicModeSection">
                        <div class="alert-success-compact">
                            <i class="fas fa-comments"></i> ‰∏ä‰º†ÈúÄÊ±ÇÊñáÊ°£ÔºåËá™Âä®ÊèêÂèñÁî®Êà∑ÁîªÂÉèÔºåÁîüÊàê2‰∏™ÊµãËØïÂú∫ÊôØ
                        </div>

                        <!-- File Upload -->
                        <div class="file-upload-compact"
                            onclick="document.getElementById('dynamicRequirementFile').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h6>ÁÇπÂáª‰∏ä‰º†ÈúÄÊ±ÇÊñáÊ°£</h6>
                            <p class="text-muted">ÊîØÊåÅ Word (.docx) ‚Ä¢ PDF (.pdf) ‚Ä¢ ÊñáÊú¨ (.txt)</p>
                            <input type="file" class="d-none" id="dynamicRequirementFile" name="dynamicRequirementFile"
                                accept=".doc,.docx,.pdf,.txt" onchange="handleDynamicFileUpload(this)">
                        </div>

                        <div id="dynamicFileUploadStatus" style="display: none;" class="alert-success-compact">
                            <i class="fas fa-file-check"></i> <span id="dynamicUploadedFileName"></span> Â∑≤ÊàêÂäü‰∏ä‰º†
                        </div>

                        <!-- Text Input Alternative -->
                        <div>
                            <label for="dynamicRequirementDoc" class="form-label">ÊàñÁõ¥Êé•ËæìÂÖ•ÈúÄÊ±ÇÊñáÊ°£ÂÜÖÂÆπ</label>
                            <textarea class="form-control" id="dynamicRequirementDoc" name="dynamicRequirementDoc"
                                rows="3" placeholder="‰æãÔºöÁõëÁêÜÂ∑•Á®ãÂ∏àÈúÄË¶ÅAIËØÜÂà´Áî®Êà∑Ê®°Á≥äÊèèËø∞Âπ∂‰∏ªÂä®ÂºïÂØºË°•ÂÖÖÈù¢ÁßØ„ÄÅ‰ΩçÁΩÆÁ≠âÂ≠óÊÆµ..."></textarea>
                        </div>
                    </div>

                    <!-- Auto Mode Section -->
                    <div id="autoModeSection" style="display: none;">
                        <div class="alert-info-compact">
                            <i class="fas fa-magic"></i> DeepSeekÂ∞ÜËá™Âä®ÂàÜÊûêÂπ∂ÊèêÂèñÁî®Êà∑ËßíËâ≤„ÄÅ‰ΩøÁî®Âú∫ÊôØ„ÄÅÊ≤üÈÄöÈ£éÊ†ºÁ≠â‰ø°ÊÅØ
                        </div>

                        <div class="file-upload-compact" onclick="document.getElementById('requirementFile').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h6>‰∏ä‰º†ÈúÄÊ±ÇÊñáÊ°£</h6>
                            <p class="text-muted">ÊîØÊåÅ Word (.docx) ‚Ä¢ PDF (.pdf) ‚Ä¢ ÊñáÊú¨ (.txt)</p>
                            <input type="file" class="d-none" id="requirementFile" name="requirementFile"
                                accept=".doc,.docx,.pdf,.txt" onchange="handleFileUpload(this)">
                        </div>

                        <div id="fileUploadStatus" style="display: none;" class="alert-success-compact">
                            <i class="fas fa-file-check"></i> <span id="uploadedFileName"></span> Â∑≤ÊàêÂäü‰∏ä‰º†
                        </div>

                        <div>
                            <label for="requirementDoc" class="form-label">ÊàñÁõ¥Êé•ËæìÂÖ•ÈúÄÊ±ÇÊñáÊ°£ÂÜÖÂÆπ</label>
                            <textarea class="form-control" id="requirementDoc" name="requirementDoc" rows="3"
                                placeholder="ËæìÂÖ•ËØ¶ÁªÜÁöÑÈúÄÊ±ÇÊñáÊ°£ÂÜÖÂÆπ..."></textarea>
                        </div>

                        <button type="button" class="btn btn-secondary mt-2" onclick="extractPersona()">
                            <i class="fas fa-user-cog"></i> ÊèêÂèñÁî®Êà∑ÁîªÂÉè
                        </button>
                    </div>

                    <!-- Manual Mode Section -->
                    <div id="manualModeSection" style="display: none;">
                        <div class="alert-info-compact">
                            <i class="fas fa-edit"></i> ÊâãÂä®ÈÖçÁΩÆÁî®Êà∑ÁîªÂÉèÂíåÂØπËØùÂú∫ÊôØ
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="userRole" class="form-label">Áî®Êà∑ËßíËâ≤</label>
                                <input type="text" class="form-control" id="userRole" name="userRole"
                                    placeholder="Â¶ÇÔºöÁé∞Âú∫ÁõëÁêÜÂ∑•Á®ãÂ∏à">
                            </div>
                            <div class="col-md-6">
                                <label for="experienceLevel" class="form-label">ÁªèÈ™åÊ∞¥Âπ≥</label>
                                <input type="text" class="form-control" id="experienceLevel" name="experienceLevel"
                                    placeholder="Â¶ÇÔºö5Âπ¥Â∑•Á®ãÁªèÈ™å">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label for="communicationStyle" class="form-label">Ê≤üÈÄöÈ£éÊ†º</label>
                                <input type="text" class="form-control" id="communicationStyle"
                                    name="communicationStyle" placeholder="Â¶ÇÔºöÂÅèÂ•ΩÁÆÄÊ¥ÅÊòé‰∫Ü">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Scenarios Section -->
                <div id="scenariosSection" style="display: none;">
                    <div class="collapsible-card">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div class="collapsible-title">
                                <i class="fas fa-comments"></i>
                                ÂØπËØùÂú∫ÊôØÈÖçÁΩÆ
                            </div>
                            <i class="fas fa-chevron-down collapsible-toggle"></i>
                        </div>
                        <div class="collapsible-content">
                            <div id="scenariosContainer">
                                <!-- Default scenario will be added by JavaScript -->
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addScenario()">
                                <i class="fas fa-plus"></i> Ê∑ªÂä†Âú∫ÊôØ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-play"></i> ÂºÄÂßãËØÑ‰º∞
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line"></i> ËØÑ‰º∞ÁªìÊûú
                    </h4>
                    <div class="btn-group" role="group" aria-label="Download options">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="inspectDataStructure()">
                            <i class="fas fa-search"></i> Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑ
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadReport('json')">
                            <i class="fas fa-download"></i> JSON
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadReport('txt')">
                            <i class="fas fa-file-alt"></i> TXT
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadReport('docx')">
                            <i class="fas fa-file-word"></i> DOCX
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-cog"></i> ÈÄâÈ°π
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <div class="form-check dropdown-item">
                                        <input class="form-check-input" type="checkbox" id="includeTranscript">
                                        <label class="form-check-label" for="includeTranscript">
                                            ÂåÖÂê´ÂØπËØùËÆ∞ÂΩï
                                        </label>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-custom"></div>
            <h6 id="loadingText">Ê≠£Âú®ËØÑ‰º∞‰∏≠...</h6>
            <p class="text-muted mb-0" id="loadingSubtext">ËØ∑Á®çÂÄôÔºåËøôÂèØËÉΩÈúÄË¶ÅÂá†ÂàÜÈíü</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let scenarioCounter = 1;
        let extractedPersonaData = null;
        let currentEvaluationData = null; // Store evaluation data for download

        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ AI AgentËØÑ‰º∞Âπ≥Âè∞Â∑≤Âä†ËΩΩ');

            // Initialize form
            const form = document.getElementById('evaluationForm');
            form.addEventListener('submit', handleFormSubmit);

            // Prevent form submission on Enter
            const inputs = form.querySelectorAll('input[type="text"], input[type="url"], input[type="password"]');
            inputs.forEach(input => {
                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                });
            });

            // Set default AI type and collapse all sections
            const firstAICard = document.querySelector('.info-card[data-type="coze-agent"]');
            if (firstAICard) {
                selectAIType({ target: firstAICard });
            }

            // Add mode switching listeners
            document.getElementById('autoMode').addEventListener('change', toggleEvaluationMode);
            document.getElementById('manualMode').addEventListener('change', toggleEvaluationMode);
            document.getElementById('dynamicMode').addEventListener('change', toggleEvaluationMode);

            // Add headers validation for custom API config
            const apiHeadersField = document.getElementById('apiHeaders');
            if (apiHeadersField) {
                apiHeadersField.addEventListener('input', validateApiHeaders);
                apiHeadersField.addEventListener('paste', handleHeadersPaste);
            }

            // Initialize evaluation mode (don't create scenarios yet)
            toggleEvaluationMode();

            // Collapse all sections by default except the first one
            const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
            collapsibleHeaders.forEach((header, index) => {
                if (index > 0 && header) { // Keep first section open and check if header exists
                    toggleCollapsible(header, true);
                }
            });

            // Add timeout protection for all fetch requests
            function createTimeoutSignal(timeoutMs) {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), timeoutMs);
                return controller.signal;
            }
        });

        // Collapsible functionality
        function toggleCollapsible(header, forceClose = false) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.collapsible-toggle');

            if (forceClose || !content.classList.contains('collapsed')) {
                content.classList.add('collapsed');
                toggle.classList.remove('rotated');
            } else {
                content.classList.remove('collapsed');
                toggle.classList.add('rotated');
            }
        }

        function selectAIType(eventOrElement) {
            let targetElement;
            if (eventOrElement && eventOrElement.target) {
                targetElement = eventOrElement.target.closest('.info-card');
            } else if (eventOrElement && eventOrElement.classList) {
                targetElement = eventOrElement.closest('.info-card');
            } else {
                console.error('‚ùå Invalid argument passed to selectAIType');
                return;
            }

            if (!targetElement) {
                console.error('‚ùå Could not find info-card element');
                return;
            }

            const aiType = targetElement.getAttribute('data-type');
            console.log('üîß Selecting AI type:', aiType);

            // Remove all required attributes first
            document.querySelectorAll('#cozeAgentId, #cozeAgentToken, #cozeBotIdNew, #apiUrl').forEach(input => {
                input.removeAttribute('required');
            });

            // Hide all configuration sections
            document.getElementById('cozeAgentConfig').style.display = 'none';
            document.getElementById('cozeBotConfig').style.display = 'none';
            document.getElementById('customApiConfig').style.display = 'none';

            // Remove active states from all cards
            document.querySelectorAll('.info-card').forEach(card => {
                card.classList.remove('active');
            });

            // Show the selected configuration and add required attributes
            if (aiType === 'coze-agent') {
                document.getElementById('cozeAgentConfig').style.display = 'block';
                document.getElementById('cozeAgentId').setAttribute('required', 'required');
                document.getElementById('cozeAgentToken').setAttribute('required', 'required');
                console.log('‚úÖ Coze Agent config shown');
            } else if (aiType === 'coze-bot') {
                document.getElementById('cozeBotConfig').style.display = 'block';
                document.getElementById('cozeBotIdNew').setAttribute('required', 'required');
                console.log('‚úÖ Coze Bot config shown');
            } else if (aiType === 'custom-api') {
                document.getElementById('customApiConfig').style.display = 'block';
                document.getElementById('apiUrl').setAttribute('required', 'required');
                console.log('‚úÖ Custom API config shown');
            }

            // Mark the selected card as active
            targetElement.classList.add('active');
        }

        function handleFileUpload(input) {
            if (input.files.length > 0) {
                const fileName = input.files[0].name;
                document.getElementById('uploadedFileName').textContent = fileName;
                document.getElementById('fileUploadStatus').style.display = 'block';
                console.log('üìÑ File uploaded:', fileName);
            }
        }

        function handleDynamicFileUpload(input) {
            if (input.files.length > 0) {
                const fileName = input.files[0].name;
                document.getElementById('dynamicUploadedFileName').textContent = fileName;
                document.getElementById('dynamicFileUploadStatus').style.display = 'block';
                console.log('üìÑ Dynamic file uploaded:', fileName);
            }
        }

        function addDefaultScenario() {
            const container = document.getElementById('scenariosContainer');
            const scenarioHtml = `
                <div class="scenario-card config-section" data-scenario="1">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-comments"></i>
                            Âú∫ÊôØ 1: ÈªòËÆ§Âú∫ÊôØ
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeScenario(1)">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Âú∫ÊôØÊ†áÈ¢ò</label>
                            <input type="text" class="form-control" name="scenarioTitle1" 
                                   value="ÈªòËÆ§ÊµãËØïÂú∫ÊôØ" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">‰∏öÂä°‰∏ä‰∏ãÊñá</label>
                            <input type="text" class="form-control" name="scenarioContext1" 
                                   placeholder="Â¶ÇÔºöÂª∫Á≠ëÂ∑•Âú∞„ÄÅÊ°•Ê¢ÅÁé∞Âú∫Á≠â">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Áî®Êà∑ÁîªÂÉè</label>
                            <input type="text" class="form-control" name="scenarioProfile1" 
                                   placeholder="Â¶ÇÔºöÊñ∞ÊâãÊñΩÂ∑•Âëò„ÄÅÁªèÈ™åÁõëÁêÜÁ≠â">
                        </div>
                    </div>
                    
                    <label class="form-label">ÂØπËØùËΩÆÊ¨° (Áî®Êà∑ÂèëË®Ä)</label>
                    <div class="conversation-turns">
                        <input type="text" class="form-control mb-2" name="scenarioTurn1_1" 
                               placeholder="Á¨¨1ËΩÆÁî®Êà∑ÂèëË®Ä" required>
                        <input type="text" class="form-control mb-2" name="scenarioTurn1_2" 
                               placeholder="Á¨¨2ËΩÆÁî®Êà∑ÂèëË®Ä">
                        <input type="text" class="form-control" name="scenarioTurn1_3" 
                               placeholder="Á¨¨3ËΩÆÁî®Êà∑ÂèëË®Ä">
                    </div>
                </div>
            `;
            container.innerHTML = scenarioHtml;
        }

        function addScenario() {
            scenarioCounter++;
            const container = document.getElementById('scenariosContainer');

            const scenarioHtml = `
                <div class="scenario-card config-section" data-scenario="${scenarioCounter}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-comments"></i>
                            Âú∫ÊôØ ${scenarioCounter}: Ëá™ÂÆö‰πâÂú∫ÊôØ
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeScenario(${scenarioCounter})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Âú∫ÊôØÊ†áÈ¢ò</label>
                            <input type="text" class="form-control" name="scenarioTitle${scenarioCounter}" 
                                   value="Ëá™ÂÆö‰πâÂú∫ÊôØ ${scenarioCounter}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">‰∏öÂä°‰∏ä‰∏ãÊñá</label>
                            <input type="text" class="form-control" name="scenarioContext${scenarioCounter}" 
                                   placeholder="Â¶ÇÔºöÂª∫Á≠ëÂ∑•Âú∞„ÄÅÊ°•Ê¢ÅÁé∞Âú∫Á≠â">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Áî®Êà∑ÁîªÂÉè</label>
                            <input type="text" class="form-control" name="scenarioProfile${scenarioCounter}" 
                                   placeholder="Â¶ÇÔºöÊñ∞ÊâãÊñΩÂ∑•Âëò„ÄÅÁªèÈ™åÁõëÁêÜÁ≠â">
                        </div>
                    </div>
                    
                    <label class="form-label">ÂØπËØùËΩÆÊ¨° (Áî®Êà∑ÂèëË®Ä)</label>
                    <div class="conversation-turns">
                        <input type="text" class="form-control mb-2" name="scenarioTurn${scenarioCounter}_1" 
                               placeholder="Á¨¨1ËΩÆÁî®Êà∑ÂèëË®Ä" required>
                        <input type="text" class="form-control mb-2" name="scenarioTurn${scenarioCounter}_2" 
                               placeholder="Á¨¨2ËΩÆÁî®Êà∑ÂèëË®Ä">
                        <input type="text" class="form-control" name="scenarioTurn${scenarioCounter}_3" 
                               placeholder="Á¨¨3ËΩÆÁî®Êà∑ÂèëË®Ä">
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', scenarioHtml);

            // Scroll to the new scenario
            const newScenario = container.lastElementChild;
            newScenario.scrollIntoView({ behavior: 'smooth', block: 'start' });

            console.log(`‚úÖ Added scenario ${scenarioCounter}`);
        }

        function removeScenario(scenarioNumber) {
            const scenarioElement = document.querySelector(`[data-scenario="${scenarioNumber}"]`);
            if (scenarioElement) {
                scenarioElement.remove();
                console.log('üóëÔ∏è Removed scenario:', scenarioNumber);
            }
        }

        function toggleEvaluationMode() {
            const autoMode = document.getElementById('autoMode').checked;
            const dynamicMode = document.getElementById('dynamicMode').checked;
            const manualMode = document.getElementById('manualMode').checked;

            const autoSection = document.getElementById('autoModeSection');
            const dynamicSection = document.getElementById('dynamicModeSection');
            const manualSection = document.getElementById('manualModeSection');
            const scenariosSection = document.getElementById('scenariosSection');

            // Hide all sections first
            autoSection.style.display = 'none';
            dynamicSection.style.display = 'none';
            manualSection.style.display = 'none';
            scenariosSection.style.display = 'none';

            // Clear any existing required attributes from scenario fields
            const scenarioInputs = document.querySelectorAll('input[name^="scenarioTitle"], input[name^="scenarioTurn"]');
            scenarioInputs.forEach(input => {
                input.removeAttribute('required');
            });

            if (autoMode) {
                autoSection.style.display = 'block';
                console.log('ü§ñ Switched to auto extraction mode');
            } else if (dynamicMode) {
                dynamicSection.style.display = 'block';
                console.log('üó£Ô∏è Switched to dynamic conversation mode');
            } else if (manualMode) {
                manualSection.style.display = 'block';
                scenariosSection.style.display = 'block';

                // Create default scenario if container is empty
                const container = document.getElementById('scenariosContainer');
                if (container.children.length === 0) {
                    addDefaultScenario();
                }

                // Add required attributes to visible scenario fields
                const visibleScenarioInputs = document.querySelectorAll('#scenariosSection input[name^="scenarioTitle"], #scenariosSection input[name*="Turn"][name*="_1"]');
                visibleScenarioInputs.forEach(input => {
                    if (input.name.includes('Title') || input.name.includes('Turn') && input.name.endsWith('_1')) {
                        input.setAttribute('required', 'required');
                    }
                });

                console.log('‚úã Switched to manual configuration mode');
            }
        }

        async function extractPersona() {
            const fileInput = document.getElementById('requirementFile');
            const textInput = document.getElementById('requirementDoc');

            if (!fileInput.files.length && !textInput.value.trim()) {
                alert('ËØ∑ÂÖà‰∏ä‰º†ÊñáÊ°£ÊàñËæìÂÖ•ÊñáÊ°£ÂÜÖÂÆπ');
                return;
            }

            try {
                showLoading('DeepSeekÊ≠£Âú®Êô∫ËÉΩÂàÜÊûêÈúÄÊ±ÇÊñáÊ°£...');

                const formData = new FormData();
                if (fileInput.files.length > 0) {
                    formData.append('requirement_file', fileInput.files[0]);
                }
                if (textInput.value.trim()) {
                    formData.append('requirement_text', textInput.value.trim());
                }

                const response = await fetch('/api/extract-user-persona', {
                    method: 'POST',
                    body: formData,
                    signal: createTimeoutSignal(300000)  // 5 minutes timeout for persona extraction
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();
                extractedPersonaData = result.extraction_result;

                hideLoading();
                displayExtractedPersona(result);

            } catch (error) {
                hideLoading();
                console.error('‚ùå Persona extraction failed:', error);
                alert('Áî®Êà∑ÁîªÂÉèÊèêÂèñÂ§±Ë¥•: ' + error.message);
            }
        }

        function displayExtractedPersona(result) {
            // Remove any existing persona display
            const existingPersona = document.getElementById('extractedPersonaDisplay');
            if (existingPersona) {
                existingPersona.remove();
            }

            const persona = result.extraction_result.user_persona;
            const usage = result.extraction_result.usage_context;
            const aiRole = result.extraction_result.ai_role_simulation;
            const requirements = result.extraction_result.extracted_requirements;

            // Create a comprehensive collapsible section
            const personaHtml = `
                <div class="card mt-3" id="extractedPersonaDisplay">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-user-check"></i> 
                                Áî®Êà∑ÁîªÂÉèÊèêÂèñÊàêÂäü
                            </h6>
                            <button class="btn btn-sm btn-outline-light" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#personaDetails" 
                                    aria-expanded="false" aria-controls="personaDetails">
                                <i class="fas fa-chevron-down"></i> ËØ¶ÁªÜ‰ø°ÊÅØ
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÁÆÄË¶Å‰ø°ÊÅØ -->
                    <div class="card-body pb-2">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>ËßíËâ≤Ôºö</strong><span class="text-primary">${persona.role}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>‰∏öÂä°È¢ÜÂüüÔºö</strong><span class="text-info">${usage.business_domain}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>ÁªèÈ™åÊ∞¥Âπ≥Ôºö</strong><span class="text-warning">${persona.experience_level}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Ê≤üÈÄöÈ£éÊ†ºÔºö</strong><span class="text-secondary">${persona.communication_style}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ËØ¶ÁªÜ‰ø°ÊÅØÔºàÂèØÊäòÂè†Ôºâ -->
                    <div class="collapse" id="personaDetails">
                        <div class="card-body border-top">
                            <div class="row">
                                <!-- Áî®Êà∑ÁîªÂÉèËØ¶ÊÉÖ -->
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-user"></i> Áî®Êà∑ÁîªÂÉè</h6>
                                    <ul class="list-unstyled small">
                                        <li><strong>Â∑•‰ΩúÁéØÂ¢ÉÔºö</strong> ${persona.work_environment}</li>
                                        <li><strong>Â∑•‰ΩúÂéãÂäõÔºö</strong> ${persona.work_pressure}</li>
                                        <li><strong>‰∏ì‰∏öÈ¢ÜÂüüÔºö</strong> ${persona.expertise_areas ? persona.expertise_areas.join(', ') : 'ÈÄöÁî®‰∏ì‰∏ö'}</li>
                                    </ul>
                                </div>
                                
                                <!-- ‰ΩøÁî®Âú∫ÊôØ -->
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-briefcase"></i> ‰ΩøÁî®Âú∫ÊôØ</h6>
                                    <ul class="list-unstyled small">
                                        <li><strong>‰∏ªË¶ÅÂú∫ÊôØÔºö</strong> ${usage.primary_scenarios ? usage.primary_scenarios.join(', ') : '‰∏ì‰∏öÂí®ËØ¢'}</li>
                                        <li><strong>‰∫§‰∫íÁõÆÊ†áÔºö</strong> ${usage.interaction_goals ? usage.interaction_goals.join(', ') : 'Ëé∑ÂèñÂáÜÁ°Æ‰ø°ÊÅØ'}</li>
                                        <li><strong>‰ΩøÁî®Êó∂Êú∫Ôºö</strong> ${usage.usage_timing ? usage.usage_timing.join(', ') : 'Â∑•‰ΩúÊó∂Èó¥'}</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <!-- ÂØπËØùÊ®°Êãü -->
                                <div class="col-md-6">
                                    <h6 class="text-warning"><i class="fas fa-comments"></i> ÂØπËØùÁâπÂæÅ</h6>
                                    <ul class="list-unstyled small">
                                        <li><strong>ÂØπËØùÊñπÂºèÔºö</strong> ${aiRole.conversation_approach}</li>
                                        <li><strong>ËØ≠Ë®ÄÁâπÁÇπÔºö</strong> ${aiRole.language_characteristics}</li>
                                        <li><strong>ÂÖ∏ÂûãÈóÆÈ¢òÔºö</strong> ${aiRole.typical_questions ? aiRole.typical_questions.slice(0, 2).join('; ') : '‰∏ì‰∏öÂí®ËØ¢'}</li>
                                    </ul>
                                </div>
                                
                                <!-- Ê†∏ÂøÉÈúÄÊ±Ç -->
                                <div class="col-md-6">
                                    <h6 class="text-success"><i class="fas fa-target"></i> Ê†∏ÂøÉÈúÄÊ±Ç</h6>
                                    <ul class="list-unstyled small">
                                        <li><strong>Ê†∏ÂøÉÂäüËÉΩÔºö</strong> ${requirements.core_functions ? requirements.core_functions.join(', ') : 'ÂáÜÁ°Æ‰ø°ÊÅØÊü•ËØ¢'}</li>
                                        <li><strong>Ë¥®ÈáèÊúüÊúõÔºö</strong> ${requirements.quality_expectations ? requirements.quality_expectations.join(', ') : 'ÂáÜÁ°ÆÂèäÊó∂'}</li>
                                        <li><strong>‰∫§‰∫íÂÅèÂ•ΩÔºö</strong> ${requirements.interaction_preferences ? requirements.interaction_preferences.join(', ') : 'ÁÆÄÊ¥ÅÊòé‰∫Ü'}</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-lightbulb"></i>
                                        <strong>Êô∫ËÉΩÂàÜÊûêÁªìÊûúÔºö</strong>Á≥ªÁªüÂ∞ÜÂü∫‰∫éÊ≠§Áî®Êà∑ÁîªÂÉèËá™Âä®ÁîüÊàêÈíàÂØπÊÄßÁöÑÂØπËØùÂú∫ÊôØÔºåÁ°Æ‰øùËØÑ‰º∞ÁªìÊûúÊõ¥Ë¥¥ÂêàÂÆûÈôÖ‰∏öÂä°ÈúÄÊ±Ç„ÄÇ
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Insert after the extract button
            const extractButton = document.querySelector('button[onclick="extractPersona()"]');
            extractButton.insertAdjacentHTML('afterend', personaHtml);

            console.log('‚úÖ Áî®Êà∑ÁîªÂÉèÊòæÁ§∫ÂÆåÊàê:', persona.role);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            console.log('üöÄ Starting evaluation submission...');

            try {
                showLoading('Ê≠£Âú®ÂáÜÂ§áËØÑ‰º∞Êï∞ÊçÆ...');

                const formData = new FormData();

                // Get AI configuration
                const aiConfig = getAIConfiguration();
                console.log('üîß AI Config:', aiConfig);
                formData.append('agent_api_config', JSON.stringify(aiConfig));

                // Determine evaluation mode
                const evaluationMode = document.getElementById('autoMode').checked ? 'auto' :
                    document.getElementById('dynamicMode').checked ? 'dynamic' : 'manual';
                formData.append('evaluation_mode', evaluationMode);

                console.log('üìä Evaluation mode:', evaluationMode);

                // Handle different evaluation modes
                if (evaluationMode === 'dynamic') {
                    const fileInput = document.getElementById('dynamicRequirementFile');
                    const textInput = document.getElementById('dynamicRequirementDoc');

                    if (fileInput.files.length > 0) {
                        formData.append('requirement_file', fileInput.files[0]);
                        console.log('üìÑ Adding dynamic file:', fileInput.files[0].name);
                    } else if (textInput.value.trim()) {
                        formData.append('requirement_text', textInput.value.trim());
                        console.log('üìù Adding dynamic text requirement');
                    } else {
                        throw new Error('Âä®ÊÄÅÂØπËØùÊ®°ÂºèÈúÄË¶Å‰∏ä‰º†ÊñáÊ°£ÊàñËæìÂÖ•ÊñáÊ°£ÂÜÖÂÆπ');
                    }

                    updateLoadingProgress('Ê≠£Âú®ÊèêÂèñÁî®Êà∑ÁîªÂÉèÂπ∂ÁîüÊàêÂä®ÊÄÅÂØπËØùÂú∫ÊôØ...');

                    const response = await fetch('/api/evaluate-agent-dynamic', {
                        method: 'POST',
                        body: formData,
                        signal: createTimeoutSignal(600000)  // 10 minutes timeout for dynamic evaluation
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }

                    const result = await response.json();
                    console.log('‚úÖ Dynamic evaluation completed:', result);

                    hideLoading();
                    displayResults(result);

                } else if (evaluationMode === 'auto') {
                    // Auto mode logic
                    const fileInput = document.getElementById('requirementFile');
                    const textInput = document.getElementById('requirementDoc');

                    if (fileInput.files.length > 0) {
                        formData.append('requirement_file', fileInput.files[0]);
                    } else if (textInput.value.trim()) {
                        formData.append('requirement_text', textInput.value.trim());
                    } else {
                        throw new Error('Êô∫ËÉΩÊèêÂèñÊ®°ÂºèÈúÄË¶Å‰∏ä‰º†ÊñáÊ°£ÊàñËæìÂÖ•ÊñáÊ°£ÂÜÖÂÆπ');
                    }

                    if (extractedPersonaData) {
                        formData.append('extracted_persona', JSON.stringify(extractedPersonaData));
                    }

                    updateLoadingProgress('Ê≠£Âú®ËøõË°åÊô∫ËÉΩËØÑ‰º∞...');

                    const response = await fetch('/api/evaluate-agent-auto', {
                        method: 'POST',
                        body: formData,
                        signal: createTimeoutSignal(480000)  // 8 minutes timeout for auto evaluation
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }

                    const result = await response.json();
                    console.log('‚úÖ Auto evaluation completed:', result);

                    hideLoading();
                    displayResults(result);

                } else {
                    // Manual mode logic
                    const scenarios = collectScenariosData();
                    formData.append('scenarios', JSON.stringify(scenarios));

                    const userRole = document.getElementById('userRole').value;
                    const experienceLevel = document.getElementById('experienceLevel').value;
                    const communicationStyle = document.getElementById('communicationStyle').value;

                    const userPersona = {
                        role: userRole,
                        experience_level: experienceLevel,
                        communication_style: communicationStyle
                    };

                    formData.append('user_persona', JSON.stringify(userPersona));

                    updateLoadingProgress('Ê≠£Âú®ËøõË°åÊâãÂä®ÈÖçÁΩÆËØÑ‰º∞...');

                    const response = await fetch('/api/evaluate-agent', {
                        method: 'POST',
                        body: formData,
                        signal: createTimeoutSignal(480000)  // 8 minutes timeout for manual evaluation
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    }

                    const result = await response.json();
                    console.log('‚úÖ Manual evaluation completed:', result);

                    hideLoading();
                    displayResults(result);
                }

            } catch (error) {
                hideLoading();
                console.error('‚ùå Evaluation failed:', error);
                alert('ËØÑ‰º∞Â§±Ë¥•: ' + error.message);
            }
        }

        function collectScenariosData() {
            const scenarios = [];
            const scenarioElements = document.querySelectorAll('[data-scenario]');

            scenarioElements.forEach(element => {
                const scenarioNumber = element.getAttribute('data-scenario');
                const title = document.querySelector(`input[name="scenarioTitle${scenarioNumber}"]`)?.value || '';
                const context = document.querySelector(`input[name="scenarioContext${scenarioNumber}"]`)?.value || '';
                const profile = document.querySelector(`input[name="scenarioProfile${scenarioNumber}"]`)?.value || '';

                const turns = [];
                for (let i = 1; i <= 3; i++) {
                    const turn = document.querySelector(`input[name="scenarioTurn${scenarioNumber}_${i}"]`)?.value;
                    if (turn && turn.trim()) {
                        turns.push(turn.trim());
                    }
                }

                if (title && turns.length > 0) {
                    scenarios.push({
                        title,
                        context,
                        user_profile: profile,
                        conversation_turns: turns
                    });
                }
            });

            return scenarios;
        }

        function getAIConfiguration() {
            if (document.getElementById('cozeAgentConfig').style.display !== 'none') {
                const agentId = document.getElementById('cozeAgentId').value;
                const token = document.getElementById('cozeAgentToken').value;
                const region = document.getElementById('cozeRegion').value;

                if (!agentId || !token) {
                    throw new Error('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑ Coze Agent ÈÖçÁΩÆ‰ø°ÊÅØ');
                }

                return {
                    type: 'coze-agent',
                    url: region === 'global' ? 'https://api.coze.com/open_api/v2/chat' : 'https://api.coze.cn/open_api/v2/chat',
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    agentId: agentId,
                    region: region,
                    timeout: 30
                };
            } else if (document.getElementById('cozeBotConfig').style.display !== 'none') {
                const botId = document.getElementById('cozeBotIdNew').value;
                const botVersion = document.getElementById('cozeBotVersion').value;

                if (!botId) {
                    throw new Error('ËØ∑Â°´ÂÜô Coze Bot ID');
                }

                return {
                    type: 'coze-bot',
                    url: 'https://api.coze.cn/open_api/v2/chat',
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer pat_aWWxLQe20D8km5FsKt5W99pWL72L5LNxjkontH91q3lqqTU0ExBKUBl1cUy4tm8c',
                        'Content-Type': 'application/json'
                    },
                    botId: botId,
                    botVersion: botVersion || 'latest',
                    timeout: 30
                };
            } else if (document.getElementById('customApiConfig').style.display !== 'none') {
                const apiUrl = document.getElementById('apiUrl').value;
                const apiMethod = document.getElementById('apiMethod').value;
                const headersText = document.getElementById('apiHeaders').value;

                if (!apiUrl) {
                    throw new Error('ËØ∑Â°´ÂÜô API URL');
                }

                let headers = { 'Content-Type': 'application/json' };
                if (headersText.trim()) {
                    try {
                        const parsedHeaders = JSON.parse(headersText);

                        // Validate that it's actually headers, not a full config
                        const suspiciousKeys = ['type', 'url', 'method', 'timeout', 'agentId', 'botId'];
                        const foundSuspicious = suspiciousKeys.filter(key => key in parsedHeaders);

                        if (foundSuspicious.length > 0) {
                            throw new Error(`ËØ∑Ê±ÇÂ§¥‰∏≠ÂåÖÂê´ÈÖçÁΩÆÂ≠óÊÆµ "${foundSuspicious.join(', ')}"ÔºåËØ∑Âè™Â°´ÂÜôËØ∑Ê±ÇÂ§¥‰ø°ÊÅØÔºàÂ¶ÇAuthorizationÁ≠âÔºâ`);
                        }

                        headers = { ...headers, ...parsedHeaders };
                    } catch (e) {
                        if (e.message.includes('ÈÖçÁΩÆÂ≠óÊÆµ')) {
                            throw e; // Re-throw our custom validation error
                        }
                        throw new Error('ËØ∑Ê±ÇÂ§¥Ê†ºÂºèÈîôËØØÔºåËØ∑‰ΩøÁî®ÊúâÊïàÁöÑ JSON Ê†ºÂºèÔºö{"Authorization": "Bearer token"}');
                    }
                }

                return {
                    type: 'custom-api',
                    url: apiUrl,
                    method: apiMethod,
                    headers: headers,
                    timeout: 30
                };
            }

            throw new Error('ËØ∑ÈÄâÊã©Âπ∂ÈÖçÁΩÆ‰∏ÄÁßçAIÁ≥ªÁªüÁ±ªÂûã');
        }

        function showLoading(message) {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function updateLoadingProgress(message) {
            document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function generateStarRating(score) {
            // Convert 100-point scale to 5-star scale for display with finer precision
            const normalizedScore = score / 20; // 100 -> 5, 80 -> 4, 63 -> 3.15, etc.
            const fullStars = Math.floor(normalizedScore);
            const remainingScore = normalizedScore - fullStars;

            // More precise partial star calculation
            let halfStar = '';
            let quarterStar = '';

            if (remainingScore >= 0.75) {
                halfStar = '‚òÖ'; // Almost full star
            } else if (remainingScore >= 0.5) {
                halfStar = '‚òÜ'; // Half star
            } else if (remainingScore >= 0.25) {
                quarterStar = '‚òÜ'; // Quarter star
            }

            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0) - (quarterStar ? 1 : 0);

            return '‚òÖ'.repeat(fullStars) + halfStar + quarterStar + '‚òÜ'.repeat(Math.max(0, emptyStars));
        }

        function getScoreGrade(score) {
            // Support fine-grained scoring with more precise thresholds
            if (score >= 90) return '‰ºòÁßÄ';
            if (score >= 85) return 'ËâØÂ•Ω+';
            if (score >= 80) return 'ËâØÂ•Ω';
            if (score >= 75) return '‰∏≠Á≠â+';
            if (score >= 70) return '‰∏≠Á≠â';
            if (score >= 65) return 'ÂèäÊ†º+';
            if (score >= 60) return 'ÂèäÊ†º';
            if (score >= 55) return '‰∏çÂèäÊ†º+';
            if (score >= 50) return '‰∏çÂèäÊ†º';
            return 'ÈúÄË¶ÅÊîπËøõ';
        }

        function formatAnalysisText(text) {
            if (!text || text === 'ÊöÇÊó†ËØ¶ÁªÜÂàÜÊûê' || text === 'ÊöÇÊó†ÂÖ∑‰ΩìÂºïÁî®' || text === 'ÊöÇÊó†ÊîπËøõÂª∫ËÆÆ') {
                return `<span class="text-muted">${text}</span>`;
            }

            // Clean up common unwanted patterns
            let cleanText = text.replace(/‰æùÊçÆÊù•Ê∫êÔºö[^\n]*/g, '')
                .replace(/ÂèÇËÄÉ‰æùÊçÆÔºö[^\n]*/g, '')
                .replace(/\n+/g, '<br/>')
                .trim();

            // Format lists and bullet points
            cleanText = cleanText.replace(/(\d+\.\s)/g, '<br/>$1')
                .replace(/(-\s)/g, '<br/>‚Ä¢ ');

            return cleanText || `<span class="text-muted">ÊöÇÊó†Áõ∏ÂÖ≥‰ø°ÊÅØ</span>`;
        }

        // Enhanced explanation chain formatter with debugging and multiple extraction strategies
        function formatExplanationChain(scoreData, dimension) {
            console.log(`üîç DEBUG: formatExplanationChain for dimension ${dimension}:`, scoreData);

            // Strategy 1: Direct object parsing
            if (typeof scoreData === 'object' && scoreData !== null) {
                const result = {
                    score: parseFloat(scoreData.score || 0),
                    detailed_analysis: extractField(scoreData, ['detailed_analysis', 'explanation', 'analysis']),
                    specific_quotes: extractField(scoreData, ['specific_quotes', 'quotes', 'evidence']),
                    improvement_suggestions: extractField(scoreData, ['improvement_suggestions', 'suggestions', 'recommendations']),
                    comprehensive_evaluation: extractField(scoreData, ['comprehensive_evaluation', 'evaluation', 'summary']),
                    full_response: extractField(scoreData, ['full_response', 'response', 'raw_response'])
                };

                console.log(`‚úÖ Extracted result for ${dimension}:`, result);
                return result;
            }

            // Strategy 2: Fallback for non-object data
            console.log(`‚ö†Ô∏è Non-object scoreData for ${dimension}, using fallback`);
            return {
                score: parseFloat(scoreData) || 0,
                detailed_analysis: "ÊöÇÊó†ËØ¶ÁªÜÂàÜÊûê",
                specific_quotes: "ÊöÇÊó†ÂÖ∑‰ΩìÂºïÁî®",
                improvement_suggestions: "ÊöÇÊó†ÊîπËøõÂª∫ËÆÆ",
                comprehensive_evaluation: "ÊöÇÊó†ÁªºÂêàËØÑ‰ª∑",
                full_response: ""
            };
        }

        // Helper function to extract field with multiple possible keys
        function extractField(obj, possibleKeys) {
            for (let key of possibleKeys) {
                if (obj[key] && obj[key] !== '') {
                    return obj[key];
                }
            }
            return null;
        }

        // Simple HTML escape function for safety
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Generate reader-friendly JSON section with organized subsections
        function generateJsonSection(data, title, sectionId) {
            if (!data) return '';

            // For conversation records, organize by scenarios
            if (sectionId === 'json-conversations' && Array.isArray(data)) {
                const organizedHtml = data.map((record, index) => {
                    const scenarioTitle = record.scenario?.title || `Âú∫ÊôØ ${index + 1}`;
                    const scenarioScore = record.scenario_score_100 || (record.scenario_score * 20) || 0;

                    return `
                        <div class="json-scenario mb-3">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-comments"></i> ${scenarioTitle} 
                                <span class="badge bg-info">${scenarioScore.toFixed(1)}/100</span>
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>ÂØπËØùÂéÜÂè≤ (${record.conversation_history?.length || 0} ËΩÆ):</strong>
                                    <div class="json-subsection">
                                        ${formatConversationHistory(record.conversation_history)}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <strong>ËØÑ‰º∞ÂæóÂàÜ:</strong>
                                    <div class="json-subsection">
                                        ${formatEvaluationScores(record.evaluation_scores_with_explanations)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="collapsible-card mb-3">
                        <div class="collapsible-header" onclick="toggleCollapsible('${sectionId}')">
                            <div class="collapsible-title">
                                <i class="fas fa-comments"></i>
                                ${title} <span class="badge bg-secondary">${data.length} ‰∏™Âú∫ÊôØ</span>
                            </div>
                            <i class="fas fa-chevron-down collapsible-toggle" id="${sectionId}-toggle"></i>
                        </div>
                        <div class="collapsible-content collapsed" id="${sectionId}">
                            ${organizedHtml}
                        </div>
                    </div>
                `;
            }

            // For evaluation summary, create organized view
            if (sectionId === 'json-summary' && typeof data === 'object') {
                return `
                    <div class="collapsible-card mb-3">
                        <div class="collapsible-header" onclick="toggleCollapsible('${sectionId}')">
                            <div class="collapsible-title">
                                <i class="fas fa-chart-pie"></i>
                                ${title}
                            </div>
                            <i class="fas fa-chevron-down collapsible-toggle" id="${sectionId}-toggle"></i>
                        </div>
                        <div class="collapsible-content collapsed" id="${sectionId}">
                            <div class="json-organized">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-success">üìä ËØÑ‰º∞Ê¶ÇË¶Å</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>ÁªºÂêàÂæóÂàÜ:</strong> ${data.overall_score_100}/100 (${data.overall_score}/5)</li>
                                            <li><strong>ËØÑ‰º∞Ê°ÜÊû∂:</strong> ${data.framework}</li>
                                            <li><strong>Âú∫ÊôØÊï∞Èáè:</strong> ${data.total_scenarios}</li>
                                            <li><strong>ÂØπËØùËΩÆÊ¨°:</strong> ${data.total_conversations}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-info">üìà Áª¥Â∫¶ÂæóÂàÜ</h6>
                                        <ul class="list-unstyled">
                                            ${Object.entries(data.dimension_scores_100 || {}).map(([key, score]) => {
                    const labels = {
                        'fuzzy_understanding': 'Ê®°Á≥äÁêÜËß£ËÉΩÂäõ',
                        'answer_correctness': 'ÂõûÁ≠îÂáÜÁ°ÆÊÄß',
                        'persona_alignment': 'Áî®Êà∑ÂåπÈÖçÂ∫¶',
                        'goal_alignment': 'ÁõÆÊ†áÂØπÈΩêÂ∫¶'
                    };
                    return `<li><strong>${labels[key] || key}:</strong> ${score}/100</li>`;
                }).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // For user persona, create organized view
            if (sectionId === 'json-persona' && typeof data === 'object') {
                const persona = data.extracted_persona_summary?.user_persona || {};
                const context = data.extracted_persona_summary?.usage_context || {};

                return `
                    <div class="collapsible-card mb-3">
                        <div class="collapsible-header" onclick="toggleCollapsible('${sectionId}')">
                            <div class="collapsible-title">
                                <i class="fas fa-user-cog"></i>
                                ${title}
                            </div>
                            <i class="fas fa-chevron-down collapsible-toggle" id="${sectionId}-toggle"></i>
                        </div>
                        <div class="collapsible-content collapsed" id="${sectionId}">
                            <div class="json-organized">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">üë§ Áî®Êà∑ÁâπÂæÅ</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>ËßíËâ≤:</strong> ${persona.role || 'N/A'}</li>
                                            <li><strong>ÁªèÈ™åÊ∞¥Âπ≥:</strong> ${persona.experience_level || 'N/A'}</li>
                                            <li><strong>Ê≤üÈÄöÈ£éÊ†º:</strong> ${persona.communication_style || 'N/A'}</li>
                                            <li><strong>Â∑•‰ΩúÁéØÂ¢É:</strong> ${persona.work_environment || 'N/A'}</li>
                                            <li><strong>‰∏ì‰∏öÈ¢ÜÂüü:</strong> ${persona.expertise_areas?.join(', ') || 'N/A'}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-success">üéØ ‰ΩøÁî®Âú∫ÊôØ</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>‰∏öÂä°È¢ÜÂüü:</strong> ${context.business_domain || 'N/A'}</li>
                                            <li><strong>‰∏ªË¶ÅÂú∫ÊôØ:</strong> ${context.primary_scenarios?.join(', ') || 'N/A'}</li>
                                            <li><strong>‰∫§‰∫íÁõÆÊ†á:</strong> ${context.interaction_goals?.slice(0, 2).join(', ') || 'N/A'}</li>
                                            <li><strong>‰ΩøÁî®Êó∂Êú∫:</strong> ${context.usage_timing?.join(', ') || 'N/A'}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Default JSON display for other sections
            const jsonString = JSON.stringify(data, null, 2);
            return `
                <div class="collapsible-card mb-3">
                    <div class="collapsible-header" onclick="toggleCollapsible('${sectionId}')">
                        <div class="collapsible-title">
                            <i class="fas fa-code"></i>
                            ${title}
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="${sectionId}-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="${sectionId}">
                        <pre class="bg-light p-3 rounded small overflow-auto" style="max-height: 400px;"><code>${jsonString}</code></pre>
                    </div>
                </div>
            `;
        }

        // Helper function to format conversation history
        function formatConversationHistory(history) {
            if (!history || !Array.isArray(history)) return '<span class="text-muted">ÊöÇÊó†ÂØπËØùËÆ∞ÂΩï</span>';

            return history.map((turn, index) => `
                <div class="conversation-json-turn mb-2">
                    <strong>Á¨¨${turn.turn || index + 1}ËΩÆ:</strong>
                    <div class="ms-3">
                        <div><strong>üë§ Áî®Êà∑:</strong> ${turn.user_message || 'N/A'}</div>
                        <div><strong>ü§ñ AI:</strong> ${cleanAiResponse(turn.ai_response || turn.ai_message || 'N/A').substring(0, 100)}...</div>
                    </div>
                </div>
            `).join('');
        }

        // Helper function to format evaluation scores
        function formatEvaluationScores(scores) {
            if (!scores || typeof scores !== 'object') return '<span class="text-muted">ÊöÇÊó†ËØÑ‰º∞ÂæóÂàÜ</span>';

            const labels = {
                'fuzzy_understanding': 'Ê®°Á≥äÁêÜËß£',
                'answer_correctness': 'ÂõûÁ≠îÂáÜÁ°ÆÊÄß',
                'persona_alignment': 'Áî®Êà∑ÂåπÈÖç',
                'goal_alignment': 'ÁõÆÊ†áÂØπÈΩê'
            };

            return Object.entries(scores).map(([dimension, scoreData]) => {
                const score = typeof scoreData === 'object' ? scoreData.score : scoreData;
                const grade = getScoreGrade(score);
                const color = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';

                return `
                    <div class="mb-1">
                        <span class="badge bg-${color}">${labels[dimension] || dimension}: ${score}/100</span>
                        <small class="text-muted">(${grade})</small>
                    </div>
                `;
            }).join('');
        }

        // Enhanced collapsible toggle function
        // Generate comprehensive report showing ALL data from JSON
        function generateCompleteDataReport(data) {
            if (!data) return '<div class="alert alert-warning">Êó†Êï∞ÊçÆÂèØÊòæÁ§∫</div>';

            const summary = data.evaluation_summary || {};
            const records = data.conversation_records || [];
            const userPersonaInfo = data.user_persona_info || {};
            const contextDisplay = data.detailed_context_display || {};
            const evaluationMode = data.evaluation_mode || 'unknown';

            // Main report structure
            return `
                <div class="complete-report-container">
                    <!-- Report Header -->
                    <div class="report-header mb-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h3 class="mb-0">
                                    <i class="fas fa-chart-line"></i> 
                                    AI Agent ÂÆåÊï¥ËØÑ‰º∞Êä•Âëä
                                    <small class="ms-2">ÂÖ®Êï∞ÊçÆÂ±ïÁ§∫Áâà</small>
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <div class="stat-number text-primary">${summary.overall_score_100 || 0}</div>
                                            <div class="stat-label">ÁªºÂêàÂæóÂàÜ (100ÂàÜÂà∂)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <div class="stat-number text-info">${records.length}</div>
                                            <div class="stat-label">ËØÑ‰º∞Âú∫ÊôØ</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <div class="stat-number text-success">${summary.total_conversations || 0}</div>
                                            <div class="stat-label">ÊÄªÂØπËØùËΩÆÊ¨°</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <div class="stat-number text-warning">${evaluationMode === 'dynamic' ? 'Âä®ÊÄÅ' : 'ÈùôÊÄÅ'}</div>
                                            <div class="stat-label">ËØÑ‰º∞Ê®°Âºè</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Complete Data Sections -->
                    ${generateEvaluationSummarySection(summary)}
                    ${generateUserPersonaSection(userPersonaInfo)}
                    ${generateContextDisplaySection(contextDisplay)}
                    ${generateConversationRecordsSection(records)}
                    ${generatePersonaAlignmentSection(data)}
                    ${generateBusinessGoalSection(data)}
                    ${generateTechnicalDetailsSection(data)}
                    ${generateRawDataSection(data)}
                </div>
            `;
        }

        // Generate evaluation summary section with all score details
        function generateEvaluationSummarySection(summary) {
            const dimensionScores = summary.dimension_scores_100 || summary.dimensions || {};
            const overallScore = summary.overall_score_100 || summary.overall_score * 20 || 0;

            return `
                <div class="collapsible-card mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('eval-summary')">
                        <div class="collapsible-title">
                            <i class="fas fa-chart-pie"></i>
                            üìä ËØÑ‰º∞ÊÄªÁªì‰∏éÂæóÂàÜËØ¶ÊÉÖ
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="eval-summary-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="eval-summary">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-success"><i class="fas fa-trophy"></i> ÁªºÂêàËØÑ‰º∞ÁªìÊûú</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr><td><strong>100ÂàÜÂà∂ÂæóÂàÜ:</strong></td><td class="text-primary">${overallScore.toFixed(2)}/100</td></tr>
                                        <tr><td><strong>5ÂàÜÂà∂ÂæóÂàÜ:</strong></td><td class="text-info">${summary.overall_score || (overallScore / 20).toFixed(2)}/5</td></tr>
                                        <tr><td><strong>Á≠âÁ∫ßËØÑ‰ª∑:</strong></td><td><span class="badge bg-${overallScore >= 80 ? 'success' : overallScore >= 60 ? 'warning' : 'danger'}">${getScoreGrade(overallScore)}</span></td></tr>
                                        <tr><td><strong>ËØÑ‰º∞Ê°ÜÊû∂:</strong></td><td>${summary.framework || 'ÂõõÁª¥Â∫¶ËØÑ‰º∞‰ΩìÁ≥ª'}</td></tr>
                                        <tr><td><strong>Âú∫ÊôØÊÄªÊï∞:</strong></td><td>${summary.total_scenarios || 0}</td></tr>
                                        <tr><td><strong>ÂØπËØùËΩÆÊ¨°:</strong></td><td>${summary.total_conversations || 0}</td></tr>
                                        <tr><td><strong>ËØÑ‰º∞Êó∂Èó¥:</strong></td><td>${summary.timestamp || 'Êú™ËÆ∞ÂΩï'}</td></tr>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info"><i class="fas fa-chart-bar"></i> ÂêÑÁª¥Â∫¶ËØ¶ÁªÜÂæóÂàÜ</h6>
                                <div class="dimension-scores">
                                    ${Object.entries(dimensionScores).map(([key, value]) => {
                const labels = {
                    'fuzzy_understanding': 'üîç Ê®°Á≥äÁêÜËß£‰∏éËøΩÈóÆËÉΩÂäõ',
                    'answer_correctness': '‚úÖ ÂõûÁ≠îÂáÜÁ°ÆÊÄß‰∏é‰∏ì‰∏öÊÄß',
                    'persona_alignment': 'üë• Áî®Êà∑ÂåπÈÖçÂ∫¶',
                    'goal_alignment': 'üéØ ÁõÆÊ†áÂØπÈΩêÂ∫¶'
                };
                const label = labels[key] || key;
                const score = parseFloat(value);
                const color = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
                return `
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>${label}</span>
                                                    <span class="badge bg-${color}">${score.toFixed(1)}/100</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-${color}" style="width: ${score}%"></div>
                                                </div>
                                            </div>
                                        `;
            }).join('')}
                                </div>
                            </div>
                        </div>
                        
                        ${summary.scoring_system ? `
                        <div class="mt-3">
                            <h6 class="text-warning"><i class="fas fa-cog"></i> ËØÑÂàÜÁ≥ªÁªüËÆæÁΩÆ</h6>
                            <div class="alert alert-light">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>ËØÑÂàÜÊ†áÂáÜ:</strong> ${summary.scoring_system.scale || '1-100ÂàÜÂà∂'}<br>
                                        <strong>ËØÑÂàÜÁ≠âÁ∫ß:</strong> ${Object.entries(summary.scoring_system.grade_levels || {}).map(([range, grade]) => `${range}ÂàÜ-${grade}`).join(', ')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Generate comprehensive user persona section
        function generateUserPersonaSection(userPersonaInfo) {
            // Remove empty sections as requested - return empty string if no data
            if (!userPersonaInfo || Object.keys(userPersonaInfo).length === 0) {
                return '';
            }

            // Parse all available persona data directly from JSON structure
            const extractedSummary = userPersonaInfo.extracted_persona_summary || {};
            const persona = extractedSummary.user_persona || userPersonaInfo.user_persona || {};
            const context = extractedSummary.usage_context || userPersonaInfo.usage_context || {};
            const aiRole = extractedSummary.ai_role_simulation || {};
            const requirements = extractedSummary.extracted_requirements || {};
            const display = userPersonaInfo.extracted_persona_display || {};

            // Extract comprehensive analysis if available
            const comprehensiveAnalysis = userPersonaInfo.comprehensive_analysis || {};

            return `
                <div class="collapsible-card mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('user-persona')">
                        <div class="collapsible-title">
                            <i class="fas fa-user-cog"></i>
                            üë§ Áî®Êà∑ÁîªÂÉè‰∏é‰∏ä‰∏ãÊñá‰ø°ÊÅØ <span class="badge bg-success">Â∑≤ÊèêÂèñ</span>
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="user-persona-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="user-persona">
                        <!-- Quick Overview -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-primary">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>üë§ Áî®Êà∑ËßíËâ≤:</strong><br>
                                            <span class="badge bg-primary">${display.user_role || persona.role || '‰∏ì‰∏öÁî®Êà∑'}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üè¢ ‰∏öÂä°È¢ÜÂüü:</strong><br>
                                            <span class="badge bg-info">${display.business_domain || context.business_domain || '‰∏ì‰∏öÊúçÂä°'}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üìà ÁªèÈ™åÊ∞¥Âπ≥:</strong><br>
                                            <span class="badge bg-warning">${persona.experience_level || 'Ê†áÂáÜÊ∞¥Âπ≥'}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üí¨ Ê≤üÈÄöÈ£éÊ†º:</strong><br>
                                            <span class="badge bg-secondary">${display.communication_style || persona.communication_style || '‰∏ì‰∏öÊ≤üÈÄö'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comprehensive User Persona Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="fas fa-user"></i> ËØ¶ÁªÜÁî®Êà∑ÁîªÂÉè</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <tr><td><strong>Â∑•‰ΩúÁéØÂ¢É:</strong></td><td>${display.work_environment || persona.work_environment || 'Ê†áÂáÜÂäûÂÖ¨ÁéØÂ¢É'}</td></tr>
                                        <tr><td><strong>Â∑•‰ΩúÂéãÂäõ:</strong></td><td>${persona.work_pressure || '‰∏≠Á≠âÂéãÂäõ'}</td></tr>
                                        <tr><td><strong>ÊäÄÊúØÊ∞¥Âπ≥:</strong></td><td>${persona.technical_level || 'Ê†áÂáÜÊäÄÊúØÊ∞¥Âπ≥'}</td></tr>
                                        <tr><td><strong>Â≠¶‰π†ËÉΩÂäõ:</strong></td><td>${persona.learning_ability || 'ËâØÂ•ΩÂ≠¶‰π†ËÉΩÂäõ'}</td></tr>
                                        <tr><td><strong>ÂÜ≥Á≠ñÈ£éÊ†º:</strong></td><td>${persona.decision_style || 'ÁêÜÊÄßÂÜ≥Á≠ñ'}</td></tr>
                                        <tr><td><strong>‰ø°ÊÅØËé∑ÂèñÂÅèÂ•Ω:</strong></td><td>${persona.information_preference || 'ÂáÜÁ°ÆËØ¶ÁªÜ‰ø°ÊÅØ'}</td></tr>
                                        <tr><td><strong>‰∏ì‰∏öÈ¢ÜÂüü:</strong></td><td>${persona.expertise_areas ? persona.expertise_areas.join(', ') : 'ÈÄöÁî®‰∏ì‰∏ö'}</td></tr>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success"><i class="fas fa-briefcase"></i> ‰∏öÂä°‰ΩøÁî®Âú∫ÊôØ</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <tr><td><strong>‰∏ªË¶ÅÂú∫ÊôØ:</strong></td><td>${display.primary_scenarios ? display.primary_scenarios.join(', ') : (context.primary_scenarios ? context.primary_scenarios.join(', ') : '‰∏ì‰∏öÂí®ËØ¢')}</td></tr>
                                        <tr><td><strong>‰∫§‰∫íÁõÆÊ†á:</strong></td><td>${context.interaction_goals ? context.interaction_goals.slice(0, 3).join(', ') : 'Ëé∑ÂèñÂáÜÁ°Æ‰ø°ÊÅØ'}</td></tr>
                                        <tr><td><strong>‰ΩøÁî®È¢ëÁéá:</strong></td><td>${context.usage_frequency || 'Â∑•‰ΩúÊó•Â∏∏‰ΩøÁî®'}</td></tr>
                                        <tr><td><strong>‰ΩøÁî®Êó∂Êú∫:</strong></td><td>${context.usage_timing ? context.usage_timing.join(', ') : 'Â∑•‰ΩúÊó∂Èó¥'}</td></tr>
                                        <tr><td><strong>ÊúüÊúõÂìçÂ∫îÈÄüÂ∫¶:</strong></td><td>${context.response_speed_expectation || 'Âø´ÈÄüÂìçÂ∫î'}</td></tr>
                                        <tr><td><strong>‰ø°ÊÅØÊ∑±Â∫¶ÈúÄÊ±Ç:</strong></td><td>${context.information_depth || 'ËØ¶ÁªÜ‰∏ì‰∏ö‰ø°ÊÅØ'}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- AI Role Simulation and Requirements - Expanded Content -->
                        ${Object.keys(aiRole).length > 0 ? `
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-warning"><i class="fas fa-robot"></i> AIËßíËâ≤Ê®°Êãü</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <tr><td><strong>ÂØπËØùÊñπÂºè:</strong></td><td>${aiRole.conversation_approach || 'N/A'}</td></tr>
                                        <tr><td><strong>ËØ≠Ë®ÄÁâπÁÇπ:</strong></td><td>${aiRole.language_characteristics || 'N/A'}</td></tr>
                                        <tr><td><strong>‰∫§‰∫íÂÅèÂ•Ω:</strong></td><td>${aiRole.interaction_preferences || 'N/A'}</td></tr>
                                    </table>
                                </div>
                                ${aiRole.typical_questions ? `
                                <div class="mt-2">
                                    <strong>ÂÖ∏ÂûãÈóÆÈ¢ò:</strong>
                                    <ul class="list-unstyled small">
                                        ${aiRole.typical_questions.slice(0, 3).map(q => `<li>‚Ä¢ ${q}</li>`).join('')}
                                    </ul>
                                </div>
                                ` : ''}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info"><i class="fas fa-bullseye"></i> Ê†∏ÂøÉÈúÄÊ±ÇÂàÜÊûê</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <tr><td><strong>Ê†∏ÂøÉÂäüËÉΩ:</strong></td><td>${requirements.core_functions ? requirements.core_functions.join(', ') : 'N/A'}</td></tr>
                                        <tr><td><strong>Ë¥®ÈáèÊúüÊúõ:</strong></td><td>${requirements.quality_expectations ? requirements.quality_expectations.join(', ') : 'N/A'}</td></tr>
                                        <tr><td><strong>‰∫§‰∫íÂÅèÂ•Ω:</strong></td><td>${requirements.interaction_preferences ? requirements.interaction_preferences.join(', ') : 'N/A'}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Pain Points and Quality Expectations -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-danger"><i class="fas fa-exclamation-triangle"></i> ‰∏ªË¶ÅÁóõÁÇπ</h6>
                                <ul class="list-group list-group-flush">
                                    ${display.pain_points && display.pain_points.length > 0 ?
                    display.pain_points.map(point => `<li class="list-group-item px-0">${point}</li>`).join('') :
                    '<li class="list-group-item px-0">ÊöÇÊó†ËÆ∞ÂΩïÁöÑÁóõÁÇπ</li>'}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info"><i class="fas fa-star"></i> Ë¥®ÈáèÊúüÊúõ</h6>
                                <ul class="list-group list-group-flush">
                                    ${display.quality_expectations && display.quality_expectations.length > 0 ?
                    display.quality_expectations.map(exp => `<li class="list-group-item px-0">${exp}</li>`).join('') :
                    (requirements.quality_expectations && requirements.quality_expectations.length > 0 ?
                        requirements.quality_expectations.map(exp => `<li class="list-group-item px-0">${exp}</li>`).join('') :
                        '<li class="list-group-item px-0">ÊöÇÊó†ËÆ∞ÂΩïÁöÑÊúüÊúõ</li>')}
                                </ul>
                            </div>
                        </div>

                        <!-- Core Functions Display -->
                        ${(display.core_functions && display.core_functions.length > 0) || (requirements.core_functions && requirements.core_functions.length > 0) ? `
                        <div class="mb-4">
                            <h6 class="text-warning"><i class="fas fa-cogs"></i> Ê†∏ÂøÉÂäüËÉΩÈúÄÊ±Ç</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${(display.core_functions || requirements.core_functions || []).map(func => `<span class="badge bg-warning">${func}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Comprehensive Analysis if available -->
                        ${Object.keys(comprehensiveAnalysis).length > 0 ? `
                        <div class="mb-4">
                            <h6 class="text-secondary"><i class="fas fa-search"></i> ÁªºÂêàÂàÜÊûê</h6>
                            <div class="bg-light p-3 rounded">
                                <pre class="mb-0 small text-wrap">${JSON.stringify(comprehensiveAnalysis, null, 2)}</pre>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Extraction Method and Metadata -->
                        <div class="mt-4">
                            <div class="alert alert-success">
                                <i class="fas fa-robot"></i>
                                <strong>ÊèêÂèñ‰ø°ÊÅØ:</strong>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <strong>ÊèêÂèñÊñπÂºè:</strong> ${display.extraction_method || 'DeepSeekÊô∫ËÉΩÂàÜÊûê'}<br>
                                        <strong>ÊñáÊ°£ÈïøÂ∫¶:</strong> ${display.document_length || 'N/A'} Â≠óÁ¨¶
                                    </div>
                                    <div class="col-md-6">
                                        <strong>ÂàÜÊûêÊó∂Èó¥:</strong> ${userPersonaInfo.extraction_timestamp || 'N/A'}<br>
                                        <strong>Êï∞ÊçÆÂÆåÊï¥ÊÄß:</strong> <span class="badge bg-success">ÂÆåÊï¥</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate comprehensive conversation records section with all analysis details
        function generateConversationRecordsSection(records) {
            if (!records || records.length === 0) {
                return `
                    <div class="collapsible-card mb-4">
                        <div class="collapsible-header" onclick="toggleCollapsible('conversation-records')">
                            <div class="collapsible-title">
                                <i class="fas fa-comments"></i>
                                üí¨ ËØ¶ÁªÜÂØπËØùËÆ∞ÂΩï‰∏éËØÑ‰º∞ÂàÜÊûê <span class="badge bg-warning">ÊöÇÊó†Êï∞ÊçÆ</span>
                            </div>
                            <i class="fas fa-chevron-down collapsible-toggle" id="conversation-records-toggle"></i>
                        </div>
                        <div class="collapsible-content collapsed" id="conversation-records">
                            <div class="alert alert-info">ÊöÇÊó†ÂØπËØùËÆ∞ÂΩï</div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="collapsible-card mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('conversation-records')">
                        <div class="collapsible-title">
                            <i class="fas fa-comments"></i>
                            üí¨ ËØ¶ÁªÜÂØπËØùËÆ∞ÂΩï‰∏éËØÑ‰º∞ÂàÜÊûê <span class="badge bg-success">${records.length} ‰∏™Âú∫ÊôØ</span>
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="conversation-records-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="conversation-records">
                        ${records.map((record, index) => generateSingleConversationRecord(record, index)).join('')}
                    </div>
                </div>
            `;
        }

        // Generate detailed single conversation record with improved JSON parsing
        function generateSingleConversationRecord(record, index) {
            const scenario = record.scenario || {};
            const history = record.conversation_history || [];
            const evaluationScores = record.evaluation_scores || {};
            const detailedExplanations = record.detailed_explanations || {};
            const scenarioScore = record.scenario_score_100 || (record.scenario_score * 20) || 0;

            return `
                <div class="conversation-record-card mb-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-comment-dots"></i>
                                Âú∫ÊôØ ${index + 1}: ${scenario.title || 'Êú™ÂëΩÂêçÂú∫ÊôØ'}
                                <span class="badge bg-light text-dark ms-2">${scenarioScore.toFixed(1)}/100</span>
                                <span class="badge bg-secondary">${getScoreGrade(scenarioScore)}</span>
                            </h5>
                        </div>
                        
                        <!-- Scenario Information -->
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-info-circle"></i> Âú∫ÊôØ‰ø°ÊÅØ</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Âú∫ÊôØÊ†áÈ¢ò:</strong></td><td>${scenario.title || 'Êú™ÂëΩÂêç'}</td></tr>
                                        <tr><td><strong>Âú∫ÊôØÊèèËø∞:</strong></td><td>${scenario.description || scenario.context || 'Êó†ÊèèËø∞'}</td></tr>
                                        <tr><td><strong>ÂØπËØùËΩÆÊ¨°:</strong></td><td>${history.length} ËΩÆ</td></tr>
                                        <tr><td><strong>Áî®Êà∑ÁîªÂÉè:</strong></td><td>${scenario.user_profile || 'Âü∫‰∫éËá™Âä®ÊèêÂèñ'}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success"><i class="fas fa-chart-line"></i> Âú∫ÊôØÂæóÂàÜÊ¶ÇËßà</h6>
                                    <div class="scenario-score-overview">
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span>Âú∫ÊôØÊÄªÂàÜ</span>
                                                <span class="badge bg-primary">${scenarioScore.toFixed(1)}/100</span>
                                            </div>
                                            <div class="progress mt-1" style="height: 10px;">
                                                <div class="progress-bar bg-primary" style="width: ${scenarioScore}%"></div>
                                            </div>
                                        </div>
                                        ${Object.entries(evaluationScores).map(([dim, scoreValue]) => {
                const score = parseFloat(scoreValue);
                const labels = {
                    'fuzzy_understanding': 'Ê®°Á≥äÁêÜËß£',
                    'answer_correctness': 'ÂõûÁ≠îÂáÜÁ°ÆÊÄß',
                    'persona_alignment': 'Áî®Êà∑ÂåπÈÖç',
                    'goal_alignment': 'ÁõÆÊ†áÂØπÈΩê'
                };
                const color = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
                return `
                                                <div class="mb-1">
                                                    <div class="d-flex justify-content-between">
                                                        <small>${labels[dim] || dim}</small>
                                                        <span class="badge bg-${color}">${score.toFixed(1)}</span>
                                                    </div>
                                                </div>
                                            `;
            }).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- Complete Conversation History - Collapsible -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-primary mb-0"><i class="fas fa-history"></i> ÂÆåÊï¥ÂØπËØùÂéÜÂè≤</h6>
                                    <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleSection('conversation-history-${index}')">
                                        <i class="fas fa-chevron-down" id="conversation-history-${index}-icon"></i> Â±ïÂºÄ/Êî∂Ëµ∑
                                    </button>
                                </div>
                                <div id="conversation-history-${index}" class="conversation-history collapse" style="display: none;">
                                    ${history.map((turn, turnIndex) => `
                                        <div class="conversation-turn-complete mb-3 border rounded p-3 bg-light">
                                            <div class="turn-header mb-2">
                                                <span class="badge bg-info">Á¨¨ ${turn.turn || turnIndex + 1} ËΩÆ</span>
                                                ${turn.timestamp ? `<small class="text-muted ms-2">${turn.timestamp}</small>` : ''}
                                                ${turn.conversation_id ? `<small class="text-muted ms-2">‰ºöËØùID: ${turn.conversation_id.substring(0, 8)}...</small>` : ''}
                                            </div>
                                            
                                            <div class="user-message-complete mb-2">
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-user text-primary me-2 mt-1"></i>
                                                    <div class="flex-grow-1">
                                                        <div class="fw-bold mb-1">Áî®Êà∑Ê∂àÊÅØ</div>
                                                        <div class="bg-white p-2 rounded border">
                                                            <div class="mb-1"><strong>ÂéüÂßãÊ∂àÊÅØ:</strong></div>
                                                            <div class="text-wrap">${turn.user_message || 'N/A'}</div>
                                                            ${turn.enhanced_message ? `<div class="mt-2"><strong>Â¢ûÂº∫Ê∂àÊÅØ:</strong></div><div class="text-wrap">${turn.enhanced_message}</div>` : ''}
                                                            <small class="text-muted">Ê∂àÊÅØÈïøÂ∫¶: ${(turn.user_message || '').length} Â≠óÁ¨¶</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="ai-response-complete">
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-robot text-success me-2 mt-1"></i>
                                                    <div class="flex-grow-1">
                                                        <div class="fw-bold mb-1">AIÂõûÂ§ç</div>
                                                        <div class="bg-white p-2 rounded border">
                                                            <div class="text-wrap">${cleanAiResponse(turn.ai_response || turn.ai_message || 'N/A')}</div>
                                                            <small class="text-muted">ÂõûÂ§çÈïøÂ∫¶: ${turn.response_length || (turn.ai_response || '').length} Â≠óÁ¨¶</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Detailed Evaluation Analysis for Each Dimension - Nested Collapsible -->
                            <div class="evaluation-analysis-complete">
                                <h6 class="text-warning"><i class="fas fa-microscope"></i> ËØ¶ÁªÜËØÑ‰º∞ÂàÜÊûê (ÊâÄÊúâÁª¥Â∫¶)</h6>
                                                                ${Object.entries(evaluationScores).map(([dimension, scoreValue]) => {
                // Use the detailed_explanations object for rich content
                const detailedData = detailedExplanations[dimension] || {};
                console.log(`üîç Processing dimension ${dimension}:`, detailedData);

                const score = parseFloat(scoreValue);
                const detailedAnalysis = detailedData.detailed_analysis || "ÊöÇÊó†ËØ¶ÁªÜÂàÜÊûê";
                const specificQuotes = detailedData.specific_quotes || "ÊöÇÊó†ÂÖ∑‰ΩìÂºïÁî®";
                const improvementSuggestions = detailedData.improvement_suggestions || "ÊöÇÊó†ÊîπËøõÂª∫ËÆÆ";
                const comprehensiveEvaluation = detailedData.comprehensive_evaluation || "ÊöÇÊó†ÁªºÂêàËØÑ‰ª∑";
                const fullResponse = detailedData.full_response || "";

                const labels = {
                    'fuzzy_understanding': 'üîç Ê®°Á≥äÁêÜËß£‰∏éËøΩÈóÆËÉΩÂäõ',
                    'answer_correctness': '‚úÖ ÂõûÁ≠îÂáÜÁ°ÆÊÄß‰∏é‰∏ì‰∏öÊÄß',
                    'persona_alignment': 'üë• Áî®Êà∑ÂåπÈÖçÂ∫¶',
                    'goal_alignment': 'üéØ ÁõÆÊ†áÂØπÈΩêÂ∫¶'
                };

                const label = labels[dimension] || dimension;
                const scoreGrade = getScoreGrade(score);
                const scoreColor = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';

                return `
                                        <div class="dimension-analysis-card mb-4 border rounded">
                                            <div class="card-header bg-${scoreColor} text-white">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-0">
                                                            ${label}
                                                            <span class="badge bg-light text-dark ms-2">${score.toFixed(1)}/100</span>
                                                            <span class="badge bg-secondary">${scoreGrade}</span>
                                                        </h6>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-light" type="button" onclick="toggleSection('dimension-${index}-${dimension}')">
                                                        <i class="fas fa-chevron-down" id="dimension-${index}-${dimension}-icon"></i> ËØ¶ÁªÜÂàÜÊûê
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="dimension-${index}-${dimension}" class="card-body collapse" style="display: none;">
                                                <!-- Nested Collapsible Analysis Sections -->
                                                ${generateNestedAnalysisSection('detailed-analysis', 'ËØ¶ÁªÜÂàÜÊûê', 'fas fa-search', 'primary', detailedAnalysis, index, dimension)}
                                                ${generateNestedAnalysisSection('specific-quotes', 'ÂÖ∑‰ΩìÂºïÁî®', 'fas fa-quote-left', 'info', specificQuotes, index, dimension)}
                                                ${generateNestedAnalysisSection('improvement-suggestions', 'ÊîπËøõÂª∫ËÆÆ', 'fas fa-lightbulb', 'warning', improvementSuggestions, index, dimension)}
                                                ${comprehensiveEvaluation !== 'ÊöÇÊó†ÁªºÂêàËØÑ‰ª∑' ? generateNestedAnalysisSection('comprehensive-evaluation', 'ÁªºÂêàËØÑ‰ª∑', 'fas fa-star', 'success', comprehensiveEvaluation, index, dimension) : ''}
                                                ${fullResponse ? generateNestedAnalysisSection('full-response', 'ÂéüÂßãËØÑ‰º∞ÂõûÂ§ç', 'fas fa-file-alt', 'secondary', fullResponse, index, dimension, true) : ''}
                                            </div>
                                        </div>
                                    `;
            }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to generate nested analysis sections with enhanced content detection
        function generateNestedAnalysisSection(type, title, icon, color, content, index, dimension, isCode = false) {
            const sectionId = `${type}-${index}-${dimension}`;

            // Enhanced content processing
            let displayContent;
            let hasContent = false;

            if (content && content !== null && content !== '') {
                hasContent = true;
                if (isCode) {
                    displayContent = `<pre class="mb-0 small text-wrap">${escapeHtml(content)}</pre>`;
                } else {
                    displayContent = `<div class="text-wrap">${formatAnalysisText(content)}</div>`;
                }
            } else {
                displayContent = `<div class="text-muted"><i>ÊöÇÊó†${title}ÂÜÖÂÆπ</i></div>`;
            }

            // Add debug info
            console.log(`üìù Section ${type} for ${dimension}: hasContent=${hasContent}, content preview:`,
                content ? content.substring(0, 100) + '...' : 'null/empty');

            return `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-${color} mb-0">
                            <i class="${icon}"></i> ${title}
                            ${hasContent ? '<span class="badge bg-success ms-2">ÊúâÂÜÖÂÆπ</span>' : '<span class="badge bg-secondary ms-2">Êó†ÂÜÖÂÆπ</span>'}
                        </h6>
                        <button class="btn btn-sm btn-outline-${color}" type="button" onclick="toggleSection('${sectionId}')">
                            <i class="fas fa-chevron-down" id="${sectionId}-icon"></i> Â±ïÂºÄ/Êî∂Ëµ∑
                        </button>
                    </div>
                    <div id="${sectionId}" class="collapse" style="display: none;">
                        <div class="border-start border-${color} border-3 ps-3 bg-light p-3 rounded">
                            ${displayContent}
                        </div>
                    </div>
                </div>
            `;
        }

        // HTML escape function for safety
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Generate other sections for complete data display
        function generateContextDisplaySection(contextDisplay) {
            if (!contextDisplay || Object.keys(contextDisplay).length === 0) return '';

            return `
                <div class="collapsible-card mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('context-display')">
                        <div class="collapsible-title">
                            <i class="fas fa-info-circle"></i>
                            üìÑ ËØÑ‰º∞‰∏ä‰∏ãÊñá‰∏éÊäÄÊúØËØ¶ÊÉÖ
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="context-display-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="context-display">
                        ${contextDisplay.requirement_document_summary ? `
                        <div class="mb-3">
                            <h6 class="text-primary"><i class="fas fa-file-text"></i> ÈúÄÊ±ÇÊñáÊ°£ÊëòË¶Å</h6>
                            <div class="bg-light p-3 rounded">
                                <strong>ÂÜÖÂÆπÈ¢ÑËßà:</strong> ${contextDisplay.requirement_document_summary.content_preview || 'N/A'}<br>
                                <strong>ÂàÜÊûêÂü∫Á°Ä:</strong> ${contextDisplay.requirement_document_summary.analysis_basis || 'N/A'}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${contextDisplay.technical_details ? `
                        <div class="mb-3">
                            <h6 class="text-success"><i class="fas fa-cog"></i> ÊäÄÊúØÂÆûÁé∞ËØ¶ÊÉÖ</h6>
                            <table class="table table-sm">
                                <tr><td><strong>APIÁ±ªÂûã:</strong></td><td>${contextDisplay.technical_details.api_type || 'N/A'}</td></tr>
                                <tr><td><strong>ÂØπËØùËΩÆÊ¨°:</strong></td><td>${contextDisplay.technical_details.conversation_turns || 'N/A'}</td></tr>
                                <tr><td><strong>ËØÑ‰º∞Áª¥Â∫¶:</strong></td><td>${contextDisplay.technical_details.evaluation_dimensions || 'N/A'}</td></tr>
                            </table>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function generatePersonaAlignmentSection(data) {
            const alignment = data.persona_alignment_analysis;
            if (!alignment) return '';

            return `
                <div class="collapsible-card mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('persona-alignment')">
                        <div class="collapsible-title">
                            <i class="fas fa-user-check"></i>
                            üé≠ Áî®Êà∑ÁîªÂÉèÂåπÈÖçÂ∫¶ÂàÜÊûê
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="persona-alignment-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="persona-alignment">
                        <div class="bg-light p-3 rounded">
                            ${formatAnalysisText(alignment)}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateBusinessGoalSection(data) {
            const goal = data.business_goal_achievement;
            if (!goal) return '';

            return `
                <div class="collapsible-card mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('business-goal')">
                        <div class="collapsible-title">
                            <i class="fas fa-bullseye"></i>
                            üéØ ‰∏öÂä°ÁõÆÊ†áËææÊàêÂ∫¶ÂàÜÊûê
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="business-goal-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="business-goal">
                        <div class="bg-light p-3 rounded">
                            ${formatAnalysisText(goal)}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateTechnicalDetailsSection(data) {
            return `
                <div class="collapsible-card mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('technical-details')">
                        <div class="collapsible-title">
                            <i class="fas fa-server"></i>
                            ‚öôÔ∏è Á≥ªÁªüÊäÄÊúØ‰ø°ÊÅØ‰∏é‰∏ãËΩΩÂäüËÉΩ
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="technical-details-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="technical-details">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-info"><i class="fas fa-info-circle"></i> ËØÑ‰º∞Á≥ªÁªü‰ø°ÊÅØ</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>ËØÑ‰º∞Ê®°Âºè:</strong></td><td><span class="badge bg-primary">${data.evaluation_mode || 'unknown'}</span></td></tr>
                                    <tr><td><strong>Êó∂Èó¥Êà≥:</strong></td><td>${data.timestamp || 'Êú™ËÆ∞ÂΩï'}</td></tr>
                                    <tr><td><strong>Êï∞ÊçÆÁâàÊú¨:</strong></td><td>v${data.version || '1.0'}</td></tr>
                                    <tr><td><strong>Âπ≥Âè∞ÁâàÊú¨:</strong></td><td>AIËØÑ‰º∞Âπ≥Âè∞ v4.1</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-warning"><i class="fas fa-download"></i> Êä•Âëä‰∏ãËΩΩÈÄâÈ°π</h6>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="includeTranscript" checked>
                                        <label class="form-check-label" for="includeTranscript">
                                            ÂåÖÂê´ÂÆåÊï¥ÂØπËØùËÆ∞ÂΩï
                                        </label>
                                    </div>
                                </div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="downloadReport('json')">
                                        <i class="fas fa-code"></i> JSON
                                    </button>
                                    <button type="button" class="btn btn-success btn-sm" onclick="downloadReport('txt')">
                                        <i class="fas fa-file-text"></i> TXT
                                    </button>
                                    <button type="button" class="btn btn-info btn-sm" onclick="downloadReport('docx')">
                                        <i class="fas fa-file-word"></i> DOCX
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateRawDataSection(data) {
            return `
                <div class="collapsible-card mb-4">
                    <div class="collapsible-header" onclick="toggleCollapsible('raw-data')">
                        <div class="collapsible-title">
                            <i class="fas fa-database"></i>
                            üîß ÂÆåÊï¥ÂéüÂßãJSONÊï∞ÊçÆ <span class="badge bg-warning">ÊäÄÊúØÁî®Êà∑‰∏ìÁî®</span>
                        </div>
                        <i class="fas fa-chevron-down collapsible-toggle" id="raw-data-toggle"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="raw-data">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>ËØ¥Êòé:</strong> Ê≠§Â§Ñ‰∏∫ÂÆåÊï¥ÁöÑÂéüÂßãJSONÊï∞ÊçÆÔºåÂåÖÂê´‰∫Ü‰∏äËø∞ÊâÄÊúâ‰ø°ÊÅØÁöÑÊäÄÊúØÊ†ºÂºè„ÄÇ‰∏ªË¶ÅÁî®‰∫éÂºÄÂèëÈõÜÊàê„ÄÅÊï∞ÊçÆÂàÜÊûêÊàñÂ§á‰ªΩÁî®ÈÄî„ÄÇ
                        </div>
                        <pre class="bg-dark text-light p-3 rounded small overflow-auto" style="max-height: 600px;"><code>${JSON.stringify(data, null, 2)}</code></pre>
                    </div>
                </div>
            `;
        }

        function toggleCollapsible(element) {
            // Handle both element and sectionId parameters
            let content = null;
            let toggle = null;

            if (typeof element === 'string') {
                // Direct sectionId passed
                content = document.getElementById(element);
                toggle = document.getElementById(element + '-toggle');
            } else if (element && element.tagName) {
                // DOM element passed - find the next collapsible-content sibling
                let currentElement = element;

                // If clicked element is inside the header, find the header
                while (currentElement && !currentElement.classList.contains('collapsible-header')) {
                    currentElement = currentElement.parentElement;
                }

                if (currentElement && currentElement.classList.contains('collapsible-header')) {
                    // Find the collapsible-content sibling
                    content = currentElement.nextElementSibling;
                    while (content && !content.classList.contains('collapsible-content')) {
                        content = content.nextElementSibling;
                    }

                    // Find the toggle icon within the header
                    toggle = currentElement.querySelector('.collapsible-toggle');
                }
            }

            // Add null checks to prevent TypeError
            if (!content) {
                console.warn('‚ö†Ô∏è toggleCollapsible: content element not found for', element);
                return;
            }

            // Toggle the content visibility
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                if (toggle) toggle.classList.add('rotated');
            } else {
                content.classList.add('collapsed');
                if (toggle) toggle.classList.remove('rotated');
            }
        }

        // Browser-compatible timeout signal creation
        function createTimeoutSignal(timeoutMs) {
            const controller = new AbortController();
            setTimeout(() => {
                controller.abort();
            }, timeoutMs);
            return controller.signal;
        }

        // Validate API headers input to prevent common user errors
        function validateApiHeaders() {
            const apiHeadersField = document.getElementById('apiHeaders');
            const value = apiHeadersField.value.trim();

            if (!value) return; // Empty is okay

            try {
                const parsed = JSON.parse(value);

                // Check if user pasted full config instead of just headers
                if (parsed && typeof parsed === 'object') {
                    const suspiciousKeys = ['type', 'url', 'method', 'timeout', 'agentId', 'botId'];
                    const foundSuspicious = suspiciousKeys.filter(key => key in parsed);

                    if (foundSuspicious.length > 0) {
                        showHeadersWarning(`Ê£ÄÊµãÂà∞ÈÖçÁΩÆÂ≠óÊÆµ "${foundSuspicious.join(', ')}"ÔºåËØ∑Âè™Â°´ÂÜôËØ∑Ê±ÇÂ§¥‰ø°ÊÅØÔºÅ`);
                        return false;
                    }
                }

                // Clear any previous warnings
                clearHeadersWarning();
                return true;
            } catch (e) {
                showHeadersWarning('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑJSONÊ†ºÂºè');
                return false;
            }
        }

        // Handle paste events to detect full config paste
        function handleHeadersPaste(event) {
            setTimeout(() => {
                const apiHeadersField = document.getElementById('apiHeaders');
                const value = apiHeadersField.value.trim();

                // Check if pasted content looks like a full config
                if (value.includes('"type"') && value.includes('"url"') && value.includes('"method"')) {
                    showHeadersWarning('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂÆåÊï¥ÈÖçÁΩÆÔºÅËØ∑ÂàÜÂà´Â°´ÂÜôÂêÑ‰∏™Â≠óÊÆµÔºå‰∏çË¶ÅÂú®Ê≠§Â§ÑÁ≤òË¥¥ÂÆåÊï¥ÈÖçÁΩÆ„ÄÇ');

                    // Try to extract just the headers part
                    try {
                        const parsed = JSON.parse(value);
                        if (parsed.headers && typeof parsed.headers === 'object') {
                            apiHeadersField.value = JSON.stringify(parsed.headers, null, 2);
                            showHeadersWarning('‚úÖ Â∑≤Ëá™Âä®ÊèêÂèñËØ∑Ê±ÇÂ§¥ÈÉ®ÂàÜÔºåËØ∑Ê£ÄÊü•Âπ∂Á°ÆËÆ§ÂÜÖÂÆπÊ≠£Á°Æ„ÄÇ');
                        } else {
                            apiHeadersField.value = '{"Authorization": "Bearer your-token"}';
                            showHeadersWarning('‚ùå Êó†Ê≥ïÊèêÂèñËØ∑Ê±ÇÂ§¥ÔºåÂ∑≤ÈáçÁΩÆ‰∏∫Á§∫‰æãÊ†ºÂºèÔºåËØ∑ÈáçÊñ∞Â°´ÂÜô„ÄÇ');
                        }
                    } catch (e) {
                        apiHeadersField.value = '{"Authorization": "Bearer your-token"}';
                        showHeadersWarning('‚ùå Á≤òË¥¥ÂÜÖÂÆπÊ†ºÂºèÈîôËØØÔºåÂ∑≤ÈáçÁΩÆ‰∏∫Á§∫‰æãÊ†ºÂºèÔºåËØ∑ÈáçÊñ∞Â°´ÂÜô„ÄÇ');
                    }
                }
            }, 100); // Small delay to allow paste to complete
        }

        // Show warning message for headers field
        function showHeadersWarning(message) {
            const apiHeadersField = document.getElementById('apiHeaders');
            let warningDiv = document.getElementById('headers-warning');

            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'headers-warning';
                warningDiv.className = 'alert alert-warning mt-2 mb-0';
                apiHeadersField.parentNode.appendChild(warningDiv);
            }

            warningDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            warningDiv.style.display = 'block';
        }

        // Clear warning message for headers field
        function clearHeadersWarning() {
            const warningDiv = document.getElementById('headers-warning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        }

        // New function for toggling sections with display:none/block
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');

            if (!content || !icon) return;

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function cleanAiResponse(response) {
            if (!response) return 'ÊöÇÊó†ÂõûÂ§ç';

            // Handle JSON formatted responses
            if (response.includes('"tool_output_content"')) {
                try {
                    const match = response.match(/"tool_output_content":\s*"([^"]+)"/);
                    if (match && match[1]) {
                        let content = match[1].replace(/\\n/g, ' ').replace(/\\/g, '');
                        // Extract answer part if exists
                        if (content.includes('Á≠îÊ°àÔºö')) {
                            content = content.split('Á≠îÊ°àÔºö')[1];
                        }
                        return content.trim();
                    }
                } catch (e) {
                    // Fall through to default handling
                }
            }

            // Handle stream plugin finish format
            if (response.includes('"msg_type":"stream_plugin_finish"')) {
                try {
                    // Extract meaningful content using regex
                    const answerMatch = response.match(/Á≠îÊ°àÔºö([^"\\]+)/);
                    if (answerMatch && answerMatch[1]) {
                        return answerMatch[1].trim();
                    }
                } catch (e) {
                    // Fall through to default handling
                }
            }

            // Return cleaned response
            return response.replace(/\\n/g, ' ').replace(/\\/g, '').trim();
        }

        function displayResults(data) {
            // Store evaluation data for download functionality
            currentEvaluationData = data;

            // Comprehensive JSON structure inspection for debugging
            console.log('üîç FULL JSON DATA INSPECTION:');
            console.log('üìä Complete data object:', data);
            console.log('üìù conversation_records:', data.conversation_records);

            if (data.conversation_records && data.conversation_records.length > 0) {
                console.log('üéØ First record structure:', data.conversation_records[0]);
                console.log('üìà First record evaluation_scores:', data.conversation_records[0].evaluation_scores);
                console.log('üìù First record detailed_explanations:', data.conversation_records[0].detailed_explanations);

                // Inspect each evaluation dimension
                const firstRecord = data.conversation_records[0];
                if (firstRecord.detailed_explanations) {
                    Object.keys(firstRecord.detailed_explanations).forEach(dimension => {
                        console.log(`üîç Detailed explanation for ${dimension}:`, firstRecord.detailed_explanations[dimension]);
                    });
                }
            }

            const resultsContainer = document.getElementById('resultsContent');
            const summary = data.evaluation_summary;
            const records = data.conversation_records || [];
            const evaluationMode = data.evaluation_mode || 'manual';
            const userPersonaInfo = data.user_persona_info;

            // Generate overall score visualization using 100-point scale with fine-grained precision
            const overallScore100 = parseFloat(summary.overall_score_100 || (summary.overall_score * 20) || 0);
            const starsHtml = generateStarRating(overallScore100);
            const overallGrade = getScoreGrade(overallScore100);
            const overallColor = overallScore100 >= 80 ? 'success' : overallScore100 >= 60 ? 'warning' : 'danger';

            // Generate comprehensive summary section
            const totalScenarios = summary.total_scenarios || records.length || 0;
            const totalConversations = summary.total_conversations || 0;
            const personaRole = userPersonaInfo?.user_persona?.role || '‰∏ì‰∏öÁî®Êà∑';
            const businessDomain = userPersonaInfo?.usage_context?.business_domain || '‰∏ì‰∏öÊúçÂä°';

            const summarySection = `
                <div class="summary-overview mb-4">
                    <div class="card border-${overallColor}">
                        <div class="card-header bg-${overallColor} text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-chart-pie"></i> 
                                AI Agent ËØÑ‰º∞ÁªºÂêàÊä•Âëä
                                <span class="badge bg-light text-dark ms-2">${overallScore100.toFixed(1)}/100</span>
                                <span class="badge bg-secondary">${overallGrade}</span>
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="stat-card text-center p-3 bg-light rounded">
                                        <div class="h3 text-primary mb-1">${totalScenarios}</div>
                                        <div class="small text-muted">ËØÑ‰º∞Âú∫ÊôØ</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card text-center p-3 bg-light rounded">
                                        <div class="h3 text-info mb-1">${totalConversations}</div>
                                        <div class="small text-muted">ÂØπËØùËΩÆÊ¨°</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card text-center p-3 bg-light rounded">
                                        <div class="h3 text-warning mb-1">4</div>
                                        <div class="small text-muted">ËØÑ‰º∞Áª¥Â∫¶</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card text-center p-3 bg-light rounded">
                                        <div class="h3 text-${overallColor} mb-1">${overallScore100.toFixed(0)}</div>
                                        <div class="small text-muted">ÁªºÂêàÂæóÂàÜ</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-section">
                                        <h6><i class="fas fa-user-tie"></i> Áî®Êà∑ÁîªÂÉèÂåπÈÖç</h6>
                                        <div class="small mb-2">
                                            <span class="badge bg-primary">${personaRole}</span>
                                            <span class="badge bg-info">${businessDomain}</span>
                                        </div>
                                        <p class="small text-muted">Âü∫‰∫éÊèêÂèñÁöÑÁî®Êà∑ÁîªÂÉèËøõË°å‰∏™ÊÄßÂåñËØÑ‰º∞ÔºåÁ°Æ‰øùÊµãËØïÂú∫ÊôØË¥¥ÂêàÂÆûÈôÖ‰∏öÂä°ÈúÄÊ±Ç</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-section">
                                        <h6><i class="fas fa-bullseye"></i> ‰∏öÂä°ÁõÆÊ†áËææÊàê</h6>
                                        <p class="small text-muted">ÂÆåÊàêÂ§öÁª¥Â∫¶Âä®ÊÄÅÂØπËØùËØÑ‰º∞ÔºåË¶ÜÁõñÊ®°Á≥äÁêÜËß£„ÄÅÂõûÁ≠îÂáÜÁ°ÆÊÄß„ÄÅÁî®Êà∑ÂåπÈÖçÂ∫¶ÂíåÁõÆÊ†áÂØπÈΩêÂ∫¶Âõõ‰∏™Ê†∏ÂøÉÁª¥Â∫¶</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Generate dimensions cards using fine-grained 100-point scale
            const dimensions = summary.dimension_scores_100 || summary.dimension_scores || {};
            const dimensionCards = Object.entries(dimensions).map(([key, value]) => {
                const labels = {
                    'fuzzy_understanding': 'üîç Ê®°Á≥äÁêÜËß£‰∏éËøΩÈóÆËÉΩÂäõ',
                    'answer_correctness': '‚úÖ ÂõûÁ≠îÂáÜÁ°ÆÊÄß‰∏é‰∏ì‰∏öÊÄß',
                    'persona_alignment': 'üë• Áî®Êà∑ÂåπÈÖçÂ∫¶',
                    'goal_alignment': 'üéØ ÁõÆÊ†áÂØπÈΩêÂ∫¶'
                };

                const label = labels[key] || key;
                // Convert to 100-point scale if needed and ensure precision
                const score100 = parseFloat(value <= 5 ? value * 20 : value);
                const scoreGrade = getScoreGrade(score100);
                const color = score100 >= 80 ? 'success' : score100 >= 60 ? 'warning' : 'danger';
                const stars = generateStarRating(score100);

                return `
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card border-${color} h-100">
                            <div class="card-body text-center">
                                <h6 class="card-title text-${color}">${label}</h6>
                                <div class="h2 text-${color} mb-2">${score100.toFixed(1)}</div>
                                <div class="small text-muted mb-2">/ 100</div>
                                <div class="star-rating mb-2">${stars}</div>
                                <span class="badge bg-${color}">${scoreGrade}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Generate streamlined JSON sections for technical users only 
            const jsonSections = `
                <div class="mb-4">
                    <h5><i class="fas fa-database"></i> ÊäÄÊúØÊï∞ÊçÆÂØºÂá∫ <small class="text-muted">(JSONÊ†ºÂºèÔºå‰æõÈ´òÁ∫ßÁî®Êà∑ÂíåÁ≥ªÁªüÈõÜÊàê‰ΩøÁî®)</small></h5>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>ÊèêÁ§∫Ôºö</strong>ÊâÄÊúâËØÑ‰º∞ÂàÜÊûêÂÜÖÂÆπÂ∑≤Âú®‰∏äÊñπËØ¶ÁªÜÂ±ïÁ§∫„ÄÇÊ≠§Â§Ñ‰∏∫ÂéüÂßãJSONÊï∞ÊçÆÔºå‰∏ªË¶ÅÁî®‰∫éÊäÄÊúØÈõÜÊàêÂíåÊï∞ÊçÆÂØºÂá∫„ÄÇ
                    </div>
                    ${generateJsonSection(data.evaluation_summary, "üìä ËØÑ‰º∞ÊÄªÁªìÊï∞ÊçÆ", "json-summary")}
                    ${data.user_persona_info ? generateJsonSection(data.user_persona_info, "üë§ Áî®Êà∑ÁîªÂÉèÊï∞ÊçÆ", "json-persona") : ''}
                    <div class="collapsible-card mb-3">
                        <div class="collapsible-header" onclick="toggleCollapsible('json-raw')">
                            <div class="collapsible-title">
                                <i class="fas fa-code"></i>
                                üîß ÂÆåÊï¥ÂéüÂßãÊï∞ÊçÆ <span class="badge bg-warning">ÊäÄÊúØÁî®Êà∑‰∏ìÁî®</span>
                            </div>
                            <i class="fas fa-chevron-down collapsible-toggle" id="json-raw-toggle"></i>
                        </div>
                        <div class="collapsible-content collapsed" id="json-raw">
                            <pre class="bg-dark text-light p-3 rounded small overflow-auto" style="max-height: 500px;"><code>${JSON.stringify(data, null, 2)}</code></pre>
                        </div>
                    </div>
                </div>
            `;

            // Generate simplified conversation records using complete data display
            const conversationHtml = records.map((record, index) => {
                const scenario = record.scenario || {};
                const history = record.conversation_history || [];
                const scenarioScore100 = parseFloat(record.scenario_score_100 || (record.scenario_score * 20) || 0);
                const scoreGrade = getScoreGrade(scenarioScore100);

                return `
                    <div class="conversation-section">
                        <div class="conversation-header" onclick="toggleConversation('conversation-${index}')">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-comment-dots"></i> ${scenario.title || `Âú∫ÊôØ ${index + 1}`}</h6>
                                <small class="text-muted">${history.length} ËΩÆÂØπËØù ‚Ä¢ ÂæóÂàÜ: ${scenarioScore100.toFixed(1)}/100 (${scoreGrade})</small>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="conversation-${index}" class="conversation-content" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>ÂÆåÊï¥ËØ¶ÁªÜÂàÜÊûê:</strong> ËØ∑Êü•Áúã‰∏äÊñπÁöÑ"üí¨ ËØ¶ÁªÜÂØπËØùËÆ∞ÂΩï‰∏éËØÑ‰º∞ÂàÜÊûê"ÈÉ®ÂàÜÔºåÂåÖÂê´ÊâÄÊúâÁª¥Â∫¶ÁöÑÂÆåÊï¥ÂàÜÊûêÂÜÖÂÆπ„ÄÇ
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Generate persona display section if available
            let personaDisplayHtml = '';
            if (userPersonaInfo && userPersonaInfo.extracted_persona_summary) {
                const persona = userPersonaInfo.extracted_persona_summary.user_persona || {};
                const usage = userPersonaInfo.extracted_persona_summary.usage_context || {};

                personaDisplayHtml = `
                    <!-- User Persona Section -->
                    <div class="mb-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user-cog"></i> 
                                        ÊèêÂèñÁöÑÁî®Êà∑ÁîªÂÉè‰∏é‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                                    </h6>
                                    <button class="btn btn-sm btn-outline-light" type="button" 
                                            onclick="togglePersonaDetails()" id="personaToggleBtn">
                                        <i class="fas fa-chevron-down"></i> Êü•ÁúãËØ¶ÁªÜ
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Compact Summary -->
                            <div class="card-body pb-2">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Áî®Êà∑ËßíËâ≤Ôºö</strong><span class="text-primary">${persona.role || 'ÈÄöÁî®Áî®Êà∑'}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>‰∏öÂä°È¢ÜÂüüÔºö</strong><span class="text-info">${usage.business_domain || 'ÈÄöÁî®ÊúçÂä°'}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>ÁªèÈ™åÊ∞¥Âπ≥Ôºö</strong><span class="text-warning">${persona.experience_level || 'Ê†áÂáÜ'}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Ê≤üÈÄöÈ£éÊ†ºÔºö</strong><span class="text-secondary">${persona.communication_style || '‰∏ì‰∏öÊ≤üÈÄö'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Information (Collapsible) -->
                            <div id="personaDetailsContent" class="collapse">
                                <div class="card-body border-top">
                                    <div class="row">
                                        <!-- User Persona Details -->
                                        <div class="col-md-6">
                                            <h6 class="text-primary"><i class="fas fa-user"></i> Áî®Êà∑ÁîªÂÉèËØ¶ÊÉÖ</h6>
                                            <ul class="list-unstyled small">
                                                <li><strong>Â∑•‰ΩúÁéØÂ¢ÉÔºö</strong> ${persona.work_environment || 'Ê†áÂáÜÂäûÂÖ¨ÁéØÂ¢É'}</li>
                                                <li><strong>Â∑•‰ΩúÂéãÂäõÔºö</strong> ${persona.work_pressure || '‰∏≠Á≠âÂ∑•‰ΩúÂéãÂäõ'}</li>
                                                <li><strong>‰∏ì‰∏öÈ¢ÜÂüüÔºö</strong> ${persona.expertise_areas ? persona.expertise_areas.join(', ') : 'ÈÄöÁî®‰∏ì‰∏ö'}</li>
                                            </ul>
                                        </div>
                                        
                                        <!-- Usage Context -->
                                        <div class="col-md-6">
                                            <h6 class="text-info"><i class="fas fa-briefcase"></i> ‰ΩøÁî®Âú∫ÊôØ</h6>
                                            <ul class="list-unstyled small">
                                                <li><strong>‰∏ªË¶ÅÂú∫ÊôØÔºö</strong> ${usage.primary_scenarios ? usage.primary_scenarios.join(', ') : '‰∏ì‰∏öÂí®ËØ¢'}</li>
                                                <li><strong>‰∫§‰∫íÁõÆÊ†áÔºö</strong> ${usage.interaction_goals ? usage.interaction_goals.slice(0, 3).join(', ') : 'Ëé∑ÂèñÂáÜÁ°Æ‰ø°ÊÅØ'}</li>
                                                <li><strong>‰ΩøÁî®Êó∂Êú∫Ôºö</strong> ${usage.usage_timing ? usage.usage_timing.join(', ') : 'Â∑•‰ΩúÊó∂Èó¥'}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="alert alert-light mb-0">
                                                <i class="fas fa-lightbulb text-warning"></i>
                                                <strong>Êô∫ËÉΩÂàÜÊûêÁªìÊûúÔºö</strong>Á≥ªÁªüÂü∫‰∫éÊ≠§Áî®Êà∑ÁîªÂÉèÁîüÊàêÈíàÂØπÊÄßÁöÑÂØπËØùÂú∫ÊôØÔºåÁ°Æ‰øùËØÑ‰º∞ÁªìÊûúÊõ¥Ë¥¥ÂêàÂÆûÈôÖ‰∏öÂä°ÈúÄÊ±Ç„ÄÇ
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            resultsContainer.innerHTML = `
                <!-- Comprehensive Complete Report - ALL DATA DISPLAY -->
                ${generateCompleteDataReport(data)}
            `;

            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function toggleConversation(conversationId) {
            const content = document.getElementById(conversationId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.fas');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function toggleExplanation(explanationId) {
            const element = document.getElementById(explanationId);
            if (element.style.display === 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }

        function togglePersonaDetails() {
            const content = document.getElementById('personaDetailsContent');
            const btn = document.getElementById('personaToggleBtn');
            const icon = btn.querySelector('.fas');

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                btn.innerHTML = '<i class="fas fa-chevron-down"></i> Êü•ÁúãËØ¶ÁªÜ';
            } else {
                content.classList.add('show');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                btn.innerHTML = '<i class="fas fa-chevron-up"></i> Êî∂Ëµ∑ËØ¶ÁªÜ';
            }
        }

        async function downloadReport(format) {
            if (!currentEvaluationData) {
                alert('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑËØÑ‰º∞ÁªìÊûú');
                return;
            }

            try {
                console.log(`ÂºÄÂßã‰∏ãËΩΩ ${format} Ê†ºÂºèÊä•Âëä...`);

                // Get include transcript option
                const includeTranscript = document.getElementById('includeTranscript').checked;

                // Prepare form data
                const formData = new FormData();
                formData.append('evaluation_data', JSON.stringify(currentEvaluationData));
                formData.append('format', format);
                formData.append('include_transcript', includeTranscript);

                // Show loading indication
                const originalButtons = document.querySelectorAll('.btn-group button');
                originalButtons.forEach(btn => btn.disabled = true);

                // Make request to download endpoint
                const response = await fetch('/api/download-report', {
                    method: 'POST',
                    body: formData,
                    signal: createTimeoutSignal(120000)  // 2 minutes timeout for download
                });

                if (!response.ok) {
                    throw new Error(`‰∏ãËΩΩÂ§±Ë¥•: ${response.status} ${response.statusText}`);
                }

                // Handle different response types
                if (format === 'json') {
                    // For JSON, we get a JSON response
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    downloadBlob(blob, `evaluation_report_${getCurrentTimestamp()}.json`);
                } else {
                    // For TXT and DOCX, we get file responses
                    const blob = await response.blob();
                    const filename = format === 'txt' ?
                        `evaluation_report_${getCurrentTimestamp()}.txt` :
                        `evaluation_report_${getCurrentTimestamp()}.docx`;
                    downloadBlob(blob, filename);
                }

                console.log(`‚úÖ ${format} Êä•Âëä‰∏ãËΩΩÊàêÂäü`);

            } catch (error) {
                console.error('‚ùå Download failed:', error);
                alert('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
            } finally {
                // Re-enable buttons
                const originalButtons = document.querySelectorAll('.btn-group button');
                originalButtons.forEach(btn => btn.disabled = false);
            }
        }

        function downloadBlob(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function getCurrentTimestamp() {
            const now = new Date();
            return now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
        }

        // Debug function to inspect data structure
        function inspectDataStructure() {
            if (!currentEvaluationData) {
                alert('Ê≤°ÊúâÂèØÊ£ÄÊü•ÁöÑËØÑ‰º∞Êï∞ÊçÆ');
                return;
            }

            // Create inspection modal or alert
            const inspectionResults = {
                hasConversationRecords: !!currentEvaluationData.conversation_records,
                recordsCount: currentEvaluationData.conversation_records?.length || 0,
                firstRecordKeys: currentEvaluationData.conversation_records?.[0] ? Object.keys(currentEvaluationData.conversation_records[0]) : [],
                evaluationScoreKeys: currentEvaluationData.conversation_records?.[0]?.evaluation_scores_with_explanations ?
                    Object.keys(currentEvaluationData.conversation_records[0].evaluation_scores_with_explanations) : [],
                sampleScoreData: currentEvaluationData.conversation_records?.[0]?.evaluation_scores_with_explanations?.fuzzy_understanding || null
            };

            console.log('üîç Êï∞ÊçÆÁªìÊûÑÊ£ÄÊü•ÁªìÊûú:', inspectionResults);
            console.log('üìä ÂÆåÊï¥Êï∞ÊçÆ:', currentEvaluationData);

            // Show alert with key findings
            alert(`Êï∞ÊçÆÁªìÊûÑÊ£ÄÊü•ÁªìÊûúÔºö
            
ÂØπËØùËÆ∞ÂΩï: ${inspectionResults.hasConversationRecords ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®'}
ËÆ∞ÂΩïÊï∞Èáè: ${inspectionResults.recordsCount}
Á¨¨‰∏ÄÊù°ËÆ∞ÂΩïÂåÖÂê´Â≠óÊÆµ: ${inspectionResults.firstRecordKeys.join(', ')}
ËØÑ‰º∞Áª¥Â∫¶: ${inspectionResults.evaluationScoreKeys.join(', ')}

ËØ¶ÁªÜ‰ø°ÊÅØËØ∑Êü•ÁúãÊµèËßàÂô®ÊéßÂà∂Âè∞ (F12)`);
        }
    </script>
</body>

</html>